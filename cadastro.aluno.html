<!doctype html>

<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - Gerenciar Usuários</title>
<style>
  :root{--bg:#fff;--accent:#bfeccb;--card:#f8f8f8;--dark:#222;--square-radius:4px;--secondary-color: #2196F3;}
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;padding:0}
  body{background:var(--bg);min-height:100vh;padding-top:80px}
  header{position:fixed;top:0;left:0;right:0;height:64px;background:#fff;display:flex;align-items:center;gap:16px;padding:0 20px;border-bottom:1px solid #eee;z-index:50}
  .logo{display:flex;align-items:center;gap:10px}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  .topbar{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  input[type="search"]{padding:10px;border-radius:6px;border:1px solid #ddd;width:320px}
  .btn{padding:10px 12px;border:0;border-radius:var(--square-radius);cursor:pointer;font-weight:700; transition: background 0.3s;}
  .btn:hover {opacity: 0.9;}
  .btn-primary{background:var(--accent)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
  .card{background:var(--card);padding:14px;border-radius:8px;position:relative}
  .card h4{margin-bottom:8px}
  .card .meta{font-size:13px;color:#555}
  .card .controls{position:absolute;top:10px;right:10px;display:flex;gap:6px}
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:120}
  .modal{background:#fff;padding:18px;border-radius:10px;min-width:320px;max-width:94%;position:relative}
  .modal .close{position:absolute;right:12px;top:10px;border:0;background:transparent;font-size:18px;cursor:pointer}
  label{display:block;margin-top:10px;font-size:13px}
  input[type="text"], input[type="date"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .danger{background:#ffdddd}

  /* Estilos para o Modal de Estatísticas */
  .stats-info div{margin-top:10px; padding:10px; border-radius:6px; font-weight:700; background: var(--card); border:1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
  .stats-info strong{display:block; font-weight:400; font-size:13px; color:#555;}
  .stats-info button.detail-btn {padding: 6px 10px; font-size: 13px; background: #2196F3; color: #fff;}
  .stats-info .spinner {border: 4px solid #f3f3f3;border-top: 4px solid var(--secondary-color);border-radius: 50%;width: 20px;height: 20px;animation: spin 2s linear infinite;margin: 5px auto;}
  @keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}

  /* Estilos para o Modal de Listagem (NOVO) */
  #listModal .modal {max-width: 500px; width: 94%;}
  #listSearch {margin: 10px 0;}
  #listResults {max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 6px;}
  .list-item {padding: 10px 0; border-bottom: 1px dashed #ddd; display: flex; justify-content: space-between;}
  .list-item:last-child {border-bottom: none;}
  .list-item .name {font-weight: 600;}
  .list-item .serial {font-size: 14px; color: #555;}

</style>
</head>
<body>
<header>
  <div class="logo">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect rx='6' width='36' height='36' fill='%23bfeccb'/><text x='50%' y='55%' font-size='16' text-anchor='middle' fill='%23000' font-family='Arial' font-weight='700'>A</text></svg>" alt="logo" style="height:36px">
    <h1>DomusFit - Recp.</h1>
  </div>
  <button id="infoBtn" class="btn">Informações</button>
</header>

<main class="wrap">
  <div class="topbar">
    <input id="search" type="search" placeholder="Buscar por nome ou número de série">
    <button id="createBtn" class="btn btn-primary">Criar Usuário</button>
  </div>

  <div class="grid" id="usersGrid">
    </div>
</main>

<div class="modal-back" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <button class="close" id="closeModal">✕</button>
    <h3 id="modalTitle">Criar Usuário</h3>
    <label>Nome</label>
    <input id="m_name" type="text" placeholder="Nome completo">
    <label>Número de Série</label>
    <input id="m_serial" type="text" placeholder="xxxxx" maxlength="5" disabled>
    <div class="row">
      <div>
        <label>Início (YYYY-MM-DD)</label>
        <input id="m_start" type="date">
      </div>
      <div>
        <label>Fim (YYYY-MM-DD)</label>
        <input id="m_end" type="date">
      </div>
    </div>
    <label>Plano (nome)</label>
    <input id="m_plan" type="text" placeholder="Ex: Mensal - Premium">
    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="saveUser" class="btn btn-primary">Salvar</button>
      <button id="toggleActive" class="btn">Ativar/Desativar</button>
      <button id="deleteUser" class="btn danger">Excluir</button>
    </div>
  </div>
</div>

<div class="modal-back" id="statsModalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <button class="close" id="closeStatsModal">✕</button>
    <h3>Estatísticas do Sistema</h3>
    <div id="statsContent" class="stats-info">
      <p style="text-align:center;">Carregando dados...</p>
      <div class="spinner"></div>
    </div>
  </div>
</div>

<div class="modal-back" id="listModalBack">
  <div class="modal" id="listModal" role="dialog" aria-modal="true">
    <button class="close" id="closeListModal">✕</button>
    <h3 id="listModalTitle">Lista de Alunos</h3>
    <input id="listSearch" type="search" placeholder="Pesquisar por nome ou NA..." style="width: 100%;">
    <div id="listResults">
      </div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey:"AIzaSyBPiznHCVkTAgx6m02bZB8b0FFaot9UkBU",
    authDomain:"prefeitura-de-joao-camara.firebaseapp.com",
    projectId:"prefeitura-de-joao-camara",
    storageBucket:"prefeitura-de-joao-camara.firebasestorage.app",
    messagingSenderId:"269299041577",
    appId:"1:269299041577:web:fd41b2939240e9eb476338",
    measurementId:"G-YT7NHR342J"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Elementos do Modal de Estatísticas
  const infoBtn = document.getElementById('infoBtn');
  const statsModalBack = document.getElementById('statsModalBack');
  const closeStatsModal = document.getElementById('closeStatsModal');
  const statsContent = document.getElementById('statsContent');

  // Elementos do Novo Modal de Lista
  const listModalBack = document.getElementById('listModalBack');
  const closeListModal = document.getElementById('closeListModal');
  const listModalTitle = document.getElementById('listModalTitle');
  const listSearch = document.getElementById('listSearch');
  const listResults = document.getElementById('listResults');

  let allUsers = {};
  let listData = []; // Cache para a lista atual sendo exibida

  // ... (Outras constantes de elementos aqui) ...
  const usersGrid = document.getElementById('usersGrid');
  const searchEl = document.getElementById('search');
  const createBtn = document.getElementById('createBtn');
  const modalBack = document.getElementById('modalBack');
  const closeModal = document.getElementById('closeModal');
  const modalTitle = document.getElementById('modalTitle');
  const m_name = document.getElementById('m_name');
  const m_serial = document.getElementById('m_serial');
  const m_start = document.getElementById('m_start');
  const m_end = document.getElementById('m_end');
  const m_plan = document.getElementById('m_plan');
  const saveUser = document.getElementById('saveUser');
  const toggleActive = document.getElementById('toggleActive');
  const deleteUser = document.getElementById('deleteUser');


  // ouvinte real em /users
  db.ref('users').on('value', snap=>{
    allUsers = snap.val() || {};
    renderGrid();
  });

  // Funções existentes (renderGrid, openModalFor, generateUniqueSerial, listeners...)
  
  function renderGrid(filter=''){
    usersGrid.innerHTML = '';
    const keys = Object.keys(allUsers).sort();
    keys.forEach(k=>{
      const u = allUsers[k];
      const display = (u.name || '') + ' ' + k;
      if(filter && !display.toLowerCase().includes(filter.toLowerCase())) return;
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="controls">
          <button data-serial="${k}" class="infoBtn">i</button>
        </div>
        <h4>${u.name || '—'}</h4>
        <div class="meta">Nº Série: ${k}</div>
        <div class="meta">Plano: ${u.planName || '—'}</div>
        <div class="meta">Início: ${u.startDate || '—'} Término: ${u.endDate || '—'}</div>
        <div style="margin-top:8px">
          <button data-serial="${k}" class="btn btn-primary openInfo">Info</button>
        </div>
      `;
      usersGrid.appendChild(card);
    });
    // bind info buttons
    document.querySelectorAll('.openInfo').forEach(b=>{
      b.addEventListener('click', ()=> openModalFor(b.dataset.serial));
    });
    document.querySelectorAll('.infoBtn').forEach(b=>{
      b.addEventListener('click', ()=> openModalFor(b.dataset.serial));
    });
  }

  searchEl.addEventListener('input', ()=> renderGrid(searchEl.value));

  // criar novo
  createBtn.addEventListener('click', ()=>{
    openModalFor(null); // novo
  });

  function openModalFor(serialKey){
    modalBack.style.display='flex';
    if(serialKey){
      modalTitle.textContent='Editar Usuário';
      const u = allUsers[serialKey] || {};
      m_name.value = u.name || '';
      m_serial.value = serialKey;
      m_start.value = u.startDate || '';
      m_end.value = u.endDate || '';
      m_plan.value = u.planName || '';
      saveUser.dataset.serial = serialKey;
      toggleActive.dataset.serial = serialKey;
      deleteUser.dataset.serial = serialKey;
      toggleActive.textContent = (u.active ? 'Desativar' : 'Ativar');
    } else {
      modalTitle.textContent='Criar Usuário';
      m_name.value=''; m_serial.value=''; m_start.value=''; m_end.value=''; m_plan.value='';
      saveUser.dataset.serial = '';
      toggleActive.dataset.serial = '';
      deleteUser.dataset.serial = '';
      toggleActive.textContent = 'Ativar';
      // Gera número de série
      generateUniqueSerial().then(serial => {
        m_serial.value = serial;
        m_serial.disabled = true;
      }).catch(error => {
        alert(error.message);
        m_serial.value = 'ERRO';
      });
    }
  }

  closeModal.addEventListener('click', ()=> modalBack.style.display='none');
  modalBack.addEventListener('click', (e)=>{ if(e.target===modalBack) modalBack.style.display='none'; });
  
  // gera número de série de 5 dígitos com verificação de unicidade
  async function generateUniqueSerial(){
    const maxAttempts = 20;
    for(let i=0;i<maxAttempts;i++){
      const n = Math.floor(Math.random()*90000)+10000; // garante 5 dígitos (10000-99999)
      const key = String(n);
      try{
        const snap = await db.ref('users/' + key).get();
        if(!snap.exists()) return key;
      }catch(err){
        console.error('Erro verificando serial', err);
        // se erro ao checar, ainda tentamos outros números
      }
    }
    throw new Error('Não foi possível gerar número de série único. Tente novamente.');
  }

  // ... (Outros listeners de botões: saveUser, toggleActive, deleteUser) ...

  saveUser.addEventListener('click', async ()=>{
    const name = m_name.value.trim();
    const serialExisting = saveUser.dataset.serial || '';
    const start = m_start.value || null;
    const end = m_end.value || null;
    const plan = m_plan.value.trim();
    if(!name){ alert('Preencha o nome.'); return; }
    
    const serialToUse = serialExisting || m_serial.value.trim();
    if(!serialToUse || serialToUse === 'ERRO'){ 
      alert('Não foi possível obter um número de série válido.'); 
      return; 
    }

    try{
      if(serialExisting){
        // editar existente
        const payload = {
          name,
          startDate: start,
          endDate: end,
          planName: plan,
          updatedAt: new Date().toISOString().slice(0,10),
        };
        await db.ref('users/' + serialExisting).update(payload);
        alert('Salvo com sucesso.');
        modalBack.style.display='none';
      } else {
        // criar novo
        const payload = {
          name,
          startDate: start,
          endDate: end,
          planName: plan,
          serialNumber: serialToUse,
          active: true,
          createdAt: new Date().toISOString().slice(0,10),
          updatedAt: new Date().toISOString().slice(0,10),
        };
        await db.ref('users/' + serialToUse).set(payload);
        alert('Salvo com sucesso. Nº Série: ' + serialToUse);
        modalBack.style.display='none';
      }
    }catch(err){
      console.error(err);
      alert('Erro ao salvar. Veja console.');
    }
  });

  toggleActive.addEventListener('click', async ()=>{
    const serial = toggleActive.dataset.serial || m_serial.value;
    if(!serial) { alert('Número de série não encontrado.'); return; }
    const cur = allUsers[serial] || {};
    const next = !cur.active;
    try{
      await db.ref('users/' + serial + '/active').set(next);
      alert('Usuário agora ' + (next ? 'ativo' : 'inativo') + '.');
      modalBack.style.display='none';
    }catch(err){ console.error(err); alert('Erro ao alterar.'); }
  });

  deleteUser.addEventListener('click', async ()=>{
    const serial = deleteUser.dataset.serial || m_serial.value;
    if(!serial){ alert('Número de série não encontrado.'); return; }
    if(!confirm('Excluir usuário ' + serial + '? Esta ação é irreversível.')) return;
    try{
      // Remove o usuário e os dados associados para limpeza.
      await db.ref('users/' + serial).remove();
      await db.ref('treinos/' + serial).remove(); 
      await db.ref('cardio/' + serial).remove();
      await db.ref('presencas/' + serial).remove(); 
      alert('Usuário excluído.');
      modalBack.style.display='none';
    }catch(err){ console.error(err); alert('Erro ao excluir.'); }
  });

  // NOVO: Função que renderiza a lista no modal
  function renderList(filter = '') {
    listResults.innerHTML = '';
    const filteredList = listData.filter(item => 
      (item.name && item.name.toLowerCase().includes(filter.toLowerCase())) || 
      (item.serial && item.serial.includes(filter))
    );

    if (filteredList.length === 0) {
      listResults.innerHTML = '<p style="text-align:center; padding: 20px;">Nenhum aluno encontrado.</p>';
      return;
    }

    filteredList.forEach(item => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <span class="name">${item.name || '—'}</span>
        <span class="serial">${item.serial}</span>
      `;
      listResults.appendChild(div);
    });
  }

  // NOVO: Funções de Listagem Específicas
  
  async function showTreinoList() {
    listModalTitle.textContent = "Alunos com Treinos Montados";
    listResults.innerHTML = '<p style="text-align:center;">Buscando dados...</p>';
    statsModalBack.style.display = 'none'; // Fecha o modal de estatísticas
    listModalBack.style.display = 'flex'; // Abre o modal de lista
    listSearch.value = ''; // Limpa a busca

    try {
      const treinosSnap = await db.ref('treinos').get();
      const allTreinos = treinosSnap.val() || {};
      listData = [];

      Object.keys(allTreinos).forEach(serial => {
        const treinosDoAluno = allTreinos[serial];
        if (Array.isArray(treinosDoAluno) && treinosDoAluno.length > 0 && allUsers[serial]) {
          listData.push({
            name: allUsers[serial].name,
            serial: serial
          });
        }
      });
      renderList();

    } catch(error) {
      listResults.innerHTML = `<p style="color:red; text-align:center;">Erro ao carregar lista de treinos: ${error.message}</p>`;
    }
  }

  async function showPresencaList() {
    listModalTitle.textContent = "Alunos que Usaram a Função Treino.html (Presença)";
    listResults.innerHTML = '<p style="text-align:center;">Buscando dados...</p>';
    statsModalBack.style.display = 'none'; // Fecha o modal de estatísticas
    listModalBack.style.display = 'flex'; // Abre o modal de lista
    listSearch.value = ''; // Limpa a busca

    try {
      const presencasSnap = await db.ref('presencas').get();
      const allPresencas = presencasSnap.val() || {};
      listData = [];

      Object.keys(allPresencas).forEach(serial => {
        const presencasDoAluno = allPresencas[serial];
        if (presencasDoAluno && Object.keys(presencasDoAluno).length > 0 && allUsers[serial]) {
          listData.push({
            name: allUsers[serial].name,
            serial: serial
          });
        }
      });
      renderList();

    } catch(error) {
      listResults.innerHTML = `<p style="color:red; text-align:center;">Erro ao carregar lista de presenças: ${error.message}</p>`;
    }
  }

  // Listener para o campo de busca do modal de lista
  listSearch.addEventListener('input', () => renderList(listSearch.value));

  // Listener para fechar o modal de lista
  closeListModal.addEventListener('click', ()=> listModalBack.style.display='none');
  listModalBack.addEventListener('click', (e)=>{ if(e.target===listModalBack) listModalBack.style.display='none'; });


  // ATUALIZADA: Função showStats() com botões que chamam as novas funções de lista
  async function showStats(){
    statsModalBack.style.display = 'flex';
    statsContent.innerHTML = '<p style="text-align:center;">Carregando dados...</p><div class="spinner"></div>';
    
    const totalAlunos = Object.keys(allUsers).length;
    let alunosComTreino = 0;
    let alunosComPresenca = 0; 
    
    try {
        const treinosSnap = await db.ref('treinos').get();
        const allTreinos = treinosSnap.val() || {};
        const presencasSnap = await db.ref('presencas').get();
        const allPresencas = presencasSnap.val() || {};

        Object.keys(allTreinos).forEach(serial => {
            const treinosDoAluno = allTreinos[serial];
            if (Array.isArray(treinosDoAluno) && treinosDoAluno.length > 0 && allUsers[serial]) {
                alunosComTreino++;
            }
        });
        
        Object.keys(allPresencas).forEach(serial => {
            const presencasDoAluno = allPresencas[serial];
            if (presencasDoAluno && Object.keys(presencasDoAluno).length > 0 && allUsers[serial]) {
                alunosComPresenca++;
            }
        });

        // Renderiza o conteúdo final com botões
        statsContent.innerHTML = `
          <div>
            <strong>Total de Alunos Cadastrados:</strong>
            ${totalAlunos}
          </div>
          <div>
            <strong>Alunos com Treino Montado:</strong>
            ${alunosComTreino}
            <button class="btn detail-btn" onclick="showTreinoList()">Ver Lista</button>
          </div>
          <div style="background:#e6f7e6; border-color:#d4edda;">
            <strong>Alunos que Usaram a Função Treino.html (Presença / Frequência):</strong>
            ${alunosComPresenca}
            <button class="btn detail-btn" onclick="showPresencaList()">Ver Lista</button>
          </div>
        `;

    } catch(error) {
        console.error("Erro ao buscar estatísticas:", error);
        statsContent.innerHTML = `<p style="color:red; text-align:center;">Erro ao carregar dados: ${error.message}</p>`;
    }
  }
  // Fim da ATUALIZAÇÃO showStats()

  // Listeners para os modais
  infoBtn.addEventListener('click', showStats);
  closeStatsModal.addEventListener('click', ()=> statsModalBack.style.display='none');
  statsModalBack.addEventListener('click', (e)=>{ if(e.target===statsModalBack) statsModalBack.style.display='none'; });

</script>

</body>
</html>
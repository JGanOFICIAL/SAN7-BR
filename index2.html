<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel do Funcionário</title>
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #fff;
  margin: 0; padding: 0;
}
header {
  position: fixed; top: 0; left: 0; right: 0;
  background: #fff; height: 70px; display: flex; align-items: center; justify-content: flex-start;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding-left: 20px; z-index: 10;
}
header .logo { width: 140px; height: 40px; background: #ddd; }
main { margin-top: 100px; padding: 20px; }
.perfil { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
.perfil img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid #0066cc; object-fit: cover; }
.perfil-info p { margin: 3px 0; }
input, select {
  border: 2px solid #003366; border-radius: 6px; padding: 8px 10px;
  font-size: 16px; outline: none; background: transparent;
}
button {
  border: 2px solid #003366; background: transparent; color: #003366;
  border-radius: 6px; font-size: 16px; padding: 10px 20px;
  cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center;
}
button.loading { pointer-events: none; opacity: 0.7; }
.spinner {
  border: 3px solid transparent; border-top: 3px solid #003366;
  border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite;
}
@keyframes spin { from {transform: rotate(0);} to {transform: rotate(360deg);} }
.cronometro {
  font-size: 30px; color: #003366; font-weight: bold; margin: 25px 0; text-align: center;
}
.hist { margin-top: 30px; }
.hist table { width: 100%; border-collapse: collapse; }
.hist th, .hist td { border-bottom: 1px solid #ccc; padding: 10px; text-align: center; }
.hist th { background: #e9f3ff; color: #003366; }
.alerta, .sobrepor {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 1000;
}
.alerta .box, .sobrepor .box {
  background: #fff; padding: 25px; border-radius: 8px; text-align: center; width: 320px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
.alerta .box button, .sobrepor .box button { margin-top: 15px; }
#cameraView {
  width: 260px; height: 260px; border-radius: 50%; overflow: hidden;
  position: relative; display: none; margin: 20px auto;
}
#cameraView video { width: 100%; height: 100%; object-fit: cover; }
#finalizarBtn { border: 2px solid #c00; color: #c00; }
</style>
</head>
<body>
<header><div class="logo">






<div style="position:absolute;top:50%;right:20px;transform:translateY(-60%);">
  <div id="menuBtn" style="cursor:pointer;font-size:56px;color:#000;line-height:1;">☰</div>
  <div id="menu" style="display:none;position:absolute;right:0;top:70px;background:#fff;padding:10px 15px;border:1px solid #ccc;">
    <a href="login2.html" target="_blank" style="color:#000;text-decoration:none;font-size:18px;">Sair</a>
  </div>
</div>

<script>
menuBtn.onclick = () => {
  const m = menu;
  if (m.style.display === 'block') {
    m.style.display = 'none';
    menuBtn.textContent = '☰';
  } else {
    m.style.display = 'block';
    menuBtn.textContent = '✕';
  }
};
</script>






   <img src="https://c2a6771173.cbaul-cdnwnd.com/4f0c8b93cda84ae8665e2b589652cf30/200000083-d9fb4d9fb6/700/3F36BE85-5E12-4237-844C-9BD82571F2C4.webp?ph=c2a6771173" alt="Logo" style="background:transparent; width:240px; height:auto; object-fit:contain;">





</div>


</header>



<main>
  <div class="perfil">
    <img id="fotoPerfil" src="">
    <div class="perfil-info">
      <p><strong>Nome:</strong> <span id="nome"></span></p>
      <p><strong>NA:</strong> <span id="na"></span></p>
      <p><strong>Telefone:</strong> <span id="tel"></span></p>
    </div>
  </div>

  <div class="cronometro" id="cronometro">00:00:00</div>
  <div style="text-align:center;">
    <button id="iniciarBtn">Iniciar Ponto</button>
    <button id="finalizarBtn">Finalizar Dia</button>
  </div>

  <div style="margin-top:25px; text-align:center;">
    <input type="number" id="mesInput" placeholder="Mês (1-12)" style="width:120px;">
    <input type="number" id="anoInput" placeholder="Ano (2025)" style="width:120px;">
    <button id="buscarMes">Buscar</button>
  </div>

  <div class="hist" id="hist">
    <h3>Histórico do Mês Atual</h3>
    <table>
      <thead><tr><th>Data</th><th>Entrada</th><th>Saída</th><th>Duração</th></tr></thead>
      <tbody id="histBody"></tbody>
    </table>
  </div>
</main>

<div class="alerta" id="alertBox">
  <div class="box"><p id="alertMsg"></p><button onclick="fecharAlerta()">OK</button></div>
</div>

<div class="sobrepor" id="cameraBox">
  <div class="box">
    <h3>Reconhecimento Facial</h3>
    <p id="dadosConfirma"></p>
    <button onclick="fecharCamera()">X</button>
    <div id="cameraView"><video id="video" autoplay></video></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBPiznHCVkTAgx6m02bZB8b0FFaot9UkBU",
  authDomain: "prefeitura-de-joao-camara.firebaseapp.com",
  projectId: "prefeitura-de-joao-camara",
  storageBucket: "prefeitura-de-joao-camara.firebasestorage.app",
  messagingSenderId: "269299041577",
  appId: "1:269299041577:web:fd41b2939240e9eb476338",
  measurementId: "G-YT7NHR342J"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const serie = localStorage.getItem("usuarioAtual");
if(!serie) window.location.href = "login2.html";

const nomeEl = document.getElementById("nome");
const naEl = document.getElementById("na");
const telEl = document.getElementById("tel");
const fotoEl = document.getElementById("fotoPerfil");
const cronEl = document.getElementById("cronometro");
const histBody = document.getElementById("histBody");
let startTime = null, interval = null, ativo = false;

db.ref("usuarios/"+serie).on("value", snap=>{
  if(snap.exists()){
    const d = snap.val();
    nomeEl.textContent = d.nome;
    naEl.textContent = serie;
    telEl.textContent = d.telefone || "—";
    fotoEl.src = d.foto || "";
  }
});

function atualizarCronometro(){
  if(!startTime) return;
  const diff = Date.now() - startTime;
  const h = String(Math.floor(diff/3600000)).padStart(2,'0');
  const m = String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
  const s = String(Math.floor((diff%60000)/1000)).padStart(2,'0');
  cronEl.textContent = `${h}:${m}:${s}`;
}

db.ref("pontos/"+serie+"/ativo").on("value", s=>{
  if(s.exists() && s.val().inicio){
    ativo = true;
    startTime = s.val().inicio;
    clearInterval(interval);
    interval = setInterval(atualizarCronometro,1000);
  } else { ativo = false; clearInterval(interval); }
});

document.getElementById("iniciarBtn").onclick = ()=>{
  if(ativo){ mostrarAlerta("Ponto já iniciado."); return; }
  document.getElementById("dadosConfirma").innerText = `Reconhecimento facial em andamento...\nNA: ${serie}\nData: ${new Date().toLocaleString()}`;
  document.getElementById("cameraBox").style.display = "flex";
  const video = document.getElementById("video");
  navigator.mediaDevices.getUserMedia({video:true})
  .then(stream=>{
    video.srcObject = stream;
    document.getElementById("cameraView").style.display="block";
    setTimeout(()=>{
      const tracks = stream.getTracks();
      tracks.forEach(t=>t.stop());
      document.getElementById("cameraBox").style.display="none";
      const agora = Date.now();
      db.ref("pontos/"+serie+"/ativo").set({inicio: agora});
      db.ref("historico/"+serie+"/"+dataChaveAtual()+"/inicio").set(agora);
      mostrarAlerta("Reconhecimento concluído e ponto iniciado automaticamente.");
    },3800);
  }).catch(()=>mostrarAlerta("Permissão da câmera negada"));
};

document.getElementById("finalizarBtn").onclick = ()=>{
  if(!ativo){ mostrarAlerta("Nenhum ponto em andamento."); return; }
  const fim = Date.now();
  db.ref("pontos/"+serie+"/ativo").remove();
  db.ref("historico/"+serie+"/"+dataChaveAtual()+"/fim").set(fim);
  mostrarAlerta("Dia finalizado com sucesso.");
};

function dataChaveAtual(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

db.ref("historico/"+serie).on("value", s=>{
  histBody.innerHTML = "";
  if(s.exists()){
    Object.entries(s.val()).forEach(([data,val])=>{
      const ini = val.inicio ? new Date(val.inicio).toLocaleTimeString() : "--";
      const fim = val.fim ? new Date(val.fim).toLocaleTimeString() : "--";
      let dur = "--";
      if(val.inicio && val.fim){
        const diff = val.fim - val.inicio;
        const h = Math.floor(diff/3600000);
        const m = Math.floor((diff%3600000)/60000);
        dur = `${h}h ${m}m`;
      }
      histBody.innerHTML += `<tr><td>${data}</td><td>${ini}</td><td>${fim}</td><td>${dur}</td></tr>`;
    });
  }
});

document.getElementById("buscarMes").onclick = ()=>{
  const mes = parseInt(document.getElementById("mesInput").value);
  const ano = parseInt(document.getElementById("anoInput").value);
  if(!mes || !ano){ mostrarAlerta("Preencha mês e ano corretamente."); return; }
  db.ref("historico/"+serie).once("value").then(s=>{
    histBody.innerHTML="";
    if(s.exists()){
      Object.entries(s.val()).forEach(([data,val])=>{
        const [yy,mm] = data.split("-").map(Number);
        if(yy===ano && mm===mes){
          const ini = val.inicio?new Date(val.inicio).toLocaleTimeString():"--";
          const fim = val.fim?new Date(val.fim).toLocaleTimeString():"--";
          let dur="--";
          if(val.inicio&&val.fim){
            const diff=val.fim-val.inicio;
            const h=Math.floor(diff/3600000);
            const m=Math.floor((diff%3600000)/60000);
            dur=`${h}h ${m}m`;
          }
          histBody.innerHTML += `<tr><td>${data}</td><td>${ini}</td><td>${fim}</td><td>${dur}</td></tr>`;
        }
      });
    }
  });
};

function mostrarAlerta(msg){
  document.getElementById("alertMsg").innerText = msg;
  document.getElementById("alertBox").style.display = "flex";
}
function fecharAlerta(){ document.getElementById("alertBox").style.display = "none"; }
function fecharCamera(){ document.getElementById("cameraBox").style.display = "none"; }
</script>
</body>
</html>



<div id="geo-permission" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg,#f5f9ff,#e8f3ff);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-family:'Arial',sans-serif;transition:opacity 0.5s;">
  <img src="https://c2a6771173.cbaul-cdnwnd.com/4f0c8b93cda84ae8665e2b589652cf30/200000087-563985639a/450/F9CFD25C-348F-4E42-AA1B-5F4A5FBC5335.webp" alt="Imagem" style="width:140px;height:140px;object-fit:contain;margin-bottom:25px;">
  <h2 style="margin-bottom:10px;color:#2c3e50;font-size:22px;">Permissão de Localização</h2>
  <p style="color:#555;margin-bottom:25px;font-size:15px;max-width:300px;">Precisamos da sua localização para validar o ponto. Clique em continuar e permita o acesso.</p>
  <div style="display:flex;gap:12px;">
    <button id="btnContinuar" style="background:#4da6ff;color:white;border:none;padding:12px 25px;cursor:pointer;font-size:16px;font-weight:600;box-shadow:0 3px 8px rgba(0,0,0,0.1);transition:0.3s;">Continuar</button>
    <button onclick="window.location.href='login.html'" style="border:2px solid #4CAF50;background:transparent;color:#4CAF50;padding:12px 25px;cursor:pointer;font-size:16px;font-weight:600;transition:0.3s;">Voltar</button>
  </div>
</div>

<div id="geo-block" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:10000;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-family:'Arial',sans-serif;">
  <h2 style="color:red;margin-bottom:10px;font-size:22px;">Acesso Negado</h2>
  <p style="color:#444;margin-bottom:25px;font-size:15px;">Você não está dentro da área permitida.</p>
  <button onclick="window.location.href='login.html'" style="border:2px solid #4CAF50;background:transparent;color:#4CAF50;padding:12px 25px;cursor:pointer;font-size:16px;font-weight:600;">Voltar</button>
</div>

<script>
const localLatitude = -5.540111;
const localLongitude = -35.818720;
const raioPermitido = 80;

function calcularDistancia(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI/180;
  const φ2 = lat2 * Math.PI/180;
  const Δφ = (lat2 - lat1) * Math.PI/180;
  const Δλ = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function validarLocalizacao(latitude, longitude) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`);
    if (!response.ok) throw new Error("API não respondeu");
    const distancia = calcularDistancia(localLatitude, localLongitude, latitude, longitude);
    return distancia <= raioPermitido;
  } catch {
    return false;
  }
}

document.getElementById("btnContinuar").addEventListener("click", async () => {
  const btn = document.getElementById("btnContinuar");
  btn.disabled = true;
  btn.textContent = "Validando...";
  const spinner = document.createElement("div");
  spinner.style.width = "45px";
  spinner.style.height = "45px";
  spinner.style.border = "5px solid #cce6ff";
  spinner.style.borderTop = "5px solid #4da6ff";
  spinner.style.borderRadius = "50%";
  spinner.style.animation = "spin 1s linear infinite";
  spinner.style.margin = "25px auto 0";
  document.getElementById("geo-permission").appendChild(spinner);

  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    const autorizado = await validarLocalizacao(latitude, longitude);
    setTimeout(() => {
      spinner.remove();
      if (autorizado) {
        document.getElementById("geo-permission").style.opacity = "0";
        setTimeout(() => {
          document.getElementById("geo-permission").style.display = "none";
        }, 500);
      } else {
        document.getElementById("geo-block").style.display = "flex";
      }
    }, 4000);
  }, () => {
    alert("Não foi possível obter sua localização.");
    btn.disabled = false;
    btn.textContent = "Continuar";
    spinner.remove();
  }, { enableHighAccuracy: true });
});

const style = document.createElement("style");
style.innerHTML = `
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
button:hover { transform: scale(1.03); opacity:0.9; }
`;
document.head.appendChild(style);
</script>
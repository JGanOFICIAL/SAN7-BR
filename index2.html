<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel do Funcionário</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* VARIÁVEIS DE CORES */
:root {
  --primary-color: #003366; /* Azul Escuro DomusFit */
  --secondary-color: #0066cc; /* Azul Claro para Destaques */
  --background-light: #f5f8ff; /* Fundo Levemente Azulado */
  --text-dark: #333;
  --text-light: #fff;
  --border-color: #ddd;
  --input-border-focus: var(--secondary-color);
  --button-hover-bg: var(--primary-color);
  --button-hover-text: var(--text-light);
}

/* ESTILO GERAL */
body {
  font-family: 'Poppins', sans-serif;
  background: var(--background-light);
  margin: 0; padding: 0;
  display: flex; 
  flex-direction: column; 
  min-height: 100vh;
  color: var(--text-dark);
}

/* CABEÇALHO (FIXO/STICKY E DE PONTA A PONTA) */
header {
  position: sticky; /* Fixo no topo */
  top: 0; left: 0; right: 0;
  width: 100%; /* Garante de canto a canto */
  background: var(--text-light); height: 70px; 
  display: flex; 
  align-items: center; 
  justify-content: space-between; /* Logo esquerda, menu direita */
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  padding: 0 30px; 
  z-index: 20;
  box-sizing: border-box; /* Garante que o padding não afete a largura total */
}
header .logo {
  width: 220px; height: 45px;
  background-image: url('https://c2a6771173.cbaul-cdnwnd.com/4f0c8b93cda84ae8665e2b589652cf30/200000083-d9fb4d9fb6/700/3F36BE85-5E12-4237-844C-9BD82571F2C4.webp');
  background-repeat: no-repeat;
  background-size: contain;
  background-position: left;
}
/* Estilo do botão de menu no Header */
.header-menu-btn {
  cursor: pointer; font-size: 32px; 
  color: #000; 
  line-height: 1;
  transition: color 0.3s;
  padding: 5px; 
}
.header-menu-btn:hover {
  color: var(--primary-color);
}
#menu {
  display: none; 
  position: absolute; 
  right: 30px; 
  top: 60px;
  background: var(--text-light); padding: 15px 20px; 
  border-radius: 0;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  min-width: 150px;
  z-index: 10;
}
#menu a {
  color: var(--primary-color); text-decoration: none; font-size: 16px;
  font-weight: 600; display: block; padding: 5px 0;
  transition: color 0.3s;
}
#menu a:hover {
  color: var(--secondary-color);
}

/* CONTAINER PRINCIPAL (Split Screen - Colado abaixo do header) */
.main-container {
  display: flex;
  justify-content: center;
  align-items: stretch;
  width: 100%;
  flex-grow: 1;
  margin-top: 0; /* Colado no header sticky */
}

/* SEÇÃO DE IMAGEM (Lado esquerdo do Split Screen) */
.image-section {
  flex: 1; /* Reduzido de 1.2 para 1 para ocupar menos espaço horizontal */
  background-image: url('https://s2-oglobo.glbimg.com/wpF9B9sKEL6PMjHhIIfCJSDzhwE=/0x0:826x551/888x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_da025474c0c44edd99332dddb09cabe8/internal_photos/bs/2023/e/V/4Wg98xVVeM6KBREjlDpA/mulher-fazendo-agachamento-na-ma.jpg');
  background-size: cover;
  background-position: center center;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  color: var(--text-light);
  text-align: center;
  padding: 60px;
  position: relative;
  overflow: hidden;
}
/* Sobreposição de Gradiente */
.image-section::after {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, rgba(0, 51, 102, 0.75) 0%, rgba(0, 102, 204, 0.55) 100%);
}
.image-section h1, .image-section p {
  position: relative;
  z-index: 1;
  text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
}
.image-section h1 {
  font-size: 40px; 
  font-weight: 700;
  margin-bottom: 15px;
}
.image-section p {
  font-size: 16px; 
  font-weight: 300;
  max-width: 450px;
}

/* SEÇÃO PRINCIPAL (Painel - Lado direito do Split Screen) */
.main-section {
  flex: 1.2; 
  display: flex;
  flex-direction: column;
  padding: 40px 70px;
  position: relative;
  background: var(--text-light);
}

/* ESTILOS DO CONTEÚDO (index.html) */
.perfil { 
    display: flex; align-items: center; gap: 20px; margin-bottom: 30px; 
    padding: 20px;
    border: 1px solid var(--border-color);
    border-radius: 0;
}
.perfil img { 
    width: 80px; height: 80px; border-radius: 50%; 
    border: 3px solid var(--secondary-color); 
    object-fit: cover; 
}
.perfil-info p { margin: 3px 0; font-size: 15px; }

/* Cronômetro e Botões */
.cronometro {
    font-size: 44px; color: var(--primary-color); font-weight: 700; 
    margin: 25px 0; text-align: center;
}
.action-buttons {
    display: flex; justify-content: center; gap: 20px;
    margin-top: 20px;
}
.action-buttons button, .main-section input, .main-section select {
  height: 54px;
  border: 1px solid var(--border-color);
  border-radius: 0;
  background: var(--background-light);
  font-size: 16px;
  outline: none;
  transition: all 0.3s ease;
  box-sizing: border-box;
  text-align: center;
  padding: 0 15px;
  font-weight: 600;
}
.action-buttons button {
  background-color: var(--primary-color);
  color: var(--text-light);
  cursor: pointer;
  border: none;
  padding: 0 30px;
  width: 180px;
}
.action-buttons button:hover {
  background-color: var(--secondary-color);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3);
}
#finalizarBtn { 
  background-color: #c00; 
  color: var(--text-light); 
  border: none; 
}
#finalizarBtn:hover {
  background-color: #e00;
}

/* Busca Histórico */
.search-form {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 25px;
}
.search-form input {
  width: 120px;
  background: var(--text-light);
  border: 1px solid var(--primary-color);
}
.search-form input:focus {
  border-color: var(--input-border-focus);
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
}
.search-form button {
  width: 100px;
  background-color: var(--secondary-color);
  color: var(--text-light);
  border: none;
  font-weight: 600;
  cursor: pointer;
  border-radius: 0;
}
.search-form button:hover {
    background-color: var(--primary-color);
}

/* Histórico */
.hist { margin-top: 30px; }
.hist h3 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-bottom: 15px; }
.hist table { width: 100%; border-collapse: collapse; border: 1px solid var(--border-color); }
.hist th, .hist td { 
    border-bottom: 1px solid var(--border-color); 
    padding: 12px 8px; 
    text-align: center; 
    font-size: 14px;
}
.hist th { 
    background: var(--primary-color); 
    color: var(--text-light); 
    font-weight: 600;
    border-bottom: 1px solid var(--primary-color); 
}
.hist tr:last-child td { border-bottom: none; }
.hist tr:nth-child(even) td { background-color: #f9f9f9; }

/* SPINNER */
button.loading {
  pointer-events: none;
  opacity: 0.8;
  background-color: var(--primary-color);
}
.spinner {
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid var(--text-light);
  border-radius: 50%;
  width: 24px; height: 24px;
  animation: spin 0.8s linear infinite;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ALERTA (MODAL) - Padronizado com login.html */
.alerta, .sobrepor {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: none; align-items: center; justify-content: center;
  z-index: 1000;
}
.alerta .box, .sobrepor .box {
  background: var(--text-light); padding: 35px; 
  border-radius: 0;
  text-align: center; width: 90%; max-width: 350px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}
.alerta .box p, .sobrepor .box p {
    font-size: 18px;
    margin-bottom: 20px;
    color: var(--text-dark);
}
.alerta .box button, .sobrepor .box button {
  margin-top: 0; width: 120px;
  height: 45px;
  background-color: var(--secondary-color);
  color: var(--text-light);
  border: none;
  font-weight: 600;
  cursor: pointer;
  border-radius: 0;
}
.alerta .box button:hover, .sobrepor .box button:hover {
    background-color: var(--primary-color);
}

/* Câmera e Confirmação Facial - NOVO FORMATO OVAL */
#cameraView {
  /* Largura menor, altura maior para formato de rosto */
  width: 180px; 
  height: 250px; 
  /* Raio de borda horizontal de 50%, vertical maior para o oval */
  border-radius: 50% / 60%; 
  overflow: hidden;
  position: relative; 
  display: block; /* Garante que o div seja visível no modal */
  margin: 20px auto;
  border: 5px solid var(--primary-color);
  box-shadow: 0 0 10px rgba(0, 51, 102, 0.5); /* Sombra para destacar */
}
#cameraView video { 
    /* Garante que o vídeo preencha o container oval */
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
}
#dadosConfirma { white-space: pre-wrap; margin-bottom: 10px; }

/* MEDIA QUERIES (Responsividade) */
@media (max-width: 1024px) {
  .image-section h1 {font-size: 36px;}
  .image-section p {font-size: 16px;}
  .main-section {padding: 30px 40px;}
  .image-section {flex: 1;}
}
@media (max-width: 900px) {
  /* Alinhamento no mobile: Logo esquerda e menu direita */
  header {padding: 0 20px;}
  /* Aqui o main-container empilha a imagem e o painel */
  .main-container {flex-direction: column; flex-grow: 1;}
  /* A imagem ocupa 100% da largura em mobile e tem altura fixa REDUZIDA */
  .image-section {
    width: 100%;
    height: 25vh; 
    min-height: 180px; 
    padding: 30px 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .image-section h1 {font-size: 30px;} 
  .main-section {
    padding: 40px 20px;
    border-left: none;
    flex-grow: 1;
  }
}
@media (max-width: 500px) {
  #menu {right: 20px;}
  .image-section h1 {font-size: 26px;}
  .action-buttons { flex-direction: column; gap: 15px; }
  .action-buttons button { width: 100%; }
}
</style>
</head>
<body>

<header>
  <div class="logo"></div>

  <div>
    <div id="menuBtn" class="header-menu-btn">☰</div>
    <div id="menu">
      <a href="login2.html">Sair</a>
    </div>
  </div>

<script>
// JS para o botão de menu (abrir/fechar)
const menuBtn = document.getElementById('menuBtn');
const menu = document.getElementById('menu');
menuBtn.onclick = () => {
  if (menu.style.display === 'block') {
    menu.style.display = 'none';
    menuBtn.textContent = '☰';
  } else {
    menu.style.display = 'block';
    menuBtn.textContent = '✕';
  }
};
</script>
</header>

<div class="main-container">
  <div class="image-section">
    <h1>Painel de Controle</h1>
    <p>Bem-vindo(a) de volta! Gerencie seu ponto de forma rápida e segura.</p>
  </div>
  
  <div class="main-section">
    <div class="perfil">
      <img id="fotoPerfil" src="">
      <div class="perfil-info">
        <p><strong>Nome:</strong> <span id="nome"></span></p>
        <p><strong>NA:</strong> <span id="na"></span></p>
        <p><strong>Telefone:</strong> <span id="tel"></span></p>
      </div>
    </div>

    <div class="cronometro" id="cronometro">00:00:00</div>
    <div class="action-buttons">
      <button id="iniciarBtn">Iniciar Ponto</button>
      <button id="finalizarBtn">Finalizar Dia</button>
    </div>

    <div class="search-form">
      <input type="number" id="mesInput" placeholder="Mês (1-12)" min="1" max="12">
      <input type="number" id="anoInput" placeholder="Ano (2025)">
      <button id="buscarMes">Buscar</button>
    </div>

    <div class="hist" id="hist">
      <h3>Histórico do Mês</h3>
      <table>
        <thead><tr><th>Data</th><th>Entrada</th><th>Saída</th><th>Duração</th></tr></thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="alerta" id="alertBox">
  <div class="box"><p id="alertMsg"></p><button onclick="fecharAlerta()">Entendi</button></div>
</div>

<div class="sobrepor" id="cameraBox">
  <div class="box">
    <h3>Reconhecimento Facial</h3>
    <p id="dadosConfirma"></p>
    <div id="cameraView"><video id="video" autoplay></video></div>
    <button onclick="fecharCamera()">Cancelar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// LOGÍSTICA (NÃO ALTERADA)
const firebaseConfig = {
  apiKey: "AIzaSyBPiznHCVkTAgx6m02bZB8b0FFaot9UkBU",
  authDomain: "prefeitura-de-joao-camara.firebaseapp.com",
  projectId: "prefeitura-de-joao-camara",
  storageBucket: "prefeitura-de-joao-camara.firebasestorage.app",
  messagingSenderId: "269299041577",
  appId: "1:269299041577:web:fd41b2939240e9eb476338",
  measurementId: "G-YT7NHR342J"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const serie = localStorage.getItem("usuarioAtual");
if(!serie) window.location.href = "login2.html";

const nomeEl = document.getElementById("nome");
const naEl = document.getElementById("na");
const telEl = document.getElementById("tel");
const fotoEl = document.getElementById("fotoPerfil");
const cronEl = document.getElementById("cronometro");
const histBody = document.getElementById("histBody");
let startTime = null, interval = null, ativo = false;

db.ref("usuarios/"+serie).on("value", snap=>{
  if(snap.exists()){
    const d = snap.val();
    nomeEl.textContent = d.nome;
    naEl.textContent = serie;
    telEl.textContent = d.telefone || "—";
    fotoEl.src = d.foto || "";
  }
});

function atualizarCronometro(){
  if(!startTime) return;
  const diff = Date.now() - startTime;
  const h = String(Math.floor(diff/3600000)).padStart(2,'0');
  const m = String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
  const s = String(Math.floor((diff%60000)/1000)).padStart(2,'0');
  cronEl.textContent = `${h}:${m}:${s}`;
}

db.ref("pontos/"+serie+"/ativo").on("value", s=>{
  if(s.exists() && s.val().inicio){
    ativo = true;
    startTime = s.val().inicio;
    clearInterval(interval);
    interval = setInterval(atualizarCronometro,1000);
  } else { ativo = false; clearInterval(interval); }
});

document.getElementById("iniciarBtn").onclick = ()=>{
  if(ativo){ mostrarAlerta("Ponto já iniciado."); return; }
  document.getElementById("dadosConfirma").innerText = `Reconhecimento facial em andamento...\nNA: ${serie}\nData: ${new Date().toLocaleString()}`;
  document.getElementById("cameraBox").style.display = "flex";
  
  // INÍCIO DA CÂMERA IMEDIATO
  const video = document.getElementById("video");
  navigator.mediaDevices.getUserMedia({video:true})
  .then(stream=>{
    video.srcObject = stream;
    // O #cameraView não precisa de display:block aqui, pois já está como 'display: block' no CSS,
    // mas deixamos o código de stream aqui.
    
    setTimeout(()=>{
      const tracks = stream.getTracks();
      tracks.forEach(t=>t.stop());
      document.getElementById("cameraBox").style.display="none";
      const agora = Date.now();
      db.ref("pontos/"+serie+"/ativo").set({inicio: agora});
      db.ref("historico/"+serie+"/"+dataChaveAtual()+"/inicio").set(agora);
      mostrarAlerta("Reconhecimento concluído e ponto iniciado automaticamente.");
    },3800);
  }).catch(()=>mostrarAlerta("Permissão da câmera negada ou não disponível no dispositivo."));
};

document.getElementById("finalizarBtn").onclick = ()=>{
  if(!ativo){ mostrarAlerta("Nenhum ponto em andamento."); return; }
  const fim = Date.now();
  db.ref("pontos/"+serie+"/ativo").remove();
  db.ref("historico/"+serie+"/"+dataChaveAtual()+"/fim").set(fim);
  mostrarAlerta("Dia finalizado com sucesso.");
};

function dataChaveAtual(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

db.ref("historico/"+serie).on("value", s=>{
  histBody.innerHTML = "";
  if(s.exists()){
    Object.entries(s.val()).forEach(([data,val])=>{
      const ini = val.inicio ? new Date(val.inicio).toLocaleTimeString() : "--";
      const fim = val.fim ? new Date(val.fim).toLocaleTimeString() : "--";
      let dur = "--";
      if(val.inicio && val.fim){
        const diff = val.fim - val.inicio;
        const h = Math.floor(diff/3600000);
        const m = Math.floor((diff%3600000)/60000);
        dur = `${h}h ${m}m`;
      }
      histBody.innerHTML += `<tr><td>${data}</td><td>${ini}</td><td>${fim}</td><td>${dur}</td></tr>`;
    });
  }
});

document.getElementById("buscarMes").onclick = ()=>{
  const mes = parseInt(document.getElementById("mesInput").value);
  const ano = parseInt(document.getElementById("anoInput").value);
  if(!mes || !ano){ mostrarAlerta("Preencha mês e ano corretamente."); return; }
  db.ref("historico/"+serie).once("value").then(s=>{
    histBody.innerHTML="";
    if(s.exists()){
      Object.entries(s.val()).forEach(([data,val])=>{
        const [yy,mm] = data.split("-").map(Number);
        if(yy===ano && mm===mes){
          const ini = val.inicio?new Date(val.inicio).toLocaleTimeString():"--";
          const fim = val.fim?new Date(val.fim).toLocaleTimeString():"--";
          let dur="--";
          if(val.inicio&&val.fim){
            const diff=val.fim-val.inicio;
            const h=Math.floor(diff/3600000);
            const m=Math.floor((diff%3600000)/60000);
            dur=`${h}h ${m}m`;
          }
          histBody.innerHTML += `<tr><td>${data}</td><td>${ini}</td><td>${fim}</td><td>${dur}</td></tr>`;
        }
      });
    }
  });
};

function mostrarAlerta(msg){
  document.getElementById("alertMsg").innerText = msg;
  document.getElementById("alertBox").style.display = "flex";
}
function fecharAlerta(){ document.getElementById("alertBox").style.display = "none"; }
function fecharCamera(){ 
  const video = document.getElementById("video");
  if(video.srcObject){
    video.srcObject.getTracks().forEach(track => track.stop());
  }
  document.getElementById("cameraBox").style.display = "none"; 
}
</script>
</body>
</html>

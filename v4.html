<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giandra Silva - Gestão VIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;500;600&display=swap');
        
        :root {
            --gold-primary: #C5A059;
            --gold-gradient: linear-gradient(135deg, #A67C37 0%, #D4AF37 45%, #F1D38A 100%);
        }

        body { font-family: 'Montserrat', sans-serif; background: #fafafa; color: #1a1a1a; }
        .brand-font { font-family: 'Cinzel', serif; }
        .gold-text { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .gold-button { background: var(--gold-gradient); transition: all 0.4s ease; box-shadow: 0 4px 20px rgba(166, 124, 55, 0.2); }
        .gold-button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(197, 160, 89, 0.15); border-radius: 30px; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); z-index: 1000; }
        .active-modal { display: flex; align-items: center; justify-content: center; }

        .service-card { background: white; border-radius: 30px; transition: all 0.4s ease; border: 1px solid #f0f0f0; }
        .service-card:hover { transform: translateY(-5px); border-color: var(--gold-primary); }

        .btn-delete { color: #ef4444; opacity: 0.3; transition: 0.3s; }
        tr:hover .btn-delete { opacity: 1; }

        /* Estilo para Acordeão do Histórico */
        .hist-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .hist-card.active .hist-details { max-height: 1000px; }
        .hist-card.active .arrow-icon { transform: rotate(180deg); }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--gold-primary); border-radius: 10px; }
    </style>
</head>
<body>

    <header class="sticky top-0 z-50 bg-white/70 backdrop-blur-xl border-b border-gray-100 px-10 py-6 flex justify-between items-center">
        <div class="flex flex-col">
            <h1 class="brand-font text-2xl tracking-[0.3em] gold-text">GEANDRA SILVA</h1>
            <span class="text-[9px] uppercase tracking-[0.5em] text-gray-400 font-bold">Luxury Studio</span>
        </div>
        
        <div class="flex items-center gap-8">
            <button onclick="openModal('modalHistoricoGeral')" class="text-gray-500 hover:text-amber-700 transition flex items-center gap-2 text-xs font-semibold uppercase tracking-widest">
                <i data-lucide="calendar-search" class="w-4 h-4"></i> Arquivo
            </button>
            <button onclick="finalizarDia()" class="gold-button text-white px-10 py-3 rounded-2xl font-bold text-[10px] tracking-[0.2em] uppercase">
                Fechar Expediente
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto mt-12 px-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10 mb-20">
            <div class="glass-card p-10 flex flex-col items-center text-center">
                <span class="text-[10px] uppercase tracking-[0.2em] text-gray-400 mb-2 font-bold">Faturamento Hoje</span>
                <h2 id="saldoDia" class="text-4xl font-light text-gray-900 tracking-tighter">R$ 0,00</h2>
            </div>
            <div class="glass-card p-10 flex flex-col items-center text-center">
                <span class="text-[10px] uppercase tracking-[0.2em] text-gray-400 mb-2 font-bold">Atendimentos</span>
                <h2 id="contagemServicos" class="text-4xl font-light text-gray-900 tracking-tighter">0</h2>
            </div>
            <div class="flex items-center justify-center">
                <button onclick="openModal('modalCadastroServico')" class="group flex flex-col items-center gap-4">
                    <div class="w-16 h-16 rounded-[22px] border-2 border-dashed border-amber-300 flex items-center justify-center group-hover:bg-amber-50 transition-all">
                        <i data-lucide="plus" class="text-amber-600"></i>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-gray-400">Novo Procedimento</span>
                </button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-6">
            <h3 class="brand-font text-2xl text-gray-800 tracking-widest">Serviços</h3>
            <input type="text" id="buscaServico" oninput="filtrarServicos()" placeholder="Pesquisar serviço..." class="w-full md:w-80 py-3 px-6 rounded-2xl border border-gray-100 shadow-sm outline-none focus:border-amber-300">
        </div>
        <div id="listaServicos" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 mb-24"></div>

        <div class="mb-20">
            <h3 class="brand-font text-2xl text-gray-800 tracking-widest mb-8">Fluxo de Caixa Real</h3>
            <div class="bg-white rounded-[40px] shadow-2xl shadow-gray-200/40 overflow-hidden border border-gray-100">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50/50 text-[11px] uppercase tracking-[0.2em] text-gray-400 font-bold">
                            <th class="px-10 py-6 text-left">Hora</th>
                            <th class="px-10 py-6 text-left">Cliente</th>
                            <th class="px-10 py-6 text-left">Procedimento</th>
                            <th class="px-10 py-6 text-right">Valor</th>
                            <th class="px-6 py-6 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHoje" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="modalCadastroServico" class="modal">
        <div class="bg-white rounded-[45px] p-12 w-full max-w-lg relative shadow-2xl">
            <button onclick="closeModal('modalCadastroServico')" class="absolute top-8 right-8 text-gray-400"><i data-lucide="x"></i></button>
            <h2 class="brand-font text-2xl mb-10 text-center gold-text">Novo Serviço</h2>
            <div class="space-y-6">
                <input type="text" id="srvNome" placeholder="Nome" class="w-full bg-gray-50 rounded-2xl p-4 outline-none">
                <input type="text" id="srvImg" placeholder="Link da Imagem" class="w-full bg-gray-50 rounded-2xl p-4 outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="srvVista" placeholder="R$ À Vista" class="w-full bg-gray-50 rounded-2xl p-4 outline-none">
                    <input type="number" id="srvCartao" placeholder="R$ Cartão" class="w-full bg-gray-50 rounded-2xl p-4 outline-none">
                </div>
                <button onclick="salvarServico()" class="w-full gold-button text-white font-bold py-5 rounded-2xl uppercase text-xs tracking-widest">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalRealizar" class="modal">
        <div class="bg-white rounded-[45px] p-12 w-full max-w-lg relative shadow-2xl">
            <button onclick="closeModal('modalRealizar')" class="absolute top-8 right-8 text-gray-400"><i data-lucide="x"></i></button>
            <div class="text-center mb-8">
                <span id="nomeServicoSelecionado" class="text-[11px] uppercase tracking-[0.3em] text-amber-600 font-bold"></span>
                <h2 class="brand-font text-2xl text-gray-800 tracking-widest">Check-out</h2>
            </div>
            <input type="hidden" id="hiddenId">
            <div class="space-y-6">
                <input type="text" id="cliNome" placeholder="Nome da Cliente" class="w-full bg-gray-50 rounded-2xl p-4 pl-6 outline-none font-medium">
                <select id="metodoPagamento" onchange="atualizarPrecoVenda()" class="w-full bg-gray-50 rounded-2xl p-4 pl-6 outline-none font-medium appearance-none">
                    <option value="vista">Dinheiro / PIX</option>
                    <option value="cartao">Cartão de Crédito</option>
                </select>
                <div class="bg-amber-50/50 p-8 rounded-[30px] border-2 border-dashed border-amber-100 text-center">
                    <span class="text-[10px] uppercase tracking-widest text-amber-600 mb-2 font-bold block">Valor Final</span>
                    <input type="number" id="valorFinal" class="text-4xl font-light text-center bg-transparent w-full focus:outline-none text-gray-900 tracking-tighter">
                </div>
                <button onclick="confirmarRealizacao()" class="w-full gold-button text-white font-bold py-5 rounded-2xl uppercase text-xs tracking-widest">Finalizar</button>
            </div>
        </div>
    </div>

    <div id="modalHistoricoGeral" class="modal">
        <div class="bg-white rounded-[50px] p-12 w-full max-w-5xl max-h-[90vh] flex flex-col relative shadow-2xl">
            <button onclick="closeModal('modalHistoricoGeral')" class="absolute top-10 right-10 text-gray-400 hover:text-black transition"><i data-lucide="x"></i></button>
            
            <div class="flex flex-col md:flex-row justify-between items-end gap-6 mb-12 border-b pb-8">
                <div>
                    <h2 class="brand-font text-3xl text-gray-800 tracking-widest">Arquivo Histórico</h2>
                    <p class="text-gray-400 text-xs mt-2 uppercase tracking-widest font-bold">Consulta de Fechamentos</p>
                </div>
                <div class="relative w-full md:w-72">
                    <label class="text-[10px] font-bold text-amber-600 absolute -top-5 left-0">PESQUISAR DATA</label>
                    <input type="text" id="buscaDataHist" oninput="aplicarMascaraData(this)" placeholder="00/00/0000" class="w-full bg-gray-50 border-b-2 border-amber-200 py-3 px-4 outline-none focus:border-amber-500 font-bold tracking-widest text-gray-700">
                </div>
            </div>

            <div id="containerHistoricoAnterior" class="space-y-4 overflow-y-auto pr-4">
                </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCVdKIP6jl-mLaqHNMW-IwK3pVkvhuSvSI",
            databaseURL: "https://san7-brasil-default-rtdb.firebaseio.com",
            projectId: "san7-brasil"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let servicosData = {};
        const getHoje = () => new Date().toISOString().split('T')[0];

        function openModal(id) { document.getElementById(id).classList.add('active-modal'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active-modal'); }

        // Máscara de Data Automática
        function aplicarMascaraData(i) {
            let v = i.value.replace(/\D/g, '').slice(0, 8);
            if (v.length >= 5) v = v.replace(/^(\d{2})(\d{2})(\d{0,4})/, "$1/$2/$3");
            else if (v.length >= 3) v = v.replace(/^(\d{2})(\d{0,2})/, "$1/$2");
            i.value = v;
            filtrarHistorico(v);
        }

        function getDiaSemana(dataISO) {
            const dias = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            const d = new Date(dataISO + 'T00:00:00');
            return dias[d.getDay()];
        }

        // --- CRUD SERVIÇOS ---
        function salvarServico() {
            const nome = document.getElementById('srvNome').value;
            const img = document.getElementById('srvImg').value;
            const vista = document.getElementById('srvVista').value;
            const cartao = document.getElementById('srvCartao').value;
            if(!nome || !vista) return;
            db.ref('servicos').push({ nome, img, vista: parseFloat(vista), cartao: parseFloat(cartao) });
            closeModal('modalCadastroServico');
        }

        db.ref('servicos').on('value', snapshot => {
            servicosData = snapshot.val() || {};
            renderServicos();
        });

        function renderServicos(filtro = "") {
            const lista = document.getElementById('listaServicos');
            lista.innerHTML = '';
            for (let id in servicosData) {
                const s = servicosData[id];
                if (s.nome.toLowerCase().includes(filtro.toLowerCase())) {
                    lista.innerHTML += `
                        <div class="service-card p-8 flex flex-col items-center text-center">
                            <img src="${s.img || 'https://via.placeholder.com/150'}" class="w-24 h-24 rounded-full object-cover mb-4 border-2 border-amber-100">
                            <h4 class="font-bold text-gray-800">${s.nome}</h4>
                            <p class="text-amber-600 font-bold text-xs mb-6 mt-1">R$ ${s.vista.toFixed(2)}</p>
                            <button onclick="prepararVenda('${id}')" class="w-full py-3 bg-gray-900 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest">Selecionar</button>
                        </div>
                    `;
                }
            }
            lucide.createIcons();
        }

        function filtrarServicos() { renderServicos(document.getElementById('buscaServico').value); }

        // --- VENDAS ---
        function prepararVenda(id) {
            const s = servicosData[id];
            document.getElementById('hiddenId').value = id;
            document.getElementById('nomeServicoSelecionado').innerText = s.nome;
            document.getElementById('valorFinal').value = s.vista;
            openModal('modalRealizar');
        }

        function atualizarPrecoVenda() {
            const id = document.getElementById('hiddenId').value;
            const m = document.getElementById('metodoPagamento').value;
            document.getElementById('valorFinal').value = m === 'vista' ? servicosData[id].vista : servicosData[id].cartao;
        }

        function confirmarRealizacao() {
            const id = document.getElementById('hiddenId').value;
            const venda = {
                servicoNome: servicosData[id].nome,
                cliente: document.getElementById('cliNome').value || "Cliente VIP",
                valor: parseFloat(document.getElementById('valorFinal').value),
                metodo: document.getElementById('metodoPagamento').value,
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                timestamp: Date.now()
            };
            db.ref(`vendas_dia/${getHoje()}`).push(venda);
            closeModal('modalRealizar');
            document.getElementById('cliNome').value = '';
        }

        db.ref(`vendas_dia/${getHoje()}`).on('value', snapshot => {
            const vendas = snapshot.val() || {};
            const tabela = document.getElementById('tabelaHoje');
            let total = 0, qtd = 0;
            tabela.innerHTML = '';
            for (let id in vendas) {
                const v = vendas[id];
                total += v.valor; qtd++;
                tabela.innerHTML += `
                    <tr class="hover:bg-gray-50/80 transition group">
                        <td class="px-10 py-6 text-gray-400 text-xs font-bold">${v.hora}</td>
                        <td class="px-10 py-6 text-sm font-bold text-gray-800">${v.cliente}</td>
                        <td class="px-10 py-6 text-sm text-gray-500">${v.servicoNome}</td>
                        <td class="px-10 py-6 text-right font-bold text-gray-900">R$ ${v.valor.toFixed(2)}</td>
                        <td class="px-6 py-6 text-center">
                            <button onclick="excluirVenda('${id}')" class="btn-delete hover:text-red-600 transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('saldoDia').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('contagemServicos').innerText = qtd;
            lucide.createIcons();
        });

        function excluirVenda(id, dataRef = null) {
            const path = dataRef ? `historico_fechamentos/${dataRef}/${id}` : `vendas_dia/${getHoje()}/${id}`;
            if(confirm("Confirmar exclusão?")) db.ref(path).remove();
        }

        // --- HISTÓRICO INTELIGENTE ---
        let historicoCompleto = {};
        db.ref('historico_fechamentos').on('value', snapshot => {
            historicoCompleto = snapshot.val() || {};
            renderHistorico();
        });

        function renderHistorico(filtro = "") {
            const container = document.getElementById('containerHistoricoAnterior');
            container.innerHTML = '';

            Object.keys(historicoCompleto).reverse().forEach(dataISO => {
                const dataBR = dataISO.split('-').reverse().join('/');
                if (filtro && !dataBR.includes(filtro)) return;

                const vendas = historicoCompleto[dataISO];
                const totalDia = Object.values(vendas).reduce((a, b) => a + (b.valor || 0), 0);
                const qtd = Object.keys(vendas).length;
                const diaSemana = getDiaSemana(dataISO);

                let itensHTML = '';
                Object.keys(vendas).forEach(idV => {
                    const v = vendas[idV];
                    itensHTML += `
                        <div class="flex justify-between items-center py-4 border-b border-gray-50 group">
                            <span class="text-xs font-semibold text-gray-400">${v.hora} - <span class="text-gray-800 font-bold">${v.cliente}</span> (${v.servicoNome})</span>
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-bold">R$ ${v.valor.toFixed(2)}</span>
                                <button onclick="excluirVenda('${idV}', '${dataISO}')" class="text-red-200 hover:text-red-500 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML += `
                    <div class="hist-card bg-gray-50 rounded-[30px] border border-gray-100 overflow-hidden transition-all hover:border-amber-200" id="card-${dataISO}">
                        <div class="p-8 flex justify-between items-center cursor-pointer" onclick="toggleCard('card-${dataISO}')">
                            <div class="flex items-center gap-6">
                                <div class="bg-white w-14 h-14 rounded-2xl flex flex-col items-center justify-center shadow-sm">
                                    <span class="text-[10px] font-bold text-amber-600 uppercase">${diaSemana.slice(0,3)}</span>
                                    <span class="text-sm font-black text-gray-800">${dataBR.split('/')[0]}</span>
                                </div>
                                <div>
                                    <p class="brand-font text-lg text-gray-800 tracking-widest">${dataBR}</p>
                                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">${qtd} atendimentos</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-8">
                                <p class="text-xl font-light text-gray-900 tracking-tighter">R$ ${totalDia.toFixed(2)}</p>
                                <button onclick="event.stopPropagation(); gerarPDFLuxo('${dataISO}')" class="p-3 bg-white text-amber-600 rounded-full shadow-sm hover:bg-amber-600 hover:text-white transition-all shadow-amber-100">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                </button>
                                <i data-lucide="chevron-down" class="arrow-icon text-gray-300 transition-transform"></i>
                            </div>
                        </div>
                        <div class="hist-details px-8 bg-white/50">
                            <div class="py-6 space-y-2">
                                ${itensHTML}
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function toggleCard(id) { document.getElementById(id).classList.toggle('active'); }
        function filtrarHistorico(v) { renderHistorico(v); }

        function finalizarDia() {
            const data = getHoje();
            db.ref(`vendas_dia/${data}`).once('value', snapshot => {
                if(!snapshot.exists()) return alert("Sem vendas hoje!");
                if(confirm("Deseja encerrar o expediente e arquivar?")) {
                    db.ref(`historico_fechamentos/${data}`).set(snapshot.val())
                      .then(() => db.ref(`vendas_dia/${data}`).remove());
                }
            });
        }

        // --- GERADOR DE PDF DE LUXO ---
        function gerarPDFLuxo(dataISO) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const vendas = historicoCompleto[dataISO];
            const dataBR = dataISO.split('-').reverse().join('/');
            const totalDia = Object.values(vendas).reduce((a, b) => a + (b.valor || 0), 0);

            // Cabeçalho Luxo
            doc.setFillColor(20, 20, 20);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(197, 160, 89);
            doc.setFont("cinzel", "bold");
            doc.setFontSize(26);
            doc.text("GIANDRA SILVA", 105, 25, { align: "center" });
            
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(10);
            doc.setFont("montserrat", "normal");
            doc.text(`RELATÓRIO DE FECHAMENTO - ${dataBR} (${getDiaSemana(dataISO)})`, 105, 33, { align: "center" });

            // Tabela de Itens
            const corpoTabela = Object.values(vendas).map(v => [v.hora, v.cliente, v.servicoNome, v.metodo.toUpperCase(), `R$ ${v.valor.toFixed(2)}`]);
            
            doc.autoTable({
                startY: 50,
                head: [['HORA', 'CLIENTE', 'PROCEDIMENTO', 'PAGAMENTO', 'VALOR']],
                body: corpoTabela,
                theme: 'striped',
                headStyles: { fillGray: 240, textColor: [166, 124, 55], fontStyle: 'bold' },
                styles: { font: 'montserrat', fontSize: 9 },
                columnStyles: { 4: { halign: 'right', fontStyle: 'bold' } }
            });

            // Rodapé com Totais
            const finalY = doc.lastAutoTable.finalY + 15;
            doc.setDrawColor(197, 160, 89);
            doc.line(120, finalY, 190, finalY);
            
            doc.setTextColor(100);
            doc.text("Total de Atendimentos:", 120, finalY + 10);
            doc.text(`${Object.keys(vendas).length}`, 190, finalY + 10, { align: "right" });
            
            doc.setTextColor(0);
            doc.setFontSize(14);
            doc.text("FATURAMENTO TOTAL:", 120, finalY + 20);
            doc.setTextColor(166, 124, 55);
            doc.text(`R$ ${totalDia.toFixed(2)}`, 190, finalY + 20, { align: "right" });

            doc.save(`Relatorio_GiandraSilva_${dataISO}.pdf`);
        }
    </script>
</body>
</html>
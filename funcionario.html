<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal do Funcionário</title>
<style>
:root{
  --verde:#00c98d;
  --verde-escuro:#00996a;
  --fundo:#f4f9f6;
  --branco:#ffffff;
  --texto:#1b1b1b;
  --muted:#7b8a87;
  --sombra:0 4px 25px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:"Inter",Roboto,Arial,sans-serif}
body{
  background:linear-gradient(180deg,var(--fundo),#ecf6f1);
  display:flex;
  flex-direction:column;
  height:100vh;
  color:var(--texto);
  overflow:hidden;
}
header{
  background:var(--branco);
  padding:14px 22px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:var(--sombra);
  position:fixed;
  width:100%;
  top:0;
  z-index:10;
}
header img{
  height:48px;
  border-radius:10px;
  object-fit:cover;
}
header h1{
  font-size:20px;
  font-weight:600;
  color:var(--verde-escuro);
  letter-spacing:.3px;
}
.chat-area{
  flex:1;
  padding:90px 16px 95px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  background:var(--fundo);
}
.message{
  max-width:85%;
  margin:10px;
  padding:16px 20px;
  border-radius:18px;
  line-height:1.6;
  font-size:16px;
  word-wrap:break-word;
  transition:.3s all;
}
.bot{
  align-self:flex-start;
  background:var(--branco);
  border:1px solid #cfe8db;
  box-shadow:0 3px 8px rgba(0,0,0,.05);
  color:var(--texto);
  border-top-left-radius:0;
}
.user{
  align-self:flex-end;
  background:var(--verde);
  color:#fff;
  box-shadow:0 3px 8px rgba(0,0,0,.08);
  border-top-right-radius:0;
}
.chat-input{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--branco);
  padding:16px 18px;
  display:flex;
  align-items:center;
  gap:12px;
  box-shadow:0 -4px 15px rgba(0,0,0,.05);
  border-top:1px solid #dce7e0;
}
.chat-input input{
  flex:1;
  padding:18px 22px;
  border:1px solid #bfe0cf;
  border-radius:40px;
  font-size:18px;
  outline:none;
  transition:border .3s, box-shadow .3s;
}
.chat-input input:focus{
  border-color:var(--verde);
  box-shadow:0 0 8px rgba(0,201,141,0.3);
}
.chat-input button{
  background:var(--verde);
  border:0;
  color:#fff;
  padding:14px 26px;
  border-radius:40px;
  cursor:pointer;
  font-size:16px;
  font-weight:500;
  transition:background .3s, transform .2s, box-shadow .2s;
}
.chat-input button:hover{
  background:var(--verde-escuro);
  transform:scale(1.05);
  box-shadow:0 3px 10px rgba(0,153,106,0.3);
}
.typing{
  display:flex;
  align-items:center;
  margin:10px 18px;
  gap:6px;
}
.typing span{
  height:10px;width:10px;
  background:#a8bfb2;
  border-radius:50%;
  animation:bounce 1.4s infinite ease-in-out both;
}
.typing span:nth-child(1){animation-delay:-0.32s}
.typing span:nth-child(2){animation-delay:-0.16s}
@keyframes bounce{
  0%,80%,100%{transform:scale(0)}
  40%{transform:scale(1)}
}
.doc{
  border:2px solid #bde6d2;
  background:#fff;
  padding:18px 20px;
  border-radius:14px;
  margin:12px 10px;
  box-shadow:var(--sombra);
  transition:all .3s;
}
.doc:hover{transform:translateY(-2px)}
.doc p{margin:6px 0;font-size:15px;color:#333}
.download-btn{
  background:var(--verde);
  color:#fff;
  border:0;
  padding:11px 16px;
  border-radius:10px;
  cursor:pointer;
  margin-top:12px;
  font-size:15px;
  font-weight:500;
  transition:background .3s, transform .2s;
}
.download-btn:hover{
  background:var(--verde-escuro);
  transform:scale(1.05);
}
.spinner{
  border:4px solid #eee;
  border-top:4px solid var(--verde);
  border-radius:50%;
  width:34px;height:34px;
  animation:spin 1s linear infinite;
  margin:18px auto;
}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.signature-pad{
  border:2px solid #bbb;
  border-radius:8px;
  background:#fff;
  margin-top:12px;
  width:100%;
  height:180px;
  touch-action:none;
}
.sign-btn{
  margin-top:12px;
  padding:10px 18px;
  background:var(--verde);
  color:#fff;
  border:0;
  border-radius:8px;
  cursor:pointer;
  font-size:15px;
}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background:#bcd2c6;border-radius:10px}
::-webkit-scrollbar-thumb:hover{background:#a5c3b3}
@media (max-width:600px){
  header h1{font-size:18px}
  .message{font-size:15px}
  .chat-input input{font-size:16px}
  .chat-input button{font-size:15px;padding:13px 22px}
}
</style>
</head>
<body>

<header>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjM8laYM9og0h4685t14OeuLxVCdko1f6TJsC6UlTmis7Grf7tYzY_n3s9M8S1Y2VP_dPvpj4wVBOmSCn9MBL49ce_-apvf6BNeTydFF3n1xUcA1VNhT_RtgZ4OJOm4cC7tz7wrNC8z4pi4fMHw5Ei-W0FllK4eI5vP1lEaNtTCnIMawvTgW35FRf-XP_0/s711/22B49C44-6D22-4F0B-857A-E185F8E083B9.jpeg" alt="logo">
  <h1></h1>
</header>

<div class="chat-area" id="chat">
  <div class="message bot">Olá 👋 Digite seu CPF para buscar as credenciais do funcionário ou alterar telefone.</div>
</div>

<div class="chat-input">
  <input type="text" id="msg" placeholder="Digite aqui..." />
  <button id="sendBtn">Enviar</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
const firebaseConfig={
  apiKey:"AIzaSyBPiznHCVkTAgx6m02bZB8b0FFaot9UkBU",
  authDomain:"prefeitura-de-joao-camara.firebaseapp.com",
  projectId:"prefeitura-de-joao-camara",
  storageBucket:"prefeitura-de-joao-camara.firebasestorage.app",
  messagingSenderId:"269299041577",
  appId:"1:269299041577:web:fd41b2939240e9eb476338",
  measurementId:"G-YT7NHR342J"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const chat=document.getElementById("chat");
const msg=document.getElementById("msg");
const sendBtn=document.getElementById("sendBtn");
let step="cpf"; 
let currentEmp=null;
let phoneFlow=false;
let phoneCode=null;
let signatureImage=null;
function randomId(){
  const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  return Array.from({length:18},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

function addMsg(t,s){
  const d=document.createElement("div");
  d.className=`message ${s}`;
  d.innerHTML=t;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}
function typing(){
  const d=document.createElement("div");
  d.className="typing";
  d.innerHTML="<span></span><span></span><span></span>";
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
  return d;
}

sendBtn.onclick=async()=>{
  const t=msg.value.trim();if(!t)return;
  addMsg(t,"user");msg.value="";
  const load=typing();
  await new Promise(r=>setTimeout(r,1200));
  load.remove();

  if(step==="cpf" && !phoneFlow){
    const cpf=t.replace(/\D/g,'');
    const snap=await db.ref("employees").orderByChild("cpf").equalTo(cpf).once("value");
    if(!snap.exists()){addMsg("CPF não encontrado, tente novamente.","bot");return}
    const val=Object.entries(snap.val())[0];
    const id=val[0],data=val[1];
    currentEmp={id,...data};
    showDoc(data);
    addMsg("Para alterar o telefone digite 'alterar telefone'. Para consultar cargas horárias digite 'consultar'.","bot");
    step="opts";
  } 
  else if(step==="opts" && !phoneFlow){
    if(t.toLowerCase().includes("consultar")){
      addMsg("Digite o mês e o ano no formato MM/AAAA para consultar.","bot");
      step="mesano";
    } else if(t.toLowerCase().includes("alterar telefone")){
      phoneFlow=true;
      phoneCode=Math.floor(100000+Math.random()*900000);
      addMsg(`Digite o novo número de telefone. Você precisará confirmar o código ${phoneCode} e seu CPF no final.`,"bot");
      step="phoneInput";
    } else addMsg("Comando inválido.","bot");
  }
  else if(step==="mesano"){
    const [mes,ano]=t.split("/");
    if(!mes||!ano){addMsg("Formato inválido. Use MM/AAAA.","bot");return}
    const loading=document.createElement("div");
    loading.className="spinner";
    chat.appendChild(loading);
    chat.scrollTop=chat.scrollHeight;
    await new Promise(r=>setTimeout(r,1800));
    loading.remove();
    showHours(currentEmp.id,parseInt(mes),parseInt(ano));
    step="opts";
  }
  else if(step==="phoneInput"){
    const phone=t.trim();
    if(phone.length<8){addMsg("Telefone inválido.","bot");return}
    currentEmp.newPhone=phone;
    addMsg(`Digite o código de 6 dígitos para confirmar: <b>${phoneCode}</b>`,"bot");
    step="phoneCode";
  }
  else if(step==="phoneCode"){
    if(t!==String(phoneCode)){addMsg("Código incorreto.","bot");return}
    addMsg("Digite seu CPF para confirmar a alteração.","bot");
    step="phoneCpf";
  }
  else if(step==="phoneCpf"){
    const cpfConfirm=t.replace(/\D/g,'');
    if(cpfConfirm!==currentEmp.cpf){addMsg("CPF incorreto.","bot");return}
    showSignatureTerm();
  }
};

function showSignatureTerm(){
  const termDiv=document.createElement("div");
  termDiv.className="doc";
  termDiv.innerHTML=`
    <p>Declaro, para os devidos fins, que eu, <b>${currentEmp.name}</b>, portador do CPF <b>${currentEmp.cpf}</b>, autorizo formalmente a atualização do meu número de telefone cadastrado no sistema institucional.</p>
    <canvas id="signaturePad" class="signature-pad"></canvas>
    <button class="sign-btn" id="confirmSign">Concluir</button>
  `;
  chat.appendChild(termDiv);
  chat.scrollTop=chat.scrollHeight;

  const canvas=termDiv.querySelector("#signaturePad");
  const ctx=canvas.getContext("2d");
  let drawing=false;
  function start(e){drawing=true;draw(e)}
  function stop(){drawing=false;ctx.beginPath()}
  function draw(e){
    if(!drawing)return;
    e.preventDefault();
    const rect=canvas.getBoundingClientRect();
    const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
    const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
    ctx.lineWidth=2;
    ctx.lineCap="round";
    ctx.strokeStyle="#000";
    ctx.lineTo(x,y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x,y);
  }
  canvas.addEventListener("mousedown",start);
  canvas.addEventListener("mouseup",stop);
  canvas.addEventListener("mousemove",draw);
  canvas.addEventListener("touchstart",start);
  canvas.addEventListener("touchend",stop);
  canvas.addEventListener("touchmove",draw);

  termDiv.querySelector("#confirmSign").onclick=async()=>{
    signatureImage=canvas.toDataURL("image/png");
    const docId=randomId();
    const loading=document.createElement("div");
    loading.className="spinner";
    chat.appendChild(loading);
    chat.scrollTop=chat.scrollHeight;
    await new Promise(r=>setTimeout(r,2000));
    loading.remove();
    await db.ref("employees/"+currentEmp.id).update({phone: currentEmp.newPhone, updatedAt: Date.now()});
    addMsg(`✅ Telefone atualizado com sucesso!<br><small>ID do Documento: <b>${docId}</b></small>`,"bot");
    phoneFlow=false; step="opts";
    currentEmp.phone=currentEmp.newPhone;
    showDoc(currentEmp,docId);
  };
}

function showDoc(d,docId){
  const div=document.createElement("div");
  div.className="doc";
  div.innerHTML=`
  <p><b>Nome:</b> ${d.name}</p>
  <p><b>Função:</b> ${d.role}</p>
  <p><b>Telefone:</b> ${d.phone||'-'}</p>
  <p><b>CPF:</b> ${d.cpf||'-'}</p>
  <p><b>Série:</b> ${d.serial}</p>
  ${docId?`<p><b>ID do Documento:</b> ${docId}</p>`:""}
  <button class="download-btn">Baixar PDF</button>`;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  div.querySelector(".download-btn").onclick=()=>{
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF();
    doc.text("Comprovante de Alteração",20,20);
    doc.text(`Nome: ${d.name}`,20,40);
    doc.text(`Função: ${d.role}`,20,50);
    doc.text(`CPF: ${d.cpf}`,20,60);
    doc.text(`Série: ${d.serial}`,20,70);
    doc.text(`Telefone: ${d.phone||'-'}`,20,80);
    if(docId) doc.text(`ID do Documento: ${docId}`,20,90);
    if(signatureImage){
      doc.addImage(signatureImage,"PNG",20,100,40,20);
    }
    doc.save("comprovante.pdf");
  };
}

async function showHours(empId,mes,ano){
  const snap=await db.ref("attendance").orderByChild("employeeId").equalTo(empId).once("value");
  const all=snap.val()||{};const arr=[];
  for(const[k,v]of Object.entries(all)){
    if(v.startTime){
      const dt=new Date(v.startTime);
      if(dt.getMonth()+1===mes&&dt.getFullYear()===ano)arr.push(v);
    }
  }
  if(!arr.length){addMsg("Nenhum registro neste mês.","bot");return}
  let totalMs=0;let txt="📅 Registros:\n";
  arr.forEach(v=>{
    const ini=new Date(v.startTime);
    const fim=new Date(v.endTime||v.startTime);
    const dur=(v.durationMs||fim-ini);
    totalMs+=dur;
    txt+=`\n${ini.toLocaleDateString()} • ${ini.toLocaleTimeString()} às ${fim.toLocaleTimeString()} (${formatDur(dur)})`;
  });
  const total=totalMs/(1000*3600);
  txt+=`\n\nTotal: ${formatDur(totalMs)} (${total.toFixed(2)}h)`;
  addMsg(txt,"bot");
}

function formatDur(ms){
  const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60);
  return `${h}h ${m}m`;
}
</script>
</body>
</html>

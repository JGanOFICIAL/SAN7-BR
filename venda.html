<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Vendas - SAN7</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
    }

    header {
      background-color: #0d1b2a;
      color: white;
      padding: 15px 30px;
      font-size: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .saldo {
      font-size: 18px;
      display: flex;
      align-items: center;
    }

    .saldo span {
      margin-left: 8px;
      background-color: #fff;
      color: #0d1b2a;
      padding: 3px 8px;
      border-radius: 4px;
    }

    #finalizarDia {
      margin: 15px 30px 10px;
      background-color: crimson;
      color: white;
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #busca {
      margin: 15px 30px 0;
      padding: 10px;
      width: calc(100% - 60px);
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    table {
      width: 95%;
      margin: 15px auto;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }

    th {
      background-color: #0d1b2a;
      color: white;
    }

    .btn {
      padding: 6px 10px;
      background-color: #0d1b2a;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .alerta {
      color: red;
      font-weight: bold;
    }

    .produto-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .modal-content button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .btn-vista {
      background-color: #28a745;
      color: white;
    }

    .btn-cartao {
      background-color: #007bff;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <div>Vendas - SAN7</div>
    <div class="saldo">Saldo: R$ <span id="saldoDia">0.00</span></div>
  </header>

  <input type="text" id="busca" placeholder="Pesquisar por nome ou marca...">

  <button id="finalizarDia">Finalizar Dia</button>

  <table>
    <thead>
      <tr>
        <th>Imagem</th>
        <th>Produto</th>
        <th>Marca</th>
        <th>À Vista</th>
        <th>Cartão</th>
        <th>Estoque</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody id="tabelaProdutos"></tbody>
  </table>

  <div class="modal" id="modalVenda">
    <div class="modal-content">
      <h3>Escolha a forma de pagamento</h3>
      <p id="nomeProduto"></p>
      <button class="btn-vista" onclick="confirmarVenda('avista')">À Vista</button>
      <button class="btn-cartao" onclick="confirmarVenda('cartao')">Cartão</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBs2GrFPGib7Nz02F03Eeo5DTW-8OTJmFI",
      authDomain: "san7-2b351.firebaseapp.com",
      databaseURL: "https://san7-2b351-default-rtdb.firebaseio.com",
      projectId: "san7-2b351",
      storageBucket: "san7-2b351.appspot.com",
      messagingSenderId: "511547914036",
      appId: "1:511547914036:web:0595e39aef88258c649761"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tabela = document.getElementById('tabelaProdutos');
    const saldoDia = document.getElementById('saldoDia');
    const finalizarBtn = document.getElementById('finalizarDia');
    const modal = document.getElementById('modalVenda');
    const nomeProdutoModal = document.getElementById('nomeProduto');
    const campoBusca = document.getElementById('busca');

    let saldo = 0;
    let vendas = [];
    let produtoSelecionado = null;
    let todosProdutos = [];

    function carregarSaldoTemp() {
      db.ref('temporario/saldo').once('value').then(snapshot => {
        const dados = snapshot.val();
        if (dados) {
          saldo = dados.saldo || 0;
          vendas = dados.vendas || [];
          saldoDia.textContent = saldo.toFixed(2);
        }
      });
    }

    function salvarSaldoTemp() {
      db.ref('temporario/saldo').set({ saldo, vendas });
    }

    function limparSaldoTemp() {
      db.ref('temporario/saldo').remove();
    }

    function exibirProdutos(produtos) {
      tabela.innerHTML = '';

      if (produtos.length === 0) {
        tabela.innerHTML = '<tr><td colspan="7">Nenhum produto encontrado.</td></tr>';
        return;
      }

      produtos.forEach(produto => {
        const alertaEstoque = produto.estoque <= 3 ? ' <span class="alerta">[Estoque baixo]</span>' : '';
        const imagemHTML = produto.imagem ? `<img src="${produto.imagem}" class="produto-img">` : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${imagemHTML}</td>
          <td>${produto.nome}</td>
          <td>${produto.marca}</td>
          <td>R$ ${produto.precoVista?.toFixed(2) || '0.00'}</td>
          <td>R$ ${produto.precoCartao?.toFixed(2) || '0.00'}</td>
          <td>${produto.estoque}${alertaEstoque}</td>
          <td><button class="btn" onclick="abrirModal('${produto.id}')">VENDER</button></td>
        `;
        tabela.appendChild(tr);
      });
    }

    function carregarProdutos() {
      db.ref('produtos').on('value', snapshot => {
        todosProdutos = [];

        snapshot.forEach(child => {
          const produto = child.val();
          produto.id = child.key;
          todosProdutos.push(produto);
        });

        exibirProdutos(todosProdutos);
      });
    }

    campoBusca.addEventListener('input', () => {
      const termo = campoBusca.value.toLowerCase();

      const filtrados = todosProdutos.filter(produto =>
        produto.nome.toLowerCase().includes(termo) ||
        produto.marca.toLowerCase().includes(termo)
      );

      exibirProdutos(filtrados);
    });

    function abrirModal(id) {
      const produto = todosProdutos.find(p => p.id === id);
      if (produto && produto.estoque > 0) {
        produtoSelecionado = produto;
        nomeProdutoModal.textContent = `${produto.nome} - Estoque: ${produto.estoque}`;
        modal.style.display = 'flex';
      } else {
        alert("Produto sem estoque.");
      }
    }

    function confirmarVenda(tipo) {
      if (!produtoSelecionado) return;

      const ref = db.ref('produtos/' + produtoSelecionado.id);
      ref.once('value').then(snapshot => {
        const produto = snapshot.val();
        if (produto.estoque <= 0) {
          alert("Produto sem estoque!");
          modal.style.display = 'none';
          return;
        }

        const valor = tipo === 'avista' ? produto.precoVista : produto.precoCartao;
        saldo += valor;
        saldoDia.textContent = saldo.toFixed(2);
        vendas.push({ id: produtoSelecionado.id, tipo, valor });

        ref.update({ estoque: produto.estoque - 1 });
        salvarSaldoTemp();
        modal.style.display = 'none';
      });
    }

    finalizarBtn.onclick = () => {
      if (vendas.length === 0) {
        alert("Nenhuma venda realizada!");
        return;
      }

      const agora = new Date();
      const data = agora.toLocaleDateString();
      const hora = agora.toLocaleTimeString();

      const historico = {
        data,
        hora,
        saldo,
        vendas
      };

      const novaChave = db.ref().child('historico').push().key;
      db.ref('historico/' + novaChave).set(historico).then(() => {
        limparSaldoTemp();
        window.location.href = 'historico.html';
      });
    };

    carregarProdutos();
    carregarSaldoTemp();
  </script>

  <div class="botoes-fixos" style="position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999;">
    <a href="index.html" style="background-color:#0077cc;color:white;padding:12px 20px;border:none;border-radius:25px;font-size:14px;text-align:center;text-decoration:none;box-shadow:0 4px 8px rgba(0,0,0,0.2);font-weight:bold;">Voltar</a>
    <a href="historico.html" style="background-color:#0077cc;color:white;padding:12px 20px;border:none;border-radius:25px;font-size:14px;text-align:center;text-decoration:none;box-shadow:0 4px 8px rgba(0,0,0,0.2);font-weight:bold;">Histórico</a>
  </div>

  <style>
    .faixa-numero {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 40px;
      background-color: rgba(255, 255, 255, 0.2);
      overflow: hidden;
      z-index: 9999;
      pointer-events: none;
    }

    .texto-numero {
      position: absolute;
      white-space: nowrap;
      font-size: 20px;
      font-weight: bold;
      color: rgba(0, 0, 0, 0.3);
      animation: deslizar 5s linear infinite;
    }

    @keyframes deslizar {
      0% { left: 100%; }
      100% { left: -100%; }
    }
  </style>

  <div class="faixa-numero">
    <div class="texto-numero">SAN7 TECNOLOGIA - 84 99177-8690</div>
  </div>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jpfelix Tecnologia — Admin</title>
<style>
  :root{--gold:#c69c26;--gold-dark:#a17814;--bg:#fff;--muted:#666;--radius:12px;font-family:Inter,system-ui,Arial}
  body{margin:0;background:linear-gradient(180deg,#fff,#fffaf0);min-height:100vh}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:20px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:#fff;cursor:pointer}
  .search{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)}
  .list{margin-top:14px}
  .shop{background:#fff;border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.03);display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .shop .meta{display:flex;gap:12px;align-items:center}
  .small-muted{font-size:13px;color:var(--muted)}
  .modal{background:#fff;padding:20px;border-radius:12px;max-width:760px;box-shadow:0 20px 50px rgba(0,0,0,0.15)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
</style>
</head>
<body>
  <div class="wrap">
    <header>




<style>
  .mini-img {
    display: inline-block;
    width: 60px; /* ajuste o tamanho aqui */
    height: auto;
  }
</style>

<img class="mini-img" src="https://826d3d7dee.cbaul-cdnwnd.com/62fd26f239c381f07684529cff4b51b2/200000057-0b5110b513/450/AA04E86A-543C-453C-A626-30C72864BE27.webp" alt="Imagem Incorporada">





      

      <div class="controls">
        <input id="searchShop" class="search" placeholder="Pesquisar loja..." />
        <button id="btnNew" class="btn">Cadastrar Loja</button>
      </div>
    </header>

    <div style="margin-top:12px" class="small-muted">JP FELIX TECNOLOGIA - DESDE 2018</div>
    <div id="shopsList" class="list"></div>

    <!-- Modals -->
    <div id="overlayNew" class="overlay">
      <div class="modal">
        <h3>Cadastrar Loja</h3>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newShopName" placeholder="Nome visível da loja" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd"/>
          <input id="newShopEmail" placeholder="E-mail (login)" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd"/>
          <input id="newShopPass" placeholder="Senha" style="width:160px;padding:10px;border-radius:8px;border:1px solid #ddd"/>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="cancelNew" class="btn" style="background:#eee;color:#111">Cancelar</button>
          <button id="createNew" class="btn">Criar loja</button>
        </div>
      </div>
    </div>

    <div id="overlayDetail" class="overlay">
      <div class="modal" id="detailModal"></div>
    </div>

  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBs2GrFPGib7Nz02F03Eeo5DTW-8OTJmFI",
  authDomain: "san7-2b351.firebaseapp.com",
  databaseURL: "https://san7-2b351-default-rtdb.firebaseio.com",
  projectId: "san7-2b351",
  storageBucket: "san7-2b351.appspot.com",
  messagingSenderId: "511547914036",
  appId: "1:511547914036:web:0595e39aef88258c649761"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* UI refs */
const shopsList = document.getElementById('shopsList');
const searchShop = document.getElementById('searchShop');
const btnNew = document.getElementById('btnNew');
const overlayNew = document.getElementById('overlayNew');
const cancelNew = document.getElementById('cancelNew');
const createNew = document.getElementById('createNew');
const newShopName = document.getElementById('newShopName');
const newShopEmail = document.getElementById('newShopEmail');
const newShopPass = document.getElementById('newShopPass');
const overlayDetail = document.getElementById('overlayDetail');
const detailModal = document.getElementById('detailModal');

let shopsCache = {};

/* load shops (users data) from a 'shops' root (we'll maintain convenience listing there) */
db.ref('shops').on('value', snap=>{
  shopsCache = snap.val() || {};
  renderShops();
});

/* render */
function renderShops(){
  shopsList.innerHTML = '';
  const q = (searchShop.value||'').toLowerCase();
  const keys = Object.keys(shopsCache);
  if(keys.length===0){ shopsList.innerHTML = '<div class="small-muted">Nenhuma loja cadastrada</div>'; return;}
  keys.forEach(k=>{
    const s = shopsCache[k];
    const label = (s.displayName || s.email || '');
    if(q && !label.toLowerCase().includes(q)) return;
    const el = document.createElement('div');
    el.className = 'shop';
    el.innerHTML = `<div class="meta"><div style="width:44px;height:44;border-radius:8px;background:linear-gradient(135deg,#c69c26,#a17814);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${(s.displayName||'LO').slice(0,2).toUpperCase()}</div>
                    <div>
                      <div style="font-weight:700">${escapeHtml(s.displayName||'Sem nome')}</div>
                      <div class="small-muted">${escapeHtml(s.email||'—')}</div>
                    </div></div>
                    <div style="display:flex;gap:8px;align-items:center">
                      <div class="small-muted" id="balance-${k}">Saldo: —</div>
                      <button class="btn" data-k="${k}" data-action="view">Abrir</button>
                      <button class="btn" data-k="${k}" data-action="del" style="background:#ff6b6b">Excluir</button>
                    </div>`;
    shopsList.appendChild(el);
    // attach realtime listener for currentBalance
    db.ref('users/'+k+'/currentBalance').on('value', snap=>{
      const elb = document.getElementById('balance-'+k);
      if(elb) elb.textContent = 'Saldo: ' + formatCurrency(snap.val() || 0);
    });
  });
}

function formatCurrency(n){
  return (Number(n || 0)).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

/* New shop modal */
btnNew.addEventListener('click', ()=> overlayNew.style.display='flex');
cancelNew.addEventListener('click', ()=> overlayNew.style.display='none');

createNew.addEventListener('click', async ()=>{
  const name = newShopName.value.trim();
  const email = newShopEmail.value.trim();
  const pass = newShopPass.value.trim();
  if(!name || !email || !pass){ alert('Preencha nome, e-mail e senha'); return; }
  // Create an auth user via Admin SDK would be ideal — but in-browser we can create user by signing in anonymously,
  // creating user, then sign back. Workaround: use createUserWithEmailAndPassword (requires current app to have permissions).
  try{
    const userCred = await auth.createUserWithEmailAndPassword(email, pass);
    const newUid = userCred.user.uid;
    // create convenience shops index and user root
    await db.ref('shops/'+newUid).set({
      displayName: name,
      email: email,
      createdAt: Date.now()
    });
    // initialize user data
    await db.ref('users/'+newUid).set({
      currentBalance: 0,
      products: {},
      todaySales: {},
      history: {}
    });
    alert('Loja criada com sucesso. Agora é possível fazer login com o e-mail criado.');
    newShopName.value='';newShopEmail.value='';newShopPass.value='';
    overlayNew.style.display='none';
  } catch(err){
    console.error(err);
    alert('Erro ao criar loja. Talvez já exista este e-mail. Mensagem: ' + (err.message||err));
  }
});

/* Delegation for shop actions */
shopsList.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const k = btn.dataset.k;
  const action = btn.dataset.action;
  if(action === 'view'){
    // fetch realtime details and show modal (with history)
    const infoSnap = await db.ref('shops/'+k).once('value');
    const info = infoSnap.val() || {};
    const balanceSnap = await db.ref('users/'+k+'/currentBalance').once('value');
    const balance = balanceSnap.val() || 0;
    const histSnap = await db.ref('users/'+k+'/history').once('value');
    const hist = histSnap.val() || {};
    let html = `<h3>${escapeHtml(info.displayName || 'Loja')}</h3>
                <div class="small-muted">E-mail: ${escapeHtml(info.email||'—')}</div>
                <div style="margin-top:10px"><strong>Saldo atual:</strong> ${formatCurrency(balance)}</div>
                <div style="margin-top:12px"><h4>Histórico finalizados</h4></div>`;
    const days = Object.keys(hist || {}).sort((a,b)=>b.localeCompare(a));
    if(days.length===0){ html += '<div class="small-muted">Nenhum dia finalizado</div>'; }
    days.forEach(day=>{
      const d = hist[day];
      html += `<div style="padding:8px;border-bottom:1px dashed #eee;display:flex;justify-content:space-between"><div>${escapeHtml(day)}</div><div>${formatCurrency(d.total)}</div></div>`;
    });
    html += `<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="closeDetail" class="btn" style="background:#eee;color:#111">Fechar</button></div>`;
    detailModal.innerHTML = html;
    overlayDetail.style.display = 'flex';
    document.getElementById('closeDetail').addEventListener('click', ()=> overlayDetail.style.display='none');
  } else if(action === 'del'){
    if(!confirm('Excluir loja e todo histórico? Esta ação é irreversível.')) return;
    // remove from shops and users
    await db.ref('shops/'+k).remove();
    await db.ref('users/'+k).remove();
    alert('Loja removida.');
  }
});

/* search */
searchShop.addEventListener('input', ()=> renderShops());

/* close overlays clicking outside */
document.querySelectorAll('.overlay').forEach(o=>{
  o.addEventListener('click', e=>{ if(e.target===o) o.style.display='none'; });
});
</script>
</body>
</html>


<style>
  #loadingOverlay {
    position: fixed;
    inset: 0;
    background: rgba(255 255 255 / 0.6);
    backdrop-filter: blur(5px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.6s ease;
  }
  #loadingOverlay.hide {
    opacity: 0;
    pointer-events: none;
  }
  .spinner {
    width: 60px;
    height: 60px;
    border: 6px solid #d4af37;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
    box-shadow: 0 0 8px #d4af37aa;
  }
  @keyframes spin {
    to { transform: rotate(360deg);}
  }
  #progressBarContainer {
    width: 200px;
    height: 10px;
    background: #eee;
    border-radius: 5px;
    overflow: hidden;
    box-shadow: inset 0 0 5px #aaa;
  }
  #progressBar {
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, #d4af37, #f9e79f);
    border-radius: 5px;
    transition: width 0.1s linear;
  }
</style>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div id="progressBarContainer">
    <div id="progressBar"></div>
  </div>
</div>

<script>
  (function(){
    const overlay = document.getElementById('loadingOverlay');
    const bar = document.getElementById('progressBar');

    // Duration between 2000ms and 3000ms
    const duration = 2000 + Math.random() * 1000;
    const startTime = performance.now();

    function update(){
      const now = performance.now();
      let elapsed = now - startTime;
      if(elapsed > duration) elapsed = duration;

      const progress = (elapsed / duration) * 100;
      bar.style.width = progress + '%';

      if(elapsed < duration){
        requestAnimationFrame(update);
      } else {
        overlay.style.transition = 'opacity 0.8s ease';
        overlay.classList.add('hide');
        setTimeout(() => {
          overlay.remove();
        }, 800);
      }
    }
    requestAnimationFrame(update);
  })();
</script>

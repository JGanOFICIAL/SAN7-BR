<!-- admincall.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel Suporte — Central de Atendimento</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <link rel="stylesheet" href="admincall.css">
</head>
<body>
  <div class="wrap">
    <aside class="sidebar">
      <div class="brand">
        <img src="logo.png" alt="logo" />
        <h2>Painel Suporte</h2>
      </div>
      <div class="controls">
        <button id="btn-how" class="btn ghost">Como atender</button>
        <button id="btn-refresh" class="btn">Atualizar</button>
      </div>

      <div class="connection">
        <strong>Conexão</strong>
        <div id="admin-conn">—</div>
      </div>
    </aside>

    <main class="main">
      <header class="top">
        <h1>Solicitações em tempo real</h1>
        <div class="search">
          <input id="search" placeholder="Buscar por protocolo, nome ou CPF" />
        </div>
      </header>

      <section class="timeline" id="calls-list">
        <!-- items injected here -->
      </section>
    </main>
  </div>

  <!-- overlay tutorial -->
  <div id="how-modal" class="overlay hidden">
    <div class="overlay-card">
      <h2>Como atender</h2>
      <p>1. Saudações — fale pelo nome da pessoa: "Olá <span id="how-name"></span>, eu sou o suporte..."</p>
      <p>2. Verificar dados pessoais e objetivo.</p>
      <p>3. Resolver com calma, confirmar entendimento, encerrar educadamente.</p>
      <div class="actions">
        <button id="how-close" class="btn primary">Fechar</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    (function(){
      const callsList = document.getElementById('calls-list');
      const adminConn = document.getElementById('admin-conn');
      const btnHow = document.getElementById('btn-how');
      const howModal = document.getElementById('how-modal');
      const howClose = document.getElementById('how-close');
      const searchInput = document.getElementById('search');

      // show tutorial
      btnHow.addEventListener('click', ()=> howModal.classList.remove('hidden'));
      howClose.addEventListener('click', ()=> howModal.classList.add('hidden'));

      // monitor connection
      window.onConnectionStateChanged = (state)=>{
        adminConn.textContent = state ? 'ONLINE' : 'OFFLINE';
      };

      // listen for incoming calls (script.js provides 'onIncomingCalls' subscription)
      window.onIncomingCalls(async (snapshot) => {
        // snapshot is a map of callId -> callData
        callsList.innerHTML = '';
        const calls = Object.entries(snapshot || {}).sort((a,b)=> (b[1].createdAt||0) - (a[1].createdAt||0));
        for(const [callId, call] of calls){
          const el = document.createElement('div');
          el.className = 'callcard';
          el.innerHTML = `
            <div class="meta">
              <div><strong>${call.nomeCompleto}</strong></div>
              <div>CPF: ${call.cpf}</div>
              <div>Protocolo: ${call.protocol}</div>
              <div>Status: <span class="st">${call.status}</span></div>
              <div>Gerado: ${new Date(call.createdAt).toLocaleString()}</div>
            </div>
            <div class="actions">
              <button data-action="view" class="btn ghost">Ver</button>
              <button data-action="accept" class="btn primary">Atender</button>
              <button data-action="reject" class="btn warn">Recusar</button>
            </div>
          `;
          // bind actions
          el.querySelector('[data-action="view"]').addEventListener('click', ()=> {
            window.showModal(`Protocolo ${call.protocol}`, `Nome: ${call.nomeCompleto}\nCPF: ${call.cpf}\nCriado em: ${new Date(call.createdAt).toLocaleString()}`);
          });
          el.querySelector('[data-action="reject"]').addEventListener('click', async ()=>{
            await window.rejectCall(callId, {reason:'recusado_pelo_suporte'});
          });
          el.querySelector('[data-action="accept"]').addEventListener('click', async ()=>{
            // Accept and start WebRTC from admin side
            try{
              const pc = await window.acceptCall(callId, {agentName: 'Suporte'});
              // open small call panel
              openCallPanel(callId, call, pc);
            }catch(e){
              console.error(e);
              window.showModal('Erro', 'Falha ao aceitar a chamada: '+(e.message||e));
            }
          });

          callsList.appendChild(el);
        }
      });

      // open small in-page call panel for active call
      function openCallPanel(callId, callData, pc){
        const panel = document.createElement('div');
        panel.className = 'in-call-panel';
        panel.innerHTML = `
          <div><strong>Atendendo:</strong> ${callData.nomeCompleto} — ${callData.protocol}</div>
          <div class="in-actions">
            <button class="btn hangup">Desligar</button>
            <button class="btn ghost mute">Mudo</button>
          </div>
        `;
        panel.querySelector('.hangup').addEventListener('click', async ()=>{
          await window.endCall(callId, {reason:'desligado_pelo_suporte'});
          panel.remove();
        });
        panel.querySelector('.mute').addEventListener('click', ()=> {
          // toggle local mute for admin audio
          window.toggleAdminMute();
        });
        document.body.appendChild(panel);
      }

      // search
      searchInput.addEventListener('input', (e)=>{
        const q = e.target.value.toLowerCase().trim();
        // naive filter by hiding cards that don't match
        document.querySelectorAll('.callcard').forEach(card=>{
          const text = card.textContent.toLowerCase();
          card.style.display = text.includes(q) ? '' : 'none';
        });
      });

    })();
  </script>

  <style>
    /* Admin inline CSS for portability */
    :root{--bg:#f7fafc;--accent:#0b5cff;--muted:#6b7280;--danger:#ff4d4f}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:var(--bg);color:#0b1320}
    .wrap{display:flex;min-height:100vh}
    .sidebar{width:300px;background:#fff;border-right:1px solid #edf2f7;padding:20px}
    .brand img{width:48px;height:48px}
    .brand h2{margin:8px 0 16px}
    .controls{display:flex;gap:8px;margin-bottom:12px}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:#eef4ff;color:var(--accent);cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6eef8;color:var(--muted)}
    .btn.warn{background:#ffedd5;color:#7a3700}
    .main{flex:1;padding:20px}
    .top{display:flex;justify-content:space-between;align-items:center}
    .search input{padding:8px;border-radius:8px;border:1px solid #e6eef8}
    .timeline{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
    .callcard{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef4ff;display:flex;justify-content:space-between;align-items:center}
    .in-call-panel{position:fixed;right:20px;bottom:20px;background:#fff;padding:12px;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.12)}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center}
    .overlay-card{background:#fff;padding:18px;border-radius:12px;max-width:720px}
  </style>
</body>
</html>

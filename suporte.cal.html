<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Central de Atendimento — Suporte</title>

<style>
  :root{
    --accent:#0b74ff;
    --bg:#fff;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  body{margin:0;background:linear-gradient(180deg,#fbfdff,#ffffff);color:#071129}
  .wrap{max-width:1200px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:16px}
  .brand{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#00c2ff);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  h1{margin:0;font-size:20px}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}
  .left, .right{background:white;padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(10,18,34,0.06)}
  .list{display:flex;flex-direction:column;gap:10px;max-height:72vh;overflow:auto;padding-right:6px}
  .callCard{padding:12px;border-radius:10px;border:1px solid #f1f6ff;background:linear-gradient(180deg,#fff,#fbfdff);display:flex;flex-direction:column;gap:8px}
  .callCard .meta{display:flex;align-items:center;gap:8px}
  .callCard .meta .protocol{font-weight:700}
  .callCard .actions{display:flex;gap:8px;margin-top:6px}
  .btn{padding:10px;border-radius:10px;border:0;cursor:pointer}
  .btn.accept{background:var(--accent);color:white}
  .btn.reject{background:#ff4757;color:white}
  .btn.small{padding:8px 10px;font-size:13px}
  .right .details{display:flex;flex-direction:column;gap:8px}
  .large{font-size:18px;font-weight:700}
  .muted{color:#748096;font-size:13px}
  .row{display:flex;gap:8px;align-items:center}
  .timeline{margin-top:10px;display:flex;flex-direction:column;gap:6px}
  .howto{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .howto .card{background:white;padding:18px;border-radius:12px;max-width:720px}
  .ping{margin-left:auto;padding:6px 10px;border-radius:999px;background:#f0f7ff;color:var(--accent);font-weight:700}
  @media (max-width:900px){ .layout{grid-template-columns:1fr} }
</style>

</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">SUP</div>
      <div>
        <h1>Painel de Suporte</h1>
        <div class="muted">Atenda as solicitações em tempo real — fale o nome da pessoa no início</div>
      </div>
      <div style="margin-left:auto" class="ping" id="adminPing">ping: --</div>
    </header>

    <div class="layout">
      <div class="left">
        <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
          <strong>Fila de espera</strong>
          <div>
            <button class="btn small" id="btnHow">Como atender</button>
          </div>
        </div>
        <div class="list" id="callsList">
          <!-- cards here -->
        </div>
      </div>

      <div class="right">
        <div class="details" id="detailPanel">
          <div class="muted">Selecione um chamado à esquerda</div>
        </div>
      </div>
    </div>
  </div>

  <!-- overlay howto -->
  <div class="howto" id="howOverlay">
    <div class="card">
      <h3>Como atender</h3>
      <p class="muted">Passos rápidos para um atendimento de qualidade:</p>
      <ol>
        <li>Saúde e simpatia: cumprimente pelo nome completo. "Olá, [Nome]. Meu nome é [seu nome], em que posso ajudar?"</li>
        <li>Mantenha microfone próximo; fale devagar e escute atentamente.</li>
        <li>Confirme dados: <strong>CPF</strong> e solicitações.</li>
        <li>Se precisar transferir, explique o motivo.</li>
        <li>Finalize confirmando entendimento e encerrando cordialmente.</li>
      </ol>
      <div style="text-align:right;margin-top:12px">
        <button class="btn" id="closeHow">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs e script.js -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="script.js"></script>

  <script>
    (function(){
      const callsList = document.getElementById('callsList');
      const detailPanel = document.getElementById('detailPanel');
      const adminPing = document.getElementById('adminPing');
      const howOverlay = document.getElementById('howOverlay');
      const btnHow = document.getElementById('btnHow');
      const closeHow = document.getElementById('closeHow');

      btnHow.addEventListener('click', ()=> howOverlay.style.display='flex');
      closeHow.addEventListener('click', ()=> howOverlay.style.display='none');

      // listen calls in realtime (function in script.js)
      listenIncomingCalls((calls)=>{
        // calls is an array of call objects {protocol, nomeCompleto, cpf, status, ts, obs}
        callsList.innerHTML = '';
        calls.sort((a,b)=>b.ts - a.ts);
        calls.forEach(c=>{
          const el = document.createElement('div');
          el.className='callCard';
          el.innerHTML = `
            <div class="meta">
              <div>
                <div class="protocol">${c.protocol}</div>
                <div class="muted">${c.nomeCompleto} • ${c.cpf}</div>
              </div>
              <div style="margin-left:auto;text-align:right">
                <div class="muted">${timeAgo(c.ts)}</div>
                <div class="muted">${statusLabel(c.status)}</div>
              </div>
            </div>
            <div class="row">
              <div class="muted small">${c.obs || ''}</div>
            </div>
            <div class="actions">
              <button class="btn accept" data-pro=${c.protocol}>Atender</button>
              <button class="btn reject" data-pro=${c.protocol}>Recusar</button>
            </div>
          `;
          callsList.appendChild(el);

          // attach actions
          el.querySelector('.accept').addEventListener('click', ()=> selectAndAccept(c.protocol));
          el.querySelector('.reject').addEventListener('click', ()=> rejectCall(c.protocol));
          // click shows details
          el.addEventListener('click',(ev)=>{
            if(ev.target.tagName.toLowerCase()==='button') return;
            showDetails(c);
          });
        });
      });

      // show details
      function showDetails(c){
        detailPanel.innerHTML = `
          <div><div class="muted">Protocolo</div><div class="large">${c.protocol}</div></div>
          <div><div class="muted">Nome</div><div>${c.nomeCompleto}</div></div>
          <div><div class="muted">CPF</div><div>${c.cpf}</div></div>
          <div><div class="muted">Obs</div><div>${c.obs || '—'}</div></div>
          <div style="margin-top:12px" id="liveControl"></div>
          <div class="timeline" id="timelineArea"></div>
        `;
      }

      async function selectAndAccept(protocol){
        // accept call (function in script.js)
        try{
          const supportId = 'support-'+Math.random().toString(36).slice(2,8);
          await acceptCall(protocol, {supportId});
          // update detail panel show controls to hangup
          detailPanel.querySelector('#liveControl').innerHTML = `
            <button class="btn accept" id="btnStartCall">Iniciar Ligação</button>
            <button class="btn reject" id="btnEndCall">Encerrar</button>
            <span style="margin-left:12px" id="callState">Conectando...</span>
          `;
          document.getElementById('btnStartCall').addEventListener('click', async ()=>{
            // start as support (callee)
            await startAsCallee(protocol, supportId, (state)=> {
              const st = document.getElementById('callState');
              if(st) st.textContent = state;
            });
            // when in call, update UI
            document.getElementById('callState').textContent = 'Em chamada';
          });
          document.getElementById('btnEndCall').addEventListener('click', async ()=>{
            await hangupCall(protocol, {by:'support'});
            detailPanel.querySelector('#liveControl').innerHTML = '';
          });
        }catch(err){
          alert('Erro ao aceitar: ' + (err.message || err));
        }
      }

      function rejectCall(protocol){
        if(!confirm('Recusar solicitação '+protocol+' ?')) return;
        rejectCallBySupport(protocol);
      }

      // helper labels
      function statusLabel(s){
        switch(s){
          case 'waiting': return 'Aguardando';
          case 'accepted': return 'Aceito';
          case 'in-call': return 'Em chamada';
          case 'rejected': return 'Recusado';
          case 'not-answered': return 'Não atendido';
          default: return s;
        }
      }
      function timeAgo(ts){
        const d = Math.floor((Date.now()-ts)/1000);
        if(d<60) return `${d}s`;
        if(d<3600) return `${Math.floor(d/60)}m`;
        return `${Math.floor(d/3600)}h`;
      }

      // ping UI from script.js
      startAdminPingLoop((ms)=>{
        adminPing.textContent = 'ping: '+ms+'ms';
      });

    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Central de Atendimento — Suporte</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa2b2;
      --accent:#00d4ff;
      --accent2:#6b6dfc;
      --danger:#ff6b6b;
      --glass: rgba(255,255,255,0.03);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071025,#081124);color:#e6eef8}
    .wrap{max-width:1200px;margin:28px auto;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-weight:700}
    .grid{display:grid;grid-template-columns:380px 1fr 320px; gap:18px; margin-top:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .list{max-height:60vh; overflow:auto}
    .call-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.accept{background:linear-gradient(90deg,var(--accent2),#7b80ff);color:white}
    .btn.reject{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .meta{font-size:13px;color:var(--muted);margin-top:6px}
    .center{display:flex;align-items:center;justify-content:center}
    .howto {position:fixed; inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6)}
    .howto .card{width:720px}
    .call-area{display:flex;flex-direction:column;gap:12px}
    .call-controls{display:flex;gap:8px;align-items:center}
    .status-pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
    .timeline{background:linear-gradient(180deg,#061026,#07102a);padding:12px;border-radius:10px}
    @media(max-width:1100px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Painel de Suporte</h1>
        <div class="small">Atenda em tempo real — ou recuse. Chamadas atendidas não ficam salvas.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="howBtn" class="btn reject">Como atender</button>
        <div class="small">Conectado como: <strong id="adminUser">SUPORTE</strong></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Fila (próximos)</h3>
        <div class="list" id="callsList">
          <div class="small">Aguardando conexões...</div>
        </div>
      </div>

      <div class="card">
        <h3>Atendimento</h3>
        <div id="activeArea" class="call-area">
          <div class="small">Nenhuma chamada em andamento</div>
        </div>
      </div>

      <div class="card">
        <h3>Monitor</h3>
        <div class="timeline">
          <div><strong>Ping:</strong> <span id="adminPing">—</span></div>
          <div style="margin-top:8px"><strong>Conexões ativas:</strong> <span id="activeCount">0</span></div>
          <div style="margin-top:8px"><strong>Status:</strong> <span id="adminStatus">Pronto</span></div>
        </div>
      </div>
    </div>

  </div>

  <div class="howto" id="howtoOverlay">
    <div class="card">
      <h2>Como Atender</h2>
      <p class="small">Ao aceitar, sua câmera/áudio será conectada — fale o nome da pessoa e conduza o atendimento profissionalmente:</p>
      <ul class="small">
        <li>Cumprimente pelo nome: "Bom dia, <em>Nome</em>, eu sou <em>Seu Nome</em> do suporte."</li>
        <li>Identifique o problema e confirme dados mínimos (não peça senha).</li>
        <li>Se precisar transferir, explique o próximo passo.</li>
        <li>Desligue quando finalizar — a chamada não fica salva.</li>
      </ul>
      <div style="margin-top:12px" class="center">
        <button id="closeHow" class="btn accept">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat scripts e script.js -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="script.js"></script>

  <script>
    (function(){
      const callsList = document.getElementById('callsList');
      const activeArea = document.getElementById('activeArea');
      const activeCount = document.getElementById('activeCount');
      const adminPing = document.getElementById('adminPing');
      const adminStatus = document.getElementById('adminStatus');
      const howBtn = document.getElementById('howBtn');
      const howtoOverlay = document.getElementById('howtoOverlay');
      document.getElementById('closeHow').addEventListener('click', ()=> howtoOverlay.style.display='none');
      howBtn.addEventListener('click', ()=> howtoOverlay.style.display='flex');

      let currentlyHandling = null;

      // pedir microfone
      (async ()=> {
        try{ await navigator.mediaDevices.getUserMedia({ audio:true }); }catch(e){ console.warn('Microfone não permitido',e); }
      })();

      // atualiza lista em tempo real
      listenWaitingCalls((calls)=>{
        callsList.innerHTML = '';
        if(!calls || calls.length===0){
          callsList.innerHTML = '<div class="small">Nenhuma chamada na fila</div>';
        }else{
          calls.forEach(c=>{
            const item = document.createElement('div');
            item.className = 'call-item';
            item.innerHTML = `
              <div>
                <div style="font-weight:700">${c.nomeCompleto}</div>
                <div class="small">${maskCPF(c.cpf)} • protocolo <span style="font-family:monospace">${c.protocol}</span></div>
                <div class="meta">Criado: ${new Date(c.createdAt).toLocaleString()}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                <div style="display:flex;gap:8px">
                  <button class="btn accept" data-proto="${c.protocol}">Atender</button>
                  <button class="btn reject" data-proto="${c.protocol}">Recusar</button>
                </div>
                <div class="small">Tempo: <span id="t${c.protocol}">—</span></div>
              </div>
            `;
            callsList.appendChild(item);

            // contadores de tempo
            setInterval(()=>{
              const el = document.getElementById('t'+c.protocol);
              if(!el) return;
              el.textContent = timeSince(c.createdAt);
            },1000);
          });
        }
      });

      // atualizar contagem
      listenActiveCount((n)=> activeCount.textContent = n);

      // interagir com a lista (delegation)
      callsList.addEventListener('click', async (ev)=>{
        const proto = ev.target.getAttribute('data-proto');
        if(!proto) return;
        if(ev.target.classList.contains('accept')){
          // aceitar
          try{
            const accepted = await acceptCall(proto);
            if(!accepted) { alert('Não foi possível aceitar. Talvez outra pessoa aceitou.'); return; }
            // montar UI de atendimento
            startHandling(proto);
          }catch(err){ console.error(err); alert('Erro ao aceitar: '+(err.message||err)); }
        }else if(ev.target.classList.contains('reject')){
          const reason = 'Recusado pelo suporte';
          await rejectCall(proto, reason);
        }
      });

      // iniciar manipulação local
      async function startHandling(protocol){
        currentlyHandling = protocol;
        adminStatus.textContent = 'Atendendo ' + protocol;
        // abre a UI para atender
        activeArea.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">Protocolo</div>
              <div style="font-family:monospace;font-weight:800">${protocol}</div>
            </div>
            <div>
              <div class="small">Duração</div>
              <div id="adminCallTimer" style="font-weight:800">00:00</div>
            </div>
          </div>
          <div class="call-controls">
            <button id="adminHangup" class="btn reject">Desligar</button>
          </div>
          <div class="small" id="participantInfo">Carregando dados...</div>
          <div class="small" id="adminCallPing">Ping: —</div>
        `;

        const participantInfo = document.getElementById('participantInfo');
        const adminCallPing = document.getElementById('adminCallPing');

        // obter dados de call e iniciar WebRTC (usa funções em script.js)
        const data = await getCallDetails(protocol);
        participantInfo.textContent = `${data.nomeCompleto} • CPF ${maskCPF(data.cpf)}`;

        // aceitar & iniciar troca SDP
        await startSupportCall(protocol, (stats)=>{
          adminCallPing.textContent = 'Ping: ' + stats.ping + ' ms';
        });

        // timer
        const startedAt = Date.now();
        setInterval(()=> {
          const secs = Math.floor((Date.now()-startedAt)/1000);
          document.getElementById('adminCallTimer').textContent = formatTime(secs);
        },1000);

        document.getElementById('adminHangup').addEventListener('click', async ()=>{
          await hangupCall(protocol, 'Desligado pelo suporte');
          activeArea.innerHTML = '<div class="small">Nenhuma chamada em andamento</div>';
          adminStatus.textContent = 'Pronto';
          currentlyHandling = null;
        });
      }

      // ping monitor global (admin)
      monitorAdminPing((p)=> adminPing.textContent = p + ' ms');

      // util
      function maskCPF(cpf){ return (cpf||'').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4'); }
      function timeSince(ts){ const s = Math.floor((Date.now()-ts)/1000); return formatTime(s); }
      function formatTime(secs){ const mm = String(Math.floor(secs/60)).padStart(2,'0'); const ss = String(secs%60).padStart(2,'0'); return mm+':'+ss; }

    })();
  </script>
</body>
</html>

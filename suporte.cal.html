<!-- admincall.html -->
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel Suporte</title>
<style>
  body{margin:0;font-family:Inter,Roboto,sans-serif;background:#f6f7fb}
  .wrap{max-width:900px;margin:20px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,0.1)}
  h1{margin-top:0}
  .item{padding:10px;border-bottom:1px solid #eee}
  .btn{padding:6px 12px;margin:4px;border:0;border-radius:6px;background:#0b4a9b;color:#fff;cursor:pointer}
  .btn.danger{background:#d9534f}
</style>
</head>
<body>
<div class="wrap">
  <h1>Solicitações</h1>
  <div id="list"></div>
  <div id="detail"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
<script>
const db=firebase.database();let pc,localStream,currentRef;
const list=document.getElementById('list'),detail=document.getElementById('detail');
db.ref('calls').on('value',snap=>{
  list.innerHTML='';const data=snap.val()||{};
  Object.values(data).forEach(c=>{
    const d=document.createElement('div');d.className='item';
    d.textContent=c.protocol+' - '+c.name+' ('+c.status+') ';
    const b=document.createElement('button');b.className='btn';b.textContent='Abrir';
    b.onclick=()=>open(c.protocol);d.appendChild(b);list.appendChild(d);
  })
});
async function open(id){
  currentRef=db.ref('calls/'+id);const snap=await currentRef.once('value');const c=snap.val();
  detail.innerHTML='<h3>'+c.name+'</h3><p>CPF: '+c.cpf+'</p><p>Protocolo: '+c.protocol+'</p>';
  if(c.status==='waiting'){const b=document.createElement('button');b.className='btn';b.textContent='Atender';b.onclick=()=>accept();detail.appendChild(b)}
}
async function accept(){
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  await currentRef.update({status:'in_call'});
  pc=new RTCPeerConnection();localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  const remote=new Audio();remote.autoplay=true;pc.ontrack=e=>remote.srcObject=e.streams[0];
  pc.onicecandidate=e=>{if(e.candidate)currentRef.child('calleeCandidates').push(e.candidate.toJSON())};
  const offerSnap=await currentRef.child('offer').once('value');const offer=offerSnap.val();
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const ans=await pc.createAnswer();await pc.setLocalDescription(ans);
  await currentRef.child('answer').set({type:ans.type,sdp:ans.sdp});
  currentRef.child('callerCandidates').on('child_added',snap=>pc.addIceCandidate(new RTCIceCandidate(snap.val())));
  const hang=document.createElement('button');hang.className='btn danger';hang.textContent='Encerrar';
  hang.onclick=()=>{currentRef.update({status:'finished'});pc.close()};detail.appendChild(hang);
}
</script>
</body>
</html>

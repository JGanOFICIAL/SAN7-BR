<!-- admincall.html -->
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de Suporte - Admin</title>
<style>
  :root{--bg:#f6f9fc;--card:#fff;--accent:#062b57;--muted:#6b7280}
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:#07203a;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  header h1{margin:0;font-size:20px;color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  .panel{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(9,20,34,0.06)}
  .list{max-height:68vh;overflow:auto}
  .callItem{padding:12px;border-radius:8px;border:1px solid #eef6fb;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
  .meta{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:8px}
  button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .btn-accept{background:#0f7ae5;color:#fff}
  .btn-reject{background:transparent;border:1px solid #e6eef6;color:var(--accent)}
  .callDetails{padding:12px}
  .big{font-weight:700;color:var(--accent);font-size:16px}
  .timer{font-feature-settings:"tnum";font-variant-numeric:tabular-nums}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <h1>Painel de Atendimento (Admin)</h1>
  <div class="meta">Conectado como <strong>Suporte</strong></div>
</header>

<div class="grid">
  <div class="panel">
    <h3>Solicitações em tempo real</h3>
    <div class="list" id="callsList"></div>
  </div>

  <div class="panel">
    <h3>Detalhes da chamada</h3>
    <div id="callInfo" class="callDetails">
      <div id="noSelection">Selecione uma solicitação à esquerda para ver detalhes.</div>
      <div id="selected" class="hidden">
        <div><span class="big" id="sProtocol"></span></div>
        <div style="margin-top:6px"><strong>Nome:</strong> <span id="sName"></span></div>
        <div style="margin-top:4px"><strong>CPF:</strong> <span id="sCpf"></span></div>
        <div style="margin-top:8px"><strong>Status:</strong> <span id="sStatus"></span></div>
        <div style="margin-top:8px"><strong>Tempo:</strong> <span id="sTimer" class="timer">00:00</span></div>

        <div style="margin-top:12px" id="actionButtons">
          <button class="btn-accept" id="acceptBtn">Atender</button>
          <button class="btn-reject" id="rejectBtn">Recusar</button>
          <button id="endBtn" class="hidden">Desligar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase libs and script.js -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>

<script>
(function(){
  const callsList = document.getElementById('callsList');
  const noSelection = document.getElementById('noSelection');
  const selected = document.getElementById('selected');
  const sProtocol = document.getElementById('sProtocol'), sName = document.getElementById('sName'), sCpf = document.getElementById('sCpf'), sStatus = document.getElementById('sStatus'), sTimer = document.getElementById('sTimer');
  const acceptBtn = document.getElementById('acceptBtn'), rejectBtn = document.getElementById('rejectBtn'), endBtn = document.getElementById('endBtn');

  let localStream = null;
  let pc = null;
  let currentCallRef = null;
  let currentProtocol = null;
  let timerInterval = null;
  let startCallAt = null;

  // ensure mic permission on entry (per requirement)
  async function ensureMic(){
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }catch(e){ console.warn('microphone permission denied', e); }
  }
  ensureMic();

  // list realtime calls
  const callsRef = firebase.database().ref('calls');
  callsRef.on('child_added', snap => {
    renderCallItem(snap.key, snap.val());
  });
  callsRef.on('child_changed', snap => {
    updateCallItem(snap.key, snap.val());
    // if meta.status changed to removed, remove item
  });
  callsRef.on('child_removed', snap => {
    removeCallItem(snap.key);
  });

  function renderCallItem(key,val){
    const meta = val.meta || val;
    const el = document.createElement('div');
    el.className = 'callItem';
    el.id = 'call_' + key;
    el.innerHTML = `
      <div>
        <div><strong>${meta.protocol}</strong> <span class="meta">- ${meta.name}</span></div>
        <div class="meta">CPF: ${meta.cpf} • ${meta.status || 'waiting'}</div>
      </div>
      <div class="actions">
        <button data-proto="${meta.protocol}" class="btn-accept smallBtn">Abrir</button>
      </div>
    `;
    callsList.prepend(el);
    el.querySelector('button').addEventListener('click', ()=>selectCall(key, meta));
  }
  function updateCallItem(key,val){
    const el = document.getElementById('call_' + key);
    if(!el) return renderCallItem(key,val);
    const meta = val.meta || val;
    el.querySelector('.meta').textContent = `CPF: ${meta.cpf} • ${meta.status || 'waiting'}`;
  }
  function removeCallItem(key){
    const el = document.getElementById('call_' + key);
    if(el) el.remove();
    if(currentProtocol === key){
      // current removed -> cleanup
      finishCallUI('Desligado (registro removido)');
    }
  }

  function selectCall(key, meta){
    currentProtocol = key;
    currentCallRef = firebase.database().ref('calls/' + key);
    noSelection.classList.add('hidden'); selected.classList.remove('hidden');
    sProtocol.textContent = 'Protocolo: ' + meta.protocol;
    sName.textContent = meta.name;
    sCpf.textContent = meta.cpf;
    sStatus.textContent = meta.status || 'waiting';
    // watch meta changes
    currentCallRef.child('meta').on('value', snap=>{
      const m = snap.val();
      if(!m) return;
      sStatus.textContent = m.status;
      if(m.status === 'in_call'){
        startTimer(m.acceptedAt || Date.now());
        acceptBtn.disabled = true; rejectBtn.disabled = true; endBtn.classList.remove('hidden');
      } else {
        stopTimer(); endBtn.classList.add('hidden'); acceptBtn.disabled = false; rejectBtn.disabled = false;
      }
    });
  }

  // WebRTC for admin: create offer and wait for answer
  function createPC(){
    pc = new RTCPeerConnection();
    if(localStream){
      for(const t of localStream.getTracks()) pc.addTrack(t, localStream);
    }
    const remoteAudio = document.createElement('audio'); remoteAudio.autoplay = true;
    pc.ontrack = e => {
      remoteAudio.srcObject = e.streams[0];
      if(!document.body.contains(remoteAudio)) document.body.appendChild(remoteAudio);
    };
    pc.onicecandidate = e=>{
      if(e.candidate && currentCallRef){
        currentCallRef.child('candidates/admin').push(e.candidate.toJSON());
      }
    };
    return pc;
  }

  acceptBtn.addEventListener('click', async ()=>{
    if(!currentCallRef) return alert('Selecione uma solicitação');
    // mark accepted
    await currentCallRef.child('meta/status').set('accepted_pending');
    await currentCallRef.child('meta/acceptedBy').set('support');
    // prepare pc
    if(!pc) createPC();
    // create offer
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await currentCallRef.child('offer').set(pc.localDescription.toJSON());
    // listen for answer
    currentCallRef.child('answer').on('value', async snap=>{
      const ans = snap.val();
      if(!ans) return;
      await pc.setRemoteDescription(new RTCSessionDescription(ans));
      // connect candidates from user
      currentCallRef.child('candidates/user').on('child_added', snap=>{
        const cand = snap.val();
        if(cand) pc.addIceCandidate(new RTCIceCandidate(cand)).catch(console.warn);
      });
      // mark in_call
      await currentCallRef.child('meta/status').set('in_call');
      await currentCallRef.child('meta/acceptedAt').set(Date.now());
    });
  });

  rejectBtn.addEventListener('click', async ()=>{
    if(!currentCallRef) return;
    await currentCallRef.child('meta/status').set('rejected');
    await currentCallRef.child('meta/endedReason').set('recusado pelo suporte');
    // remove after short delay
    setTimeout(()=>currentCallRef.remove().catch(()=>{}), 2000);
    // clear UI
    finishCallUI('Recusado');
  });

  endBtn.addEventListener('click', async ()=>{
    if(!currentCallRef) return;
    // notify end and remove
    await currentCallRef.child('meta/status').set('ended');
    await currentCallRef.child('meta/endedBy').set('support');
    await currentCallRef.remove().catch(()=>{});
    finishCallUI('Desligado');
  });

  function finishCallUI(msg){
    noSelection.classList.remove('hidden');
    selected.classList.add('hidden');
    if(pc){ pc.close(); pc=null; }
    if(currentCallRef){ currentCallRef.off(); currentCallRef = null; }
    stopTimer();
    alert(msg);
  }

  function startTimer(since){
    startCallAt = since || Date.now();
    function upd(){
      const diff = Date.now() - startCallAt;
      const mm = String(Math.floor(diff/60000)).padStart(2,'0');
      const ss = String(Math.floor((diff%60000)/1000)).padStart(2,'0');
      sTimer.textContent = mm+':'+ss;
    }
    upd();
    timerInterval = setInterval(upd, 1000);
  }
  function stopTimer(){ clearInterval(timerInterval); timerInterval=null; sTimer.textContent='00:00'; }

  // small cleanup on unload
  window.addEventListener('beforeunload', ()=>{
    if(pc) pc.close();
  });
})();
</script>
</body>
</html>

<!-- admincall.html -->
<! — admin panel moderno —>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Central de Atendimento — Suporte</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f4f7fb;--card:#fff;--accent:#0366d6;--danger:#e24141;--muted:#667085}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#0b2636}
  header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;background:linear-gradient(90deg,#fff,#f6fbff);box-shadow:0 6px 20px rgba(11,38,54,0.05)}
  h1{margin:0;font-size:18px}
  .wrap{display:flex;gap:18px;padding:18px;align-items:flex-start}
  .left{flex:1;max-width:420px}
  .right{flex:2}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(2,10,23,0.04)}
  .list-item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid #eef6ff}
  .meta{font-size:13px}
  .actions{display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(3,102,214,0.12);color:var(--accent)}
  .btn.red{background:var(--danger)}
  .muted{color:var(--muted);font-size:13px}
  .call-panel{margin-top:14px}
  video,audio{width:100%;border-radius:8px;background:#000}
  .tutorialBtn{margin-left:8px}
  .overlay{position:fixed;inset:0;background:rgba(4,8,20,0.6);display:flex;align-items:center;justify-content:center;z-index:80}
  .overlay .tutorialBox{background:white;padding:18px;border-radius:12px;max-width:720px;width:92%}
  .status-badge{font-weight:700;color:var(--accent)}
  .ping{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;margin-top:10px}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <h1>Painel de Suporte — Central</h1>
  <div>
    <button class="btn ghost" id="tutorialOpen">Como atender</button>
    <button class="btn" id="refreshBtn">Atualizar</button>
    <button class="btn red" id="logoutBtn">Sair</button>
  </div>
</header>

<div class="wrap">
  <div class="left">
    <div class="card">
      <h3>Fila de solicitações</h3>
      <p class="muted">Novas solicitações aparecem em tempo real. Clique em Atender para iniciar.</p>
      <div id="requestsList" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="right">
    <div class="card">
      <h3>Visor da chamada</h3>
      <div id="callInfo" style="margin-top:10px">
        <div class="muted">Sem chamada selecionada</div>
      </div>

      <div class="call-panel hidden" id="callPanel">
        <div class="muted-line">Protocolo: <strong id="callProtocol"></strong></div>
        <div class="muted-line">Nome: <strong id="callNome"></strong></div>
        <div class="muted-line">CPF: <strong id="callCPF"></strong></div>
        <div class="muted-line">Conexão: <span id="connPing" class="ping">—</span></div>

        <audio id="localAudio" autoplay controls></audio>
        <audio id="clientAudio" autoplay></audio>

        <div class="controls">
          <button class="btn" id="acceptBtn">Atender</button>
          <button class="btn ghost" id="rejectBtn">Recusar</button>
          <button class="btn red" id="endBtn">Desligar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- tutorial overlay -->
<div id="tutorialOverlay" class="overlay hidden">
  <div class="tutorialBox">
    <h3>Como atender</h3>
    <p class="muted">Siga estas boas práticas: cumprimente sempre falando o nome do solicitante, verifique CPF, confirme identidade, mantenha tom calmo, ofereça solução passo a passo. Use o botão "Desligar" para encerrar. Sempre documente no sistema se necessário.</p>
    <div style="text-align:right;margin-top:10px"><button class="btn" id="closeTut">Fechar</button></div>
  </div>
</div>

<!-- Firebase + script.js -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>

<script>
/*
 Admin panel logic.
 - Monitora /calls/requests
 - Permite Atender (cria room + answer flow), Recusar, Desligar
 - Requer microfone acesso na entrada
*/

(function(){
  // elementos
  const requestsList = document.getElementById('requestsList');
  const tutorialOpen = document.getElementById('tutorialOpen');
  const tutorialOverlay = document.getElementById('tutorialOverlay');
  const closeTut = document.getElementById('closeTut');
  const callPanel = document.getElementById('callPanel');
  const callProtocol = document.getElementById('callProtocol');
  const callNome = document.getElementById('callNome');
  const callCPF = document.getElementById('callCPF');
  const connPing = document.getElementById('connPing');
  const acceptBtn = document.getElementById('acceptBtn');
  const rejectBtn = document.getElementById('rejectBtn');
  const endBtn = document.getElementById('endBtn');
  const clientAudio = document.getElementById('clientAudio');
  const localAudio = document.getElementById('localAudio');

  let localStream = null;
  let pc = null;
  let selectedProtocol = null;
  let roomId = null;
  let queryRef = null;
  let candidateListenerRefs = [];
  let requestListener = null;

  // request mic on enter
  (async ()=>{ await navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{ localStream = s; localAudio.srcObject = s; localAudio.play().catch(()=>{}); }).catch(()=>{}); })();

  // monitor requests
  function renderRequestItem(proto, data){
    const el = document.createElement('div');
    el.className = 'list-item';
    el.innerHTML = `
      <div>
        <div style="font-weight:700">${data.nome}</div>
        <div class="muted">${proto} • ${new Date(data.criadoEm).toLocaleString()}</div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-proto="${proto}" data-act="view">Ver</button>
        <button class="btn" data-proto="${proto}" data-act="att">Atender</button>
      </div>
    `;
    return el;
  }

  function listenRequests(){
    const ref = db.ref('calls/requests');
    // clean previous
    if(requestListener) ref.off('value', requestListener);
    requestListener = ref.on('value', snap=>{
      const v = snap.val() || {};
      requestsList.innerHTML = '';
      // order by created time (asc)
      const items = Object.keys(v).map(k=>({k,v:v[k]})).sort((a,b)=>a.v.criadoEm - b.v.criadoEm);
      for(const it of items){
        const item = renderRequestItem(it.k,it.v);
        requestsList.appendChild(item);
      }
    });
  }

  requestsList.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const proto = btn.dataset.proto;
    const act = btn.dataset.act;
    if(act === 'view'){
      const snap = await db.ref('calls/requests/'+proto).get();
      const d = snap.val();
      if(!d) return alert('Solicitação removida');
      callProtocol.textContent = proto;
      callNome.textContent = d.nome;
      callCPF.textContent = d.cpf;
      selectedProtocol = proto;
      callPanel.classList.remove('hidden');
    } else if(act === 'att'){
      // auto open view then accept
      const snap = await db.ref('calls/requests/'+proto).get();
      const d = snap.val();
      if(!d) return alert('Solicitação removida');
      callProtocol.textContent = proto;
      callNome.textContent = d.nome;
      callCPF.textContent = d.cpf;
      selectedProtocol = proto;
      callPanel.classList.remove('hidden');
      // programmatic accept
      await acceptCall(proto);
    }
  });

  tutorialOpen.addEventListener('click', ()=>{ tutorialOverlay.classList.remove('hidden'); });
  closeTut.addEventListener('click', ()=>{ tutorialOverlay.classList.add('hidden'); });

  async function acceptCall(proto){
    try{
      acceptBtn.disabled=true;
      // create room id
      const roomIdLocal = 'room-'+proto;
      roomId = roomIdLocal;
      // set room id into request
      await db.ref('calls/requests/'+proto+'/roomId').set(roomId);
      await db.ref('calls/requests/'+proto+'/estado').set('atendido');
      await db.ref('calls/rooms/'+roomId).set({createdBy:'support', createdAt:Date.now()});
      // create peer connection and answer incoming offer
      await joinRoomAsCallee(proto, roomId);
    }catch(e){ console.error(e); alert('Falha ao aceitar: '+(e.message||e)); acceptBtn.disabled=false; }
  }

  async function joinRoomAsCallee(proto, roomId){
    pc = new RTCPeerConnection({iceServers:[{urls:['stun:stun.l.google.com:19302']}]});
    // attach local mic tracks to pc
    if(!localStream){
      try{ localStream = await navigator.mediaDevices.getUserMedia({audio:true}); localAudio.srcObject = localStream; }catch(e){}
    }
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

    const roomRef = db.ref('calls/rooms/'+roomId);
    const offerSnap = await roomRef.child('offer').get();
    if(!offerSnap.exists()) { alert('Offer não encontrado'); return; }
    const offer = offerSnap.val();
    await pc.setRemoteDescription({type:offer.type, sdp:offer.sdp});

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await roomRef.child('answer').set({type:answer.type, sdp:answer.sdp});

    // candidate exchange
    const callerCandidatesRef = roomRef.child('callerCandidates');
    const calleeCandidatesRef = roomRef.child('calleeCandidates');

    pc.onicecandidate = (ev)=>{
      if(ev.candidate){
        calleeCandidatesRef.push(ev.candidate.toJSON()).catch(()=>{});
      }
    };

    callerCandidatesRef.on('child_added', snap=>{
      const c = snap.val();
      pc.addIceCandidate(new RTCIceCandidate(c)).catch(e=>console.warn(e));
    });

    pc.ontrack = (ev)=>{
      clientAudio.srcObject = ev.streams[0];
      clientAudio.play().catch(()=>{});
    };

    pc.onconnectionstatechange = ()=>{
      if(pc.connectionState === 'connected'){
        // mark startedAt
        db.ref('calls/requests/'+proto+'/startedAt').set(Date.now());
      } else if(pc.connectionState === 'disconnected' || pc.connectionState==='failed'){
        // end
      }
    };

    // update ping UI by reading client's lastPing
    db.ref('calls/requests/'+proto+'/lastPing').on('value', snap=>{
      const v = snap.val();
      if(v) connPing.textContent = `${Date.now()-v} ms`;
    });

    // store active room under support id (optional)
    await db.ref('calls/active_support/'+proto).set({support:'me', roomId, startedAt:Date.now()});
  }

  async function rejectCall(proto){
    await db.ref('calls/requests/'+proto+'/estado').set('recusado');
    const cpf = (await db.ref('calls/requests/'+proto+'/cpf').get()).val();
    if(cpf) await db.ref('calls/active_by_cpf/'+cpf).remove();
    await db.ref('calls/requests/'+proto).remove();
    callPanel.classList.add('hidden');
  }

  async function endCall(proto){
    if(!proto) return;
    await db.ref('calls/requests/'+proto+'/estado').set('desligado');
    const cpf = (await db.ref('calls/requests/'+proto+'/cpf').get()).val();
    if(cpf) await db.ref('calls/active_by_cpf/'+cpf).remove();
    // remove room
    if(roomId) await db.ref('calls/rooms/'+roomId).remove();
    await db.ref('calls/requests/'+proto).remove();
    // cleanup local pc
    try{ if(pc){ pc.getSenders().forEach(s=>s.track && s.track.stop()); pc.close(); pc=null; } }catch(e){}
    callPanel.classList.add('hidden');
  }

  acceptBtn.addEventListener('click', async ()=>{ if(selectedProtocol) await acceptCall(selectedProtocol); });
  rejectBtn.addEventListener('click', async ()=>{ if(selectedProtocol) await rejectCall(selectedProtocol); });
  endBtn.addEventListener('click', async ()=>{ if(selectedProtocol) await endCall(selectedProtocol); });

  // initial listeners
  listenRequests();

  // refresh button
  document.getElementById('refreshBtn').addEventListener('click', ()=>listenRequests());

  // logout (uses script.js auth)
  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    await sair();
    location.href='login.html';
  });

  // tutorial overlay close behavior
  document.getElementById('closeTut').addEventListener('click', ()=>{ tutorialOverlay.classList.add('hidden'); });

  // ask for mic permission on load
  (async ()=>{ await navigator.mediaDevices.getUserMedia({audio:true}).catch(()=>{}); })();

})();
</script>
</body>
</html>

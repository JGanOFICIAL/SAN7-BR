<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Call - Central de Atendimento</title>
<link rel="stylesheet" href="admincall.css"/>
</head>
<body>
<div class="admin-shell">
  <aside class="sidebar">
    <div class="brand">Admin Call</div>
    <div class="info">Painel de suporte</div>
    <button id="tutorialBtn" class="btn">Como atender</button>
    <div id="pingStatus" class="ping">Ping: —</div>
  </aside>

  <main class="main">
    <header class="main-head">
      <h1>Chamadas em tempo real</h1>
      <div class="controls">
        <button id="refreshBtn" class="btn">Atualizar</button>
      </div>
    </header>

    <section class="calls-area">
      <div id="callsList" class="calls-list"></div>
      <div id="noCalls" class="no-calls">Nenhuma solicitação no momento.</div>
    </section>
  </main>
</div>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
<script>
/* admin UI logic */
(function(){
  const $ = id => document.getElementById(id);
  const callsList = $('callsList'), noCalls = $('noCalls');
  const tutorialBtn = $('tutorialBtn'), tutorialOverlay = $('tutorialOverlay');
  const closeTutorial = $('closeTutorial'), ttNome = $('ttNome'), ttCpf = $('ttCpf');
  const pingStatus = $('pingStatus');

  let localStream = null;
  let currentPc = null;
  let currentProtocol = null;
  let supportPeerId = null;
  let callListeners = {};

  function onlyDigits(s){ return (s||'').replace(/\D/g,''); }
  function formatTime(ts){ const d = new Date(ts); return d.toLocaleString(); }

  async function requestMic(){
    try{
      localStream = await navigator.mediaDevices.getUserMedia({audio:true});
      return true;
    }catch(e){
      alert('Permita o microfone para atender chamadas.');
      return false;
    }
  }

  function renderCallItem(proto, data){
    const el = document.createElement('div');
    el.className = 'call-item';
    el.innerHTML = `
      <div class="call-main">
        <div class="info">
          <div class="name">${data.nome || '—'}</div>
          <div class="cpf">${data.cpf || '—'}</div>
          <div class="meta">Criado: ${formatTime(data.createdAt || Date.now())}</div>
        </div>
        <div class="actions">
          <button class="btn-accept" data-proto="${proto}">Atender</button>
          <button class="btn-reject" data-proto="${proto}">Recusar</button>
        </div>
      </div>
    `;
    return el;
  }

  async function refreshCalls(){
    const snap = await firebase.database().ref('calls').orderByChild('createdAt').get();
    callsList.innerHTML = '';
    let count = 0;
    if(snap.exists()){
      const data = snap.val();
      Object.keys(data).reverse().forEach(proto=>{
        count++;
        const item = renderCallItem(proto, data[proto]);
        callsList.appendChild(item);
      });
    }
    noCalls.style.display = count ? 'none' : 'block';
    attachButtons();
  }

  function attachButtons(){
    document.querySelectorAll('.btn-accept').forEach(btn=>{
      btn.onclick = (e)=> acceptCall(e.target.dataset.proto);
    });
    document.querySelectorAll('.btn-reject').forEach(btn=>{
      btn.onclick = (e)=> rejectCall(e.target.dataset.proto);
    });
  }

  async function rejectCall(proto){
    await firebase.database().ref('calls/'+proto+'/status').set('rejected');
    // remove active_by_cpf entry if exists
    const snap = await firebase.database().ref('calls/'+proto).get();
    if(snap.exists()){
      const c = snap.val();
      if(c.cpf) firebase.database().ref('active_by_cpf/'+onlyDigits(c.cpf)).remove();
    }
    // remove call entry
    setTimeout(()=> firebase.database().ref('calls/'+proto).remove(), 2000);
    refreshCalls();
  }

  async function acceptCall(proto){
    if(currentProtocol) { alert('Já está em atendimento. Encerrar antes de aceitar outra.'); return; }
    const micOk = await requestMic();
    if(!micOk) return;

    const snap = await firebase.database().ref('calls/'+proto).get();
    if(!snap.exists()){ alert('Chamada já encerrada.'); refreshCalls(); return; }
    const data = snap.val();
    ttNome.textContent = data.nome || '—';
    ttCpf.textContent = data.cpf || '—';
    tutorialOverlay.classList.remove('hidden');

    // set status accepted
    await firebase.database().ref('calls/'+proto+'/status').set('accepted');
    // record support and start answer
    supportPeerId = 'support-'+Date.now();
    currentProtocol = proto;

    // show admin controls in UI (replace item with ongoing)
    startAnswerView(proto, data);
  }

  async function startAnswerView(proto, data){
    // create PC and answer logic
    currentPc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
    if(localStream) localStream.getTracks().forEach(t=> currentPc.addTrack(t, localStream));
    const audio = document.createElement('audio'); audio.autoplay = true; audio.playsInline = true;
    currentPc.ontrack = (ev) => { audio.srcObject = ev.streams[0]; };

    const candRef = firebase.database().ref(`calls/${proto}/candidates/support-branch-${Date.now()}`);
    currentPc.onicecandidate = (ev)=>{
      if(ev.candidate) candRef.push(JSON.stringify(ev.candidate));
    };

    // get offer
    const offerSnap = await firebase.database().ref('calls/'+proto+'/offer').get();
    if(!offerSnap.exists()){ alert('Offer não encontrada'); return; }
    const offer = offerSnap.val();
    await currentPc.setRemoteDescription(new RTCSessionDescription({type: offer.type, sdp: offer.sdp}));

    const answer = await currentPc.createAnswer();
    await currentPc.setLocalDescription(answer);

    await firebase.database().ref('calls/'+proto+'/answer').set({sdp:answer.sdp, type:answer.type, createdAt:Date.now(), supportPeerId: supportPeerId});

    // listen for remote candidates
    firebase.database().ref(`calls/${proto}/candidates`).on('child_added', snap=>{
      const key = snap.key;
      if(key.indexOf('support-')===0) return; // ignore support branch
      const val = snap.val();
      if(typeof val === 'string'){
        try{ currentPc.addIceCandidate(new RTCIceCandidate(JSON.parse(val))); }catch(e){}
      }else if(typeof val === 'object'){
        Object.values(val).forEach(v=>{
          try{ currentPc.addIceCandidate(new RTCIceCandidate(JSON.parse(v))); }catch(e){}
        });
      }
    });

    // listen for call end
    firebase.database().ref('calls/'+proto+'/status').on('value', snap=>{
      const val = snap.val();
      if(val === 'ended' || val === 'cancelled' || val === 'rejected' || val === 'not_answered'){
        endCurrentCall();
      }
    });

    // UI: replace calls list area with active call controls
    callsList.innerHTML = '';
    const activeCard = document.createElement('div');
    activeCard.className = 'active-call';
    activeCard.innerHTML = `
      <div class="act-left">
        <div><strong>Protocolo:</strong> ${proto}</div>
        <div><strong>Nome:</strong> ${data.nome}</div>
        <div><strong>CPF:</strong> ${data.cpf}</div>
        <div><strong>Iniciado:</strong> ${new Date(data.createdAt).toLocaleString()}</div>
        <div id="adminCallTimer">Tempo: 00:00</div>
      </div>
      <div class="act-right">
        <div id="adminAudioHolder"></div>
        <div class="act-actions">
          <button id="adminHang" class="btn-danger">Desligar</button>
        </div>
      </div>
    `;
    callsList.appendChild(activeCard);
    $('adminAudioHolder').appendChild(audio);

    // hangup button
    $('adminHang').onclick = async ()=>{
      await firebase.database().ref('calls/'+proto+'/status').set('ended');
      // remove active_by_cpf
      if(data.cpf) firebase.database().ref('active_by_cpf/'+onlyDigits(data.cpf)).remove();
      setTimeout(()=> firebase.database().ref('calls/'+proto).remove(), 3000);
      endCurrentCall();
    };

    // timer
    let seconds = 0;
    const timerId = setInterval(()=>{
      seconds++;
      const mm = String(Math.floor(seconds/60)).padStart(2,'0');
      const ss = String(seconds%60).padStart(2,'0');
      const tEl = $('adminCallTimer');
      if(tEl) tEl.textContent = `Tempo: ${mm}:${ss}`;
    },1000);

    // store listeners to cleanup
    callListeners[proto] = {timerId};

  }

  async function endCurrentCall(){
    if(currentProtocol){
      const proto = currentProtocol;
      // cleanup pc
      try{ currentPc && currentPc.close(); }catch(e){}
      currentPc = null;
      currentProtocol = null;
      // stop local stream
      try{ localStream && localStream.getTracks().forEach(t=>t.stop()); }catch(e){}
      localStream = null;
      // cleanup listeners
      if(callListeners[proto]){
        clearInterval(callListeners[proto].timerId);
        delete callListeners[proto];
      }
      refreshCalls();
    }
  }

  // tutorial overlay handlers
  tutorialBtn.onclick = ()=> tutorialOverlay.classList.remove('hidden');
  closeTutorial.onclick = ()=> tutorialOverlay.classList.add('hidden');

  // ping measurement (simple)
  setInterval(async ()=>{
    try{
      const t0 = Date.now();
      await firebase.database().ref('/admin_ping/time').set({t:t0});
      const snap = await firebase.database().ref('/admin_ping/time').get();
      const t1 = Date.now();
      if(snap.exists()){
        const ping = Math.abs(t1 - t0);
        pingStatus.textContent = 'Ping: '+ping+'ms';
      }else pingStatus.textContent = 'Ping: —';
    }catch(e){
      pingStatus.textContent = 'Ping: offline';
    }
  },4000);

  // live update: listen to calls node
  firebase.database().ref('calls').on('value', snap=>{
    const val = snap.val();
    callsList.innerHTML = '';
    if(!val){ noCalls.style.display='block'; return; }
    noCalls.style.display='none';
    Object.keys(val).reverse().forEach(proto=>{
      const itemData = val[proto];
      const item = renderCallItem(proto, itemData);
      callsList.appendChild(item);
    });
    attachButtons();
  });

  // init
  window.addEventListener('load', ()=>{
    // request permission early
    navigator.permissions && navigator.permissions.query({name:'microphone'}).catch(()=>{});
  });

})();
</script>

<style>
/* admincall.css */
:root{--bg:#f5f7fb;--card:#fff;--accent:#0b63d6;--danger:#e04b4b;--text:#111;--muted:#6b7280;font-family:Inter,system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text)}
.admin-shell{display:flex;min-height:100vh}
.sidebar{width:240px;background:linear-gradient(180deg,#0b63d6,#094bb0);color:#fff;padding:20px;display:flex;flex-direction:column;gap:12px}
.brand{font-weight:700;font-size:20px}
.info{font-size:13px;color:rgba(255,255,255,0.85)}
.btn{background:rgba(255,255,255,0.1);border:0;padding:8px;border-radius:8px;color:#fff;cursor:pointer}
.ping{font-size:13px;margin-top:auto;color:rgba(255,255,255,0.9)}
.main{flex:1;padding:20px}
.main-head{display:flex;justify-content:space-between;align-items:center}
.calls-area{margin-top:16px}
.call-item{background:var(--card);padding:12px;border-radius:10px;margin-bottom:10px;box-shadow:0 6px 18px rgba(18,38,63,0.06);display:flex;justify-content:space-between;align-items:center}
.call-item .info .name{font-weight:700}
.call-item .info .cpf{color:var(--muted);font-size:13px}
.call-item .actions{display:flex;gap:8px}
.btn-accept{background:var(--accent);color:#fff;border:0;padding:8px;border-radius:8px;cursor:pointer}
.btn-reject{background:var(--danger);color:#fff;border:0;padding:8px;border-radius:8px;cursor:pointer}
.no-calls{color:var(--muted);margin-top:20px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
.overlay-card{background:#fff;padding:20px;border-radius:12px;max-width:560px;width:94%}
.active-call{background:var(--card);padding:16px;border-radius:10px;display:flex;justify-content:space-between;align-items:flex-start}
.act-left{font-size:14px}
.act-right{display:flex;flex-direction:column;gap:8px}
.act-actions{display:flex;gap:8px}
.btn-danger{background:var(--danger);color:#fff;border:0;padding:8px;border-radius:8px;cursor:pointer}
</style>
</body>
</html>

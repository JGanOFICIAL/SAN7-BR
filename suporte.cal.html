<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Central de Atendimento — Painel Suporte</title>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;--muted:#6b7280;--accent:#0b3b66;--card:#f5f7fb;
    }
    body{margin:0;font-family:'Public Sans',system-ui,Segoe UI,Roboto,Arial;background:#f2f4f8;}
    header{background:linear-gradient(90deg,#07263f 0%, #0b3b66 100%);color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px}
    header .right{display:flex;gap:10px;align-items:center}
    .wrap{padding:20px;max-width:1100px;margin:18px auto;display:grid;grid-template-columns:360px 1fr;gap:18px}
    .panel{background:#fff;padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(12,20,30,0.06);}
    .calls-list{display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto;padding-right:6px}
    .call-item{padding:12px;border-radius:10px;background:var(--card);display:flex;flex-direction:column;gap:8px}
    .call-row{display:flex;justify-content:space-between;align-items:center}
    .btn{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid #e6e9ef;color:var(--accent);padding:8px 10px;border-radius:8px;cursor:pointer}
    .meta{font-size:13px;color:var(--muted)}
    .big{font-weight:700;color:var(--accent)}
    .right-panel{display:flex;flex-direction:column;gap:12px}
    .call-stage{min-height:120px;display:flex;flex-direction:column;gap:8px;justify-content:center;align-items:center}
    .tutorial{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:12px;box-shadow:0 12px 30px rgba(2,10,30,0.25);display:none;max-width:620px;width:92%}
    .tutorial h3{margin:0 0 8px}
    .footer{font-size:13px;color:var(--muted);text-align:right}
  </style>
</head>
<body>
  <header>
    <h1>Painel de Suporte — Central de Atendimento</h1>
    <div class="right">
      <button id="howBtn" class="btn-ghost">Como atender</button>
      <button id="micTest" class="btn-ghost">Testar microfone</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <h3>Solicitações Ativas</h3>
      <div class="calls-list" id="callsList">
        <!-- preenchido dinamicamente -->
      </div>
      <div class="footer">Atualização em tempo real via Firebase</div>
    </div>

    <div class="panel right-panel">
      <h3>Área de atendimento</h3>
      <div id="stage" class="call-stage">
        <div class="meta" id="stageMeta">Nenhuma chamada selecionada.</div>
        <div id="stageControls"></div>
      </div>

      <div style="margin-top:12px;">
        <div class="meta">Status do sistema: <span id="sysStatus" class="big">Conectado</span></div>
      </div>
    </div>
  </div>

  <div class="tutorial" id="tutorialBox">
    <h3>Como atender</h3>
    <p>1. Selecione um pedido à esquerda. Leia o nome e o CPF em voz clara: "Olá <strong id="tNome"></strong>, meu nome é <em>Suporte</em>, como posso ajudar hoje?"</p>
    <p>2. Mantenha a voz calma, confirme dados, repita o protocolo se necessário. Use pausas curtas para permitir que o cidadão fale.</p>
    <p>3. Ao finalizar clique em "Desligar". Chamadas atendidas não ficam salvas.</p>
    <div style="text-align:right;margin-top:8px"><button id="closeTutorial" class="btn-ghost">Fechar</button></div>
  </div>

  <!-- Firebase compat libs and script.js -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="script.js"></script>

  <script>
    // Admin UI wiring
    (function(){
      const callsList = document.getElementById('callsList');
      const stageMeta = document.getElementById('stageMeta');
      const stageControls = document.getElementById('stageControls');
      const howBtn = document.getElementById('howBtn');
      const tutorial = document.getElementById('tutorialBox');
      const closeTutorial = document.getElementById('closeTutorial');
      const tNome = document.getElementById('tNome');
      const micTest = document.getElementById('micTest');

      let currentCall = null;

      async function askMicOnEnter(){
        try{
          await navigator.mediaDevices.getUserMedia({ audio:true });
        }catch(e){
          console.warn('Microfone não permitido', e);
        }
      }
      askMicOnEnter();

      micTest.addEventListener('click', async ()=>{
        try{
          const s = await navigator.mediaDevices.getUserMedia({ audio:true });
          s.getTracks().forEach(t=>t.stop());
          alert('Microfone acessível.');
        }catch(e){
          alert('Falha ao acessar microfone. Permita o microfone no navegador.');
        }
      });

      howBtn.addEventListener('click', ()=>{
        tutorial.style.display = 'block';
      });
      closeTutorial.addEventListener('click', ()=> tutorial.style.display='none');

      // Carrega chamadas em tempo real
      listenForCalls({
        onCallAdded: (callMeta)=>{
          renderCallItem(callMeta);
        },
        onCallRemoved: (protocol)=>{
          const el = document.getElementById('call-'+protocol);
          if(el) el.remove();
          if(currentCall && currentCall.protocol === protocol){
            // encerrar UI
            stageMeta.textContent = 'Chamada encerrada/removida.';
            stageControls.innerHTML = '';
            currentCall = null;
          }
        },
        onCallChanged: (callMeta)=>{
          // atualiza item se existir
          const el = document.getElementById('call-'+callMeta.protocol);
          if(el){
            const statusEl = el.querySelector('.status');
            const whenEl = el.querySelector('.when');
            statusEl.textContent = callMeta.status;
            whenEl.textContent = new Date(callMeta.createdAt).toLocaleString();
          }
        }
      });

      function renderCallItem(meta){
        const div = document.createElement('div');
        div.className = 'call-item';
        div.id = 'call-'+meta.protocol;
        div.innerHTML = `
          <div class="call-row">
            <div>
              <div class="big">${meta.nomeCompleto}</div>
              <div class="meta">CPF: ${meta.cpf}</div>
            </div>
            <div style="text-align:right">
              <div class="meta">Protoc.: <strong>${meta.protocol}</strong></div>
              <div class="meta when">${new Date(meta.createdAt).toLocaleString()}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn" data-action="accept" data-proto="${meta.protocol}">Atender</button>
            <button class="btn-ghost" data-action="decline" data-proto="${meta.protocol}">Recusar</button>
          </div>
        `;
        callsList.prepend(div);

        div.querySelector('[data-action="accept"]').addEventListener('click', async (e)=>{
          const p = e.target.dataset.proto;
          // aceitar via função adminAccept
          try{
            const callMeta = await adminAccept(p, {
              onConnected: ()=>{
                // mostra na área
                stageMeta.textContent = `Atendendo ${meta.nomeCompleto} — Protoc.: ${meta.protocol}`;
                stageControls.innerHTML = `<button id="adminHang" class="btn-ghost">Desligar</button>`;
                document.getElementById('adminHang').addEventListener('click', async ()=>{
                  await adminHangup(p);
                });
                tNome.textContent = meta.nomeCompleto;
              },
              onEnded: ()=>{
                stageMeta.textContent = 'Chamada encerrada.';
                stageControls.innerHTML = '';
              }
            });
          }catch(err){
            console.error(err);
            alert('Falha ao aceitar chamada.');
          }
        });

        div.querySelector('[data-action="decline"]').addEventListener('click', async (e)=>{
          const p = e.target.dataset.proto;
          if(!confirm('Recusar essa solicitação?')) return;
          try{
            await adminDecline(p);
          }catch(e){ console.warn(e); alert('Erro ao recusar.'); }
        });
      }

    })();
  </script>
</body>
</html>

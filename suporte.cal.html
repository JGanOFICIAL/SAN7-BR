<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Atendimento — Administração</title>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  margin:0; font-family:'Public Sans',sans-serif; background:#f4f7fb; color:#222;
}
header {
  background:#0066ff; color:#fff; padding:16px; text-align:center;
  font-size:20px; font-weight:600; position:sticky; top:0; z-index:2;
  display:flex; justify-content:space-between; align-items:center;
}
header button {
  background:#fff; color:#0066ff; border:none; border-radius:6px;
  padding:6px 12px; font-size:14px; cursor:pointer;
}
.container { padding:20px; max-width:800px; margin:auto; }
.solicitacao {
  background:#fff; padding:16px; border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08); margin-bottom:15px;
  display:flex; justify-content:space-between; align-items:center;
}
.solicitacao-info { flex:1; }
.solicitacao strong { display:block; font-size:16px; margin-bottom:6px; }
.solicitacao small { color:#666; }
.actions button {
  margin-left:8px; padding:8px 14px; border:none; border-radius:6px;
  cursor:pointer; font-weight:600;
}
.actions .atender { background:#00b050; color:#fff; }
.actions .recusar { background:#d9534f; color:#fff; }
#callArea {
  display:none; background:#fff; padding:20px; border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-top:20px; text-align:center;
}
#statusMsg { font-weight:600; margin:10px 0; }
#timer, #ping { margin:5px 0; font-size:14px; color:#444; }
#desligarBtn {
  background:#d9534f; color:#fff; border:none; padding:12px 20px;
  border-radius:8px; font-size:16px; cursor:pointer; margin-top:15px;
}
audio { display:none; }
/* Tutorial overlay */
#tutorialOverlay {
  position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6);
  display:none; justify-content:center; align-items:center; z-index:5;
}
#tutorialContent {
  background:#fff; padding:30px; border-radius:12px; max-width:500px;
  text-align:left; font-size:15px; line-height:1.6;
}
#tutorialContent h2 { margin-top:0; color:#0066ff; }
#tutorialContent button {
  margin-top:20px; padding:10px 20px; border:none; border-radius:8px;
  background:#0066ff; color:#fff; cursor:pointer;
}
</style>
</head>
<body>
<header>
  <span>Painel de Atendimento</span>
  <button onclick="abrirTutorial()">Como atender</button>
</header>
<div class="container">
  <h2>Solicitações em tempo real</h2>
  <div id="lista"></div>
  <div id="callArea">
    <h3 id="callNome"></h3>
    <p id="callCpf"></p>
    <p id="callProtocolo"></p>
    <p id="statusMsg">Em atendimento...</p>
    <p id="timer"></p>
    <p id="ping"></p>
    <button id="desligarBtn" onclick="encerrarChamada()">Desligar</button>
    <audio id="remoteAudio" autoplay></audio>
  </div>
</div>

<!-- Tutorial -->
<div id="tutorialOverlay">
  <div id="tutorialContent">
    <h2>Como atender</h2>
    <p>1. Clique em <strong>Atender</strong> para iniciar a chamada.</p>
    <p>2. Sempre cumprimente o cidadão usando o nome completo dele.</p>
    <p>3. Fale de forma clara e profissional.</p>
    <p>4. Se precisar encerrar, clique em <strong>Desligar</strong>.</p>
    <p>5. Se não puder atender, clique em <strong>Recusar</strong>.</p>
    <p>6. Observe o tempo da ligação e a qualidade da conexão.</p>
    <button onclick="fecharTutorial()">Entendi</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
<script>
let pc=null, localStream=null, currentRef=null, callTimer=null, startTime=null, pingInterval=null;

function abrirTutorial(){ document.getElementById('tutorialOverlay').style.display="flex"; }
function fecharTutorial(){ document.getElementById('tutorialOverlay').style.display="none"; }

// Listar solicitações em tempo real
db.ref('calls').on('value',snap=>{
  const lista=document.getElementById('lista');
  lista.innerHTML="";
  snap.forEach(item=>{
    const d=item.val();
    if(!d) return;
    if(d.status==='waiting'){
      const div=document.createElement('div');
      div.className="solicitacao";
      div.innerHTML=`
        <div class="solicitacao-info">
          <strong>${d.nome}</strong>
          <small>CPF: ${d.cpf}</small><br>
          <small>Protocolo: ${item.key}</small>
        </div>
        <div class="actions">
          <button class="atender" onclick="atender('${item.key}','${d.nome}','${d.cpf}')">Atender</button>
          <button class="recusar" onclick="recusar('${item.key}')">Recusar</button>
        </div>`;
      lista.appendChild(div);
    }
  });
});

async function atender(protocolo,nome,cpf){
  document.getElementById('callArea').style.display="block";
  document.getElementById('callNome').innerText=nome;
  document.getElementById('callCpf').innerText="CPF: "+cpf;
  document.getElementById('callProtocolo').innerText="Protocolo: "+protocolo;

  const ref=db.ref('calls/'+protocolo);
  currentRef=ref;
  await ref.update({status:'accepted'});

  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  pc=new RTCPeerConnection();

  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=e=>{
    document.getElementById('remoteAudio').srcObject=e.streams[0];
  };

  ref.child('offer').on('value',async s=>{
    if(s.exists() && !pc.currentRemoteDescription){
      const offer=new RTCSessionDescription(s.val());
      await pc.setRemoteDescription(offer);
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await ref.child('answer').set({type:answer.type,sdp:answer.sdp});
    }
  });

  ref.child('candidates/client').on('child_added',c=>{
    pc.addIceCandidate(new RTCIceCandidate(c.val()));
  });
  pc.onicecandidate=e=>{
    if(e.candidate){ ref.child('candidates/support').push(e.candidate.toJSON()); }
  };

  startTime=Date.now();
  callTimer=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-startTime)/1000);
    const min=String(Math.floor(elapsed/60)).padStart(2,'0');
    const sec=String(elapsed%60).padStart(2,'0');
    document.getElementById('timer').innerText=`Duração: ${min}:${sec}`;
  },1000);

  // Ping da conexão
  pingInterval=setInterval(()=>{
    const rtt=pc?.getStats?pc.getStats():null;
    if(rtt){
      rtt.then(stats=>{
        stats.forEach(report=>{
          if(report.type==='candidate-pair' && report.currentRoundTripTime){
            document.getElementById('ping').innerText="Ping: "+Math.round(report.currentRoundTripTime*1000)+" ms";
          }
        });
      });
    }
  },2000);

  ref.on('value',s=>{
    const d=s.val();
    if(!d) return;
    if(d.status==='ended'){ encerrarChamada(); }
  });
}

function recusar(protocolo){
  db.ref('calls/'+protocolo).update({status:'refused'});
  db.ref('calls/'+protocolo).remove();
}

function encerrarChamada(){
  if(currentRef){ currentRef.update({status:'ended'}); currentRef.remove(); }
  clearInterval(callTimer); clearInterval(pingInterval);
  if(pc){pc.close(); pc=null;}
  if(localStream){localStream.getTracks().forEach(t=>t.stop());}
  document.getElementById('callArea').style.display="none";
}
</script>
</body>
</html>

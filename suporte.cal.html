<!-- admincall.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel Suporte — Admin</title>
  <style>
    :root{--bg:#f7fbff;--accent:#0b4b7a;--muted:#6b6b6b}
    body{margin:0;font-family:Public Sans,system-ui, -apple-system, sans-serif;background:var(--bg)}
    header{background:#fff;padding:18px;border-bottom:1px solid #e6f0fa;display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;color:var(--accent);font-size:18px}
    #main{display:flex;gap:18px;padding:18px}
    #queues{width:420px;background:#fff;border-radius:10px;padding:12px;box-shadow:0 8px 30px rgba(6,20,40,0.06)}
    #detail{flex:1;background:#fff;border-radius:10px;padding:16px;box-shadow:0 8px 30px rgba(6,20,40,0.06)}
    .call-item{padding:10px;border-radius:8px;border:1px solid #eef7ff;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .call-item .meta{font-size:13px;color:var(--muted)}
    .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .btn.ghost{background:#f3f7fb;color:var(--accent)}
    .small{font-size:13px;color:var(--muted)}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:999}
    .overlay .box{background:#fff;padding:18px;border-radius:10px;width:min(720px,96%);}
  </style>
</head>
<body>
  <header>
    <h1>Painel de Atendimento — Suporte</h1>
    <div>
      <button id="howBtn" class="btn ghost">Como atender</button>
      <button id="refreshBtn" class="btn">Atualizar</button>
    </div>
  </header>

  <div id="main">
    <div id="queues">
      <h3>Chamadas em espera</h3>
      <div id="callsList"></div>
    </div>
    <div id="detail">
      <h3>Detalhes</h3>
      <div id="detailArea">
        <div class="small">Selecione uma chamada à esquerda</div>
      </div>
    </div>
  </div>

  <div class="overlay" id="howOverlay">
    <div class="box">
      <h3>Como atender</h3>
      <p>1. Clique em "Atender" — pegue o nome do cidadão e cumprimente-o pelo nome.<br>
         2. Fale claramente, confirme CPF, anote protocolo.<br>
         3. Seja educado, confirme solução e encerre. Use o botão "Desligar" para encerrar a ligação.<br>
         4. Não salvamos chamadas atendidas após o término.</p>
      <p><button id="closeHow">Fechar</button></p>
    </div>
  </div>

  <!-- Firebase compat + script.js -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="script.js"></script>

  <script>
    (function(){
      const callsList = document.getElementById('callsList');
      const detailArea = document.getElementById('detailArea');
      const howOverlay = document.getElementById('howOverlay');
      const howBtn = document.getElementById('howBtn');
      const closeHow = document.getElementById('closeHow');
      const refreshBtn = document.getElementById('refreshBtn');

      howBtn.onclick = ()=> howOverlay.style.display='flex';
      closeHow.onclick = ()=> howOverlay.style.display='none';
      refreshBtn.onclick = ()=> Calls.fetchWaiting().then(renderCalls);

      let selectedProtocol = null;
      let adminLocalStream = null;

      async function enableMic(){
        try{
          adminLocalStream = await navigator.mediaDevices.getUserMedia({audio:true});
        }catch(e){
          alert('Permissão de microfone negada. Habilite para atender chamadas.');
        }
      }

      enableMic();

      // render list (real-time binding inside Calls.listenWaiting)
      Calls.listenWaiting((list)=>{
        renderCalls(list);
      });

      function renderCalls(list){
        callsList.innerHTML = '';
        if(!list || list.length===0){
          callsList.innerHTML = '<div class="small">Nenhuma chamada</div>';
          return;
        }
        list.forEach(c=>{
          const div = document.createElement('div');
          div.className = 'call-item';
          div.innerHTML = `<div>
              <div style="font-weight:700">${c.nomeCompleto}</div>
              <div class="meta">CPF: ${c.cpf} • protocolo: ${c.protocol}</div>
            </div>
            <div>
              <button class="btn ghost" data-proto="${c.protocol}" data-action="view">Ver</button>
              <button class="btn" data-proto="${c.protocol}" data-action="accept">Atender</button>
              <button class="btn" style="background:#c0392b" data-proto="${c.protocol}" data-action="reject">Recusar</button>
            </div>`;
          callsList.appendChild(div);
        });
      }

      callsList.addEventListener('click', async (ev)=>{
        const btn = ev.target.closest('button');
        if(!btn) return;
        const proto = btn.dataset.proto;
        const action = btn.dataset.action;
        if(action==='view'){
          showDetails(proto);
        }else if(action==='accept'){
          await acceptCall(proto);
        }else if(action==='reject'){
          await Calls.rejectCall(proto);
        }
      });

      async function showDetails(proto){
        const data = await Calls.getCall(proto);
        detailArea.innerHTML = `<div><strong>${data.nomeCompleto}</strong></div>
          <div class="small">CPF: ${data.cpf}</div>
          <div class="small">Protocolo: ${data.protocol}</div>
          <div style="margin-top:12px">
            <button id="acceptNow" class="btn">Atender</button>
            <button id="rejectNow" class="btn ghost">Recusar</button>
          </div>
          <div id="adminCallBox"></div>`;
        document.getElementById('acceptNow').onclick = ()=> acceptCall(proto);
        document.getElementById('rejectNow').onclick = ()=> Calls.rejectCall(proto);
      }

      async function acceptCall(proto){
        // obtain mic if not
        if(!adminLocalStream){
          try{ adminLocalStream = await navigator.mediaDevices.getUserMedia({audio:true}); }
          catch(e){ alert('Permissão de microfone necessária.'); return; }
        }
        selectedProtocol = proto;
        detailArea.querySelector('#adminCallBox')?.innerHTML = '<div class="small">Conectando...</div>';
        // create offer as admin and attach local audio
        Calls.adminAccept(proto, adminLocalStream, onAdminCallUpdate);
      }

      function onAdminCallUpdate(data){
        // update UI
        if(!data) return;
        detailArea.querySelector('#adminCallBox').innerHTML = `
          <div class="small">Status: ${data.status}</div>
          <div class="small">Protocolo: ${data.protocol}</div>
          <div style="margin-top:8px">
            <button id="adminHang" class="btn" style="background:#c0392b">Desligar</button>
          </div>
          <audio id="adminRemote" autoplay></audio>
          <div class="small" id="adminTimer">Duração: 00:00</div>
          <div class="small" id="adminPing">Ping: --</div>
        `;
        const hang = document.getElementById('adminHang');
        hang.onclick = ()=> Calls.endCall(data.protocol, 'ended_by_support');
        const adminRemote = document.getElementById('adminRemote');

        // attach remote stream provided by Calls lib
        adminRemote.srcObject = Calls.getRemoteStream();

        if(data.status === 'in_call'){
          // start timer
          startAdminTimer(data.startedAt || Date.now());
        }else if(['ended','rejected','cancelled','no_answer'].includes(data.status)){
          // remove UI after short delay
          setTimeout(()=>{ detailArea.querySelector('#adminCallBox').innerHTML = ''; }, 1500);
        }
      }

      function startAdminTimer(startTs){
        const adminTimer = document.getElementById('adminTimer');
        if(!adminTimer) return;
        clearInterval(adminTimer._i);
        function update(){
          const diff = Math.max(0, Date.now()-startTs);
          const mm = String(Math.floor(diff/60000)).padStart(2,'0');
          const ss = String(Math.floor((diff%60000)/1000)).padStart(2,'0');
          adminTimer.textContent = `Duração: ${mm}:${ss}`;
        }
        update();
        adminTimer._i = setInterval(update,1000);
      }

      // expose for debug
      window._adminDebug = {acceptCall, showDetails};
    })();
  </script>
</body>
</html>

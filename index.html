<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Loja • Home</title>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    header { font-size:24px; display:flex; justify-content:space-between; }
    #saldo { font-size:48px; margin:20px 0; }
    button { margin:5px; padding:10px; }
    #barra { margin:10px 0; width:100%; padding:8px; }
    #lista { width:100%; border-collapse:collapse; }
    #lista th, #lista td { border:1px solid #aaa; padding:5px; text-align:left; }
    .alerta { background:#fdd; }
    .overlay{ position:fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;}
    .form{background:#fff; padding:20px;}
  </style>
</head>
<body>
  <header>
    <div>Loja</div>
    <button onclick="location='historico.html'">Histórico</button>
  </header>

  <div id="saldo">R$ 0,00</div>

  <button onclick="abrirFormProduto()">Cadastrar Produto</button>
  <button onclick="finalizarDia()">Finalizar Dia</button>
  <input id="barra" placeholder="Pesquisar produto...">

  <table id="lista">
    <thead><tr><th>Nome</th><th>Marca</th><th>Estoque</th><th>Preço V.</th><th>Preço C.</th><th>Ações</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="overlayProduto" class="overlay">
    <div class="form">
      <h3>Cadastrar Produto</h3>
      <input id="pNome" placeholder="Nome"><br>
      <input id="pMarca" placeholder="Marca"><br>
      <input id="pVista" placeholder="Preço à vista"><br>
      <input id="pCartao" placeholder="Preço cartão"><br>
      <input id="pEstoque" placeholder="Quantidade"><br>
      <button onclick="salvarProduto()">Cadastrar</button>
      <button onclick="fecharFormProduto()">Cancelar</button>
    </div>
  </div>

  <div id="overlayVenda" class="overlay">
    <div class="form">
      <h3>Vender Produto</h3>
      <input id="vQuantidade" type="number" placeholder="Quantidade"><br>
      <button onclick="confirmarVenda('vista')">Venda à vista</button>
      <button onclick="confirmarVenda('cartao')">Venda cartão</button>
      <button onclick="fecharVenda()">Cancelar</button>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCAlWxc7YxTMcTLCECUDuYfomO6QapreqY",
    authDomain: "login-you-see.firebaseapp.com",
    databaseURL: "https://login-you-see-default-rtdb.firebaseio.com",
    projectId: "login-you-see",
    storageBucket: "login-you-see.firebasestorage.app",
    messagingSenderId: "524877259374",
    appId: "1:524877259374:web:9ff66b67c9c5bf0bb07c7f",
    measurementId: "G-K7E00VXYHG"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const hoje = new Date().toISOString().split('T')[0];
  const refSaldo = db.ref('saldo/' + hoje);
  const refProd = db.ref('produtos');
  const refVenda = db.ref('vendas/' + hoje);

  let produtos = {}, vendendoProduto = null;

  refSaldo.on('value', s => {
    const v = s.val() || 0;
    document.getElementById('saldo').innerText = 'R$ ' + (v).toFixed(2).replace('.',',');
  });
  refProd.on('value', s => {
    produtos = s.val() || {};
    atualizarLista();
  });

  document.getElementById('barra').addEventListener('input', atualizarLista);

  function atualizarLista(){
    const q = document.getElementById('barra').value.toLowerCase();
    const tbody = document.querySelector('#lista tbody');
    tbody.innerHTML = '';
    Object.entries(produtos).filter(([,p])=>p.nome.toLowerCase().startsWith(q)).forEach(([k,p])=>{
      const tr = document.createElement('tr');
      if(p.estoque <=4) tr.classList.add('alerta');
      tr.innerHTML = `
        <td>${p.nome}</td><td>${p.marca}</td><td>${p.estoque}</td>
        <td>${p.vista.toFixed(2)}</td><td>${p.cartao.toFixed(2)}</td>
        <td><button onclick="editarProduto('${k}')">Editar</button>
            <button onclick="venderProduto('${k}')">Vender</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function abrirFormProduto(){
    document.getElementById('overlayProduto').style.display='flex';
  }
  function fecharFormProduto(){
    document.getElementById('overlayProduto').style.display='none';
  }
  function salvarProduto(){
    const n = document.getElementById('pNome').value;
    const m = document.getElementById('pMarca').value;
    const v = parseFloat(document.getElementById('pVista').value);
    const c = parseFloat(document.getElementById('pCartao').value);
    const e = parseInt(document.getElementById('pEstoque').value);
    if(n && m && !isNaN(v) && !isNaN(c) && !isNaN(e)){
      refProd.push({nome:n,marca:m,vista:v,cartao:c,estoque:e});
      fecharFormProduto();
    }
  }

  function editarProduto(k){
    const nova = prompt('Nova quantidade em estoque:',produtos[k].estoque);
    const e = parseInt(nova);
    if(!isNaN(e)){
      refProd.child(k+'/estoque').set(e);
    }
  }

  function venderProduto(k){
    vendendoProduto = k;
    document.getElementById('overlayVenda').style.display='flex';
  }
  function fecharVenda(){
    vendendoProduto = null;
    document.getElementById('overlayVenda').style.display='none';
  }

  function confirmarVenda(tipo){
    const q = parseInt(document.getElementById('vQuantidade').value);
    if(!vendendoProduto|| isNaN(q)|| q<=0) return;
    const p = produtos[vendendoProduto];
    const preco = tipo=='vista'? p.vista : p.cartao;
    const total = preco * q;
    const updates = {};
    updates['saldo/'+hoje] = ( (document.getElementById('saldo').innerText.match(/[\d,\.]+/)[0].replace(',','.')) *1 + total );
    updates['produtos/'+vendendoProduto+'/estoque'] = p.estoque - q;
    refVenda.push({produto: p.nome, tipo, quantidade:q, preco, hora:new Date().toLocaleTimeString() });
    db.ref().update(updates);
    fecharVenda();
  }

  function finalizarDia(){
    refVenda.once('value', s=>{
      const vendas = s.val()||{};
      let ticket='Vendas do dia:\n';
      let tot=0;
      Object.values(vendas).forEach(v=>{
        ticket += `${v.hora} • ${v.produto} x${v.quantidade} (${v.tipo}) = ${v.preco* v.quantidade}\n`;
        tot += v.preco* v.quantidade;
      });
      ticket += `Total: ${tot.toFixed(2).replace('.',',')}`;
      if(confirm(ticket + '\n\nCONCORDO e FINALIZO?')){
        refSaldo.remove();
        window.location='historico.html';
      }
    });
  }
</script>
</body>
</html>


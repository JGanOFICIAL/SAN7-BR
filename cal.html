<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Central de Atendimento</title>
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  margin:0; font-family:'Public Sans',sans-serif; background:#fff; color:#222;
  display:flex; justify-content:center; align-items:center; height:100vh;
}
.container {
  width:100%; max-width:400px; background:#f9f9f9; padding:30px; border-radius:12px;
  box-shadow:0 4px 16px rgba(0,0,0,0.1); text-align:center;
}
h1 { font-size:20px; margin-bottom:20px; color:#111; }
input {
  width:100%; padding:12px; margin:10px 0; border:1px solid #ccc; border-radius:8px;
}
button {
  background:#0066ff; color:#fff; border:none; padding:12px 20px; border-radius:8px;
  font-size:16px; cursor:pointer; width:100%; margin-top:10px;
}
button:hover { background:#0051cc; }
.status { margin-top:20px; font-weight:600; }
.timer { margin-top:10px; font-size:14px; color:#666; }
audio { display:none; }
</style>
</head>
<body>
<div class="container">
  <h1>Central de Atendimento</h1>
  <div id="form">
    <input type="text" id="nome" placeholder="Nome completo">
    <input type="text" id="cpf" placeholder="CPF">
    <button onclick="iniciarAtendimento()">Solicitar Atendimento</button>
  </div>
  <div id="statusArea" style="display:none;">
    <p class="status" id="statusMsg">Aguardando atendente. Por favor aguarde! Pode levar alguns minutos.</p>
    <p id="protocolo"></p>
    <p class="timer" id="timer"></p>
    <button id="cancelarBtn" onclick="cancelarAtendimento()">Cancelar Solicitação</button>
    <button id="desligarBtn" style="display:none;" onclick="desligar()">Desligar</button>
  </div>
  <audio id="remoteAudio" autoplay></audio>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
<script>
let protocolo=null, localStream=null, pc=null, callTimer=null, startTime=null;

async function iniciarAtendimento(){
  const nome=document.getElementById('nome').value.trim();
  const cpf=document.getElementById('cpf').value.trim();
  if(!nome||!cpf){alert("Preencha todos os campos");return;}
  protocolo=String(Math.floor(Math.random()*1e12)).padStart(12,'0');
  document.getElementById('form').style.display="none";
  document.getElementById('statusArea').style.display="block";
  document.getElementById('protocolo').innerText="Protocolo: "+protocolo;

  const callRef=db.ref('calls/'+protocolo);
  await callRef.set({
    nome, cpf, status:'waiting', createdAt:Date.now()
  });

  // Timer 10min
  setTimeout(()=>{
    callRef.once('value').then(s=>{
      if(s.exists() && s.val().status==='waiting'){
        document.getElementById('statusMsg').innerText="Não atendido";
        cancelarAtendimento();
      }
    });
  },600000);

  callRef.on('value',snap=>{
    const data=snap.val(); if(!data) return;
    if(data.status==='accepted'){ iniciarChamada(callRef); }
    if(data.status==='ended'){ encerrarUI("Desligado"); }
    if(data.status==='refused'){ encerrarUI("Chamado recusado"); }
  });
}

async function iniciarChamada(ref){
  document.getElementById('statusMsg').innerText="Em atendimento";
  document.getElementById('cancelarBtn').style.display="none";
  document.getElementById('desligarBtn').style.display="inline-block";

  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  pc=new RTCPeerConnection();

  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack=e=>{
    document.getElementById('remoteAudio').srcObject=e.streams[0];
  };

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await ref.child('offer').set({type:offer.type,sdp:offer.sdp});

  ref.child('answer').on('value',async s=>{
    if(s.exists() && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(s.val()));
    }
  });

  ref.child('candidates/support').on('child_added',c=>{
    pc.addIceCandidate(new RTCIceCandidate(c.val()));
  });
  pc.onicecandidate=e=>{
    if(e.candidate){ ref.child('candidates/client').push(e.candidate.toJSON()); }
  };

  startTime=Date.now();
  callTimer=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-startTime)/1000);
    const min=String(Math.floor(elapsed/60)).padStart(2,'0');
    const sec=String(elapsed%60).padStart(2,'0');
    document.getElementById('timer').innerText=`Duração: ${min}:${sec}`;
  },1000);
}

function cancelarAtendimento(){
  if(protocolo){ db.ref('calls/'+protocolo).remove(); }
  encerrarUI("Cancelado");
}
function desligar(){
  if(protocolo){ db.ref('calls/'+protocolo+'/status').set('ended'); }
  encerrarUI("Desligado");
}
function encerrarUI(msg){
  document.getElementById('statusMsg').innerText=msg;
  document.getElementById('desligarBtn').style.display="none";
  document.getElementById('cancelarBtn').style.display="none";
  clearInterval(callTimer);
  if(pc){pc.close(); pc=null;}
  if(localStream){localStream.getTracks().forEach(t=>t.stop());}
}
</script>
</body>
</html>

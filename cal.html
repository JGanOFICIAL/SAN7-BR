<!-- embed.html -->
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Central de Atendimento - Cliente</title>
<style>
  :root{--bg:#fff;--accent:#0b4a9b;--danger:#d9534f;--muted:#777;font-family:Inter,Roboto,sans-serif}
  body{margin:0;background:var(--bg)}
  .box{max-width:420px;margin:20px auto;padding:20px;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,0.1)}
  h1{font-size:18px;margin:0;color:var(--accent)}
  label{display:block;margin-top:12px;font-size:14px}
  input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin-top:6px}
  .btn{margin-top:14px;padding:10px 14px;border:0;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
  .btn.danger{background:var(--danger)}
  .hidden{display:none}
  #status{margin-top:12px;padding:12px;background:#f3f6ff;border-radius:8px;font-size:14px}
</style>
</head>
<body>
<div class="box">
  <h1>Atendimento</h1>
  <div id="formArea">
    <label>Nome completo<input id="fullname"/></label>
    <label>CPF<input id="cpf"/></label>
    <button id="startBtn" class="btn">Iniciar</button>
  </div>
  <div id="callArea" class="hidden">
    <div id="status"></div>
    <button id="cancelBtn" class="btn danger">Cancelar</button>
    <button id="hangBtn" class="btn danger hidden">Desligar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
<script>
const db=firebase.database();let pc,localStream,protocol;
const startBtn=document.getElementById('startBtn'),statusEl=document.getElementById('status'),
cancelBtn=document.getElementById('cancelBtn'),hangBtn=document.getElementById('hangBtn'),
formArea=document.getElementById('formArea'),callArea=document.getElementById('callArea');
function genProt(){return Math.random().toString().slice(2,14)}
async function startCall(){
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  protocol=genProt();const callRef=db.ref('calls/'+protocol);
  await callRef.set({status:'waiting',name:fullname.value,cpf:cpf.value});
  formArea.classList.add('hidden');callArea.classList.remove('hidden');statusEl.textContent='Aguardando atendente...';
  callRef.on('value',async s=>{
    const v=s.val();if(!v)return;
    if(v.status==='in_call'&&!pc){statusEl.textContent='Conectado';await asCaller(callRef)}
    if(v.status==='finished'){statusEl.textContent='Finalizado';hangBtn.classList.add('hidden')}
  });
}
async function asCaller(ref){
  pc=new RTCPeerConnection();localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  const remote=new Audio();remote.autoplay=true;pc.ontrack=e=>remote.srcObject=e.streams[0];
  pc.onicecandidate=e=>{if(e.candidate)ref.child('callerCandidates').push(e.candidate.toJSON())};
  const offer=await pc.createOffer();await pc.setLocalDescription(offer);
  await ref.update({offer:{type:offer.type,sdp:offer.sdp}});
  ref.child('answer').on('value',async snap=>{
    const ans=snap.val();if(ans&&!pc.currentRemoteDescription)await pc.setRemoteDescription(new RTCSessionDescription(ans));
  });
  ref.child('calleeCandidates').on('child_added',snap=>{
    pc.addIceCandidate(new RTCIceCandidate(snap.val()))
  });
  hangBtn.classList.remove('hidden');
}
startBtn.onclick=startCall;
cancelBtn.onclick=()=>{db.ref('calls/'+protocol).update({status:'cancelled'})};
hangBtn.onclick=()=>{db.ref('calls/'+protocol).update({status:'finished'})};
</script>
</body>
</html>

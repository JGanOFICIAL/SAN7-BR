<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Central de Atendimento — Cidadão</title>

<!-- Styles: moderno, branco -->
<style>
  :root{
    --accent:#0b74ff;
    --muted:#707785;
    --bg:#ffffff;
    --surface:#fbfdff;
    --shadow: 0 6px 20px rgba(11,20,40,0.06);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#0b1b2b}
  .container{max-width:920px;margin:32px auto;padding:28px;background:var(--surface);box-shadow:var(--shadow);border-radius:14px;}
  header{display:flex;align-items:center;gap:16px}
  header h1{margin:0;font-size:20px}
  .brand-dot{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#00c2ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  form{margin-top:22px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #e6eef7;background:white;font-size:15px;box-sizing:border-box}
  .full{grid-column:1/-1}
  .actions{display:flex;gap:10px;align-items:center;margin-top:14px}
  button{padding:12px 16px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,116,255,0.12)}
  .panel{margin-top:18px;padding:16px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 4px 12px rgba(15,23,42,0.04)}
  .status{font-size:15px;color:var(--muted)}
  .protocol{font-weight:700;font-size:18px;color:#0b2b4a}
  .small{font-size:13px;color:var(--muted)}
  .hidden{display:none}
  .controls{display:flex;gap:10px;margin-top:12px}
  .danger{background:#ff4757;color:white}
  .row{display:flex;gap:10px;align-items:center}
  .ping-badge{margin-left:auto;background:#f1f6ff;padding:6px 10px;border-radius:999px;font-weight:600}
  .mini{font-size:12px;color:var(--muted)}
  footer{margin-top:18px;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
  @media (max-width:720px){
    .container{margin:12px;padding:16px}
    form{grid-template-columns:1fr}
  }
</style>

</head>
<body>
  <div class="container" role="main">
    <header>
      <div class="brand-dot">AT</div>
      <div>
        <h1>Central de Atendimento</h1>
        <div class="small">Atendimento por voz em tempo real</div>
      </div>
      <div style="margin-left:auto" class="ping-badge" id="userPing">ping: --</div>
    </header>

    <form id="callForm" autocomplete="off" onsubmit="return false;">
      <div class="full">
        <label for="nome">Nome completo</label>
        <input id="nome" required placeholder="Seu nome completo"/>
      </div>

      <div>
        <label for="cpf">CPF</label>
        <input id="cpf" required placeholder="000.000.000-00" maxlength="14"/>
      </div>

      <div>
        <label for="obs">Observação (opcional)</label>
        <input id="obs" placeholder="Ex.: motivo do contato (opcional)"/>
      </div>

      <div class="full actions">
        <button id="btnStart">Iniciar Atendimento</button>
        <button id="btnCancel" class="ghost" type="button">Cancelar</button>
      </div>
    </form>

    <div class="panel" id="panelWaiting" style="display:none">
      <div class="row">
        <div>
          <div class="status">Protocolo</div>
          <div class="protocol" id="protocolNumber">—</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div class="small">Status</div>
          <div id="statusText">Aguardando atendente</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Aguardando atendente. Por favor aguarde! Pode levar alguns minutos.</div>
      </div>

      <div class="controls" id="inCallControls" style="display:none">
        <button id="btnHangup" class="danger">Desligar</button>
      </div>

      <div class="controls" id="preCallControls" style="margin-top:12px">
        <button id="btnCancelRequest" class="ghost">Cancelar solicitação</button>
      </div>
    </div>

    <footer>
      <div class="mini">Conexão: <span id="netQuality">—</span></div>
      <div class="mini">Autenticação segura via Firebase</div>
    </footer>
  </div>

  <!-- Firebase compat SDKs e script.js (usuário pediu estes caminhos) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="script.js"></script>

  <script>
    // Client-side flow using functions implemented in script.js
    (function(){
      // elements
      const nomeEl = document.getElementById('nome');
      const cpfEl = document.getElementById('cpf');
      const obsEl = document.getElementById('obs');
      const btnStart = document.getElementById('btnStart');
      const btnCancel = document.getElementById('btnCancel');
      const panel = document.getElementById('panelWaiting');
      const protocolNumberEl = document.getElementById('protocolNumber');
      const statusText = document.getElementById('statusText');
      const btnCancelRequest = document.getElementById('btnCancelRequest');
      const btnHangup = document.getElementById('btnHangup');
      const inCallControls = document.getElementById('inCallControls');
      const preCallControls = document.getElementById('preCallControls');
      const userPing = document.getElementById('userPing');
      const netQuality = document.getElementById('netQuality');

      let currentProtocol = null;
      let localStream = null;
      let deviceId = localStorage.getItem('deviceId') || ('d-'+Math.random().toString(36).slice(2,10));
      localStorage.setItem('deviceId', deviceId);

      // request microphone immediately (will be asked later too)
      async function requestMicFirst(){
        try{
          await navigator.mediaDevices.getUserMedia({audio:true});
        }catch(e){
          console.warn('Mic permission not granted yet.', e);
        }
      }
      requestMicFirst();

      // format CPF simple
      cpfEl.addEventListener('input', (e)=>{
        let v = e.target.value.replace(/\D/g,'').slice(0,11);
        v = v.replace(/^(\d{3})(\d)/,'$1.$2');
        v = v.replace(/^(\d{3})\.(\d{3})(\d)/,'$1.$2.$3');
        v = v.replace(/\.(\d{3})(\d)/,'.$1-$2');
        e.target.value = v;
      });

      function updatePingUI(ms){
        userPing.textContent = 'ping: ' + (ms ? ms + 'ms' : '--');
      }

      // Start call
      btnStart.addEventListener('click', async ()=>{
        const nome = nomeEl.value.trim();
        const cpf = cpfEl.value.trim();
        const obs = obsEl.value.trim();
        if(!nome || !cpf){ alert('Preencha nome e CPF'); return; }

        try{
          // create call via function in script.js: createCallForCitizen
          const result = await createCallForCitizen({nomeCompleto:nome, cpf, obs, deviceId});
          currentProtocol = result.protocol;
          protocolNumberEl.textContent = currentProtocol;
          panel.style.display = 'block';
          statusText.textContent = 'Aguardando atendente';
          // listen for updates
          listenCallUpdates(currentProtocol, async (snap)=>{
            if(!snap){ // removed
              statusText.textContent = 'Finalizado';
              panel.style.display = 'none';
              currentProtocol = null;
              stopLocalStream();
              return;
            }
            const data = snap;
            statusText.textContent = getStatusLabel(data.status);
            if(data.status === 'accepted' && data.supportId){
              // start WebRTC as caller
              preCallControls.style.display = 'none';
              inCallControls.style.display = 'flex';
              await startAsCaller(currentProtocol);
            }
            if(data.status === 'in-call'){
              preCallControls.style.display = 'none';
              inCallControls.style.display = 'flex';
            }
            if(data.status === 'not-answered' || data.status==='rejected'){
              // show message and clear after short delay
              statusText.textContent = data.status === 'not-answered' ? 'Não atendido' : 'Recusado';
              setTimeout(()=>{ panel.style.display='none'; }, 3000);
            }
            // update ping UI if present
            if(data.ping && data.ping.client){
              updatePingUI(data.ping.client);
            }
          });

          // show ping updates (local ping computation)
          startPingLoopForCall(currentProtocol, (ms)=>{
            netQuality.textContent = (ms < 200 ? 'boa' : (ms < 500 ? 'ok' : 'ruim')) + ' ('+ms+'ms)';
            updatePingUI(ms);
          });

        }catch(err){
          alert('Erro ao iniciar: ' + (err.message || err));
          console.error(err);
        }
      });

      btnCancel.addEventListener('click', ()=>{ // reset form
        document.getElementById('callForm').reset();
      });

      btnCancelRequest.addEventListener('click', async ()=>{
        if(!currentProtocol) return;
        await cancelCall(currentProtocol, {initiator:'user'});
        panel.style.display = 'none';
        stopLocalStream();
        currentProtocol = null;
      });

      btnHangup.addEventListener('click', async ()=>{
        if(!currentProtocol) return;
        await hangupCall(currentProtocol, {by:'user'});
        panel.style.display = 'none';
        stopLocalStream();
        currentProtocol = null;
      });

      // helpers
      function getStatusLabel(s){
        switch(s){
          case 'waiting': return 'Aguardando atendente';
          case 'accepted': return 'Conectando...';
          case 'in-call': return 'Em chamada';
          case 'rejected': return 'Recusado';
          case 'ended': return 'Desligado';
          case 'not-answered': return 'Não atendido';
          default: return s || '—';
        }
      }

      function stopLocalStream(){
        try{ if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; } }catch(e){}
      }

      // expose some functions for debugging (they are implemented in script.js)
      window.__u = { startAsCaller, stopLocalStream };

    })();
  </script>
</body>
</html>

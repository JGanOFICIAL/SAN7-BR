<!-- widget.html - incorporar em outros -->
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Central de Atendimento — Cidadão</title>

<!-- Firebase compat scripts (caminhos que você indicou) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{--accent:#0b67a3;--bg:#ffffff;--muted:#6b7280;--danger:#dc2626}
  html,body{height:100%;margin:0;font-family:'Public Sans',system-ui,Arial;background:var(--bg);color:#111}
  .widget{max-width:420px;margin:18px auto;padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.08);background:#fff;border:1px solid #f1f5f9}
  .logo{display:flex;align-items:center;gap:12px}
  .logo .mark{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#0477b9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  h1{font-size:18px;margin:12px 0 6px}
  p.lead{margin:0;color:var(--muted);font-size:14px}
  form{margin-top:16px;display:grid;gap:10px}
  input{padding:12px;border-radius:8px;border:1px solid #e6eef8;font-size:14px;outline:none}
  input:focus{box-shadow:0 0 0 4px rgba(11,103,163,0.08);border-color:var(--accent)}
  .btn{padding:12px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#eef4fb;color:var(--accent);border:1px solid #d6eaf8}
  .status{margin-top:12px;padding:12px;border-radius:10px;background:#f8fafc;border:1px dashed #e6eef8;font-size:14px}
  .protocol{font-family:monospace;font-weight:700}
  .actions{display:flex;gap:8px;margin-top:10px}
  .small{font-size:13px;color:var(--muted)}
  .floating-cancel{margin-top:8px;background:#fff;border:1px solid #f1f5f9;padding:10px;border-radius:8px}
  .mic-pulse{display:inline-block;width:10px;height:10px;border-radius:50%;background:#10b981;margin-left:8px;animation:pulse 1.4s infinite}
  @keyframes pulse{0%{transform:scale(.9);opacity:1}50%{transform:scale(1.4);opacity:.5}100%{transform:scale(.9);opacity:1}}
  .call-controls{display:flex;gap:8px;margin-top:12px}
  .square{padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fff}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;font-weight:600}
</style>
</head>
<body>
<div class="widget" id="widget">
  <div class="logo">
    <div class="mark">CR</div>
    <div>
      <h1>Central de Atendimento</h1>
      <p class="lead">Fale com um atendente — gratuito e em tempo real</p>
    </div>
  </div>

  <div id="formWrap">
    <form id="callForm" onsubmit="return false">
      <input id="nome" placeholder="Nome completo" required />
      <input id="cpf" placeholder="CPF (somente números ou formatado)" required />
      <div style="display:flex;gap:8px">
        <button id="startBtn" class="btn" type="button">Iniciar atendimento</button>
        <button id="clearBtn" class="btn secondary" type="button">Limpar</button>
      </div>
      <p class="small">Ao iniciar, pediremos acesso ao microfone. Não gravamos chamadas após encerrar.</p>
    </form>
  </div>

  <div id="statusWrap" style="display:none">
    <div class="status" id="statusBox">
      <div><strong id="statusTitle">Aguardando</strong> <span id="statusBadge" class="badge">Aguardando atendente</span></div>
      <div style="margin-top:8px">Protocolo: <span class="protocol" id="protocolTxt">—</span></div>
      <div style="margin-top:6px" class="small">Tempo: <span id="timeElapsed">00:00</span></div>
      <div id="callControls" class="call-controls">
        <button id="cancelBtn" class="square">Cancelar solicitação</button>
        <button id="hangupBtn" class="square" style="display:none;background:#fff;border:1px solid #f1f5f9">Desligar</button>
      </div>
      <div id="connectionPing" class="small muted" style="margin-top:8px">Conexão: <span id="pingVal">—</span></div>
    </div>
  </div>
</div>

<script src="script.js"></script>
<script>
/* Widget-specific logic: usa funções do script.js globalmente exportadas */
(async function(){
  const nomeEl=document.getElementById('nome');
  const cpfEl=document.getElementById('cpf');
  const startBtn=document.getElementById('startBtn');
  const clearBtn=document.getElementById('clearBtn');
  const statusWrap=document.getElementById('statusWrap');
  const statusTitle=document.getElementById('statusTitle');
  const protocolTxt=document.getElementById('protocolTxt');
  const timeElapsed=document.getElementById('timeElapsed');
  const cancelBtn=document.getElementById('cancelBtn');
  const hangupBtn=document.getElementById('hangupBtn');
  const pingVal=document.getElementById('pingVal');
  const statusBadge=document.getElementById('statusBadge');

  let session = null; // objeto retornado por script.js quando iniciar chamada
  let timerInt=null;

  function formatTime(sec){
    const mm=String(Math.floor(sec/60)).padStart(2,'0');
    const ss=String(sec%60).padStart(2,'0');
    return mm+':'+ss;
  }

  startBtn.onclick = async ()=>{
    const nome=nomeEl.value.trim();
    const cpf=cpfEl.value.trim();
    if(!nome || !cpf){ alert('Preencha nome e CPF'); return; }

    // chama função global iniciarChamadaCidadao(nome,cpf) definida em script.js
    try{
      startBtn.disabled=true;
      session = await iniciarChamadaCidadao({nomeCompleto:nome, cpf});
      // session tem {protocol, hangup, onStatus, onPing}
      document.getElementById('formWrap').style.display='none';
      statusWrap.style.display='block';
      protocolTxt.textContent=session.protocol;
      statusTitle.textContent='Aguardando';
      statusBadge.textContent='Aguardando atendente';
      let elapsed=0;
      timerInt=setInterval(()=>{ elapsed++; timeElapsed.textContent=formatTime(elapsed); },1000);

      // Hooks
      session.onStatus((s)=>{
        // s = 'ringing'|'in_call'|'ended'|'not_answered'|'canceled'
        if(s==='in_call'){
          statusTitle.textContent='Em chamada';
          statusBadge.textContent='Ligado ao suporte';
          hangupBtn.style.display='inline-block';
          cancelBtn.style.display='none';
        }else if(s==='ended'){
          statusTitle.textContent='Desligado';
          statusBadge.textContent='Desligado';
          hangupBtn.style.display='none';
          cancelBtn.style.display='none';
          cleanup();
        }else if(s==='not_answered'){
          statusTitle.textContent='Não atendido';
          statusBadge.textContent='Não atendido';
          cancelBtn.style.display='none';
          hangupBtn.style.display='none';
          cleanup();
        }else if(s==='canceled'){
          statusTitle.textContent='Cancelado';
          statusBadge.textContent='Cancelado';
          cancelBtn.style.display='none';
          hangupBtn.style.display='none';
          cleanup();
        }else if(s==='ringing'){
          statusTitle.textContent='Chamando';
          statusBadge.textContent='Chamando suporte...';
        }
      });

      session.onPing((ms)=>{
        pingVal.textContent = ms + ' ms';
      });

      cancelBtn.onclick = async ()=>{
        await session.cancel();
      };
      hangupBtn.onclick = async ()=>{
        await session.hangup();
      };

    }catch(err){
      alert('Erro ao iniciar: '+(err?.message||err));
      startBtn.disabled=false;
    }
  };

  clearBtn.onclick = ()=>{ nomeEl.value=''; cpfEl.value=''; };
  function cleanup(){
    if(timerInt){ clearInterval(timerInt); timerInt=null; }
  }

})();
</script>
</body>
</html>

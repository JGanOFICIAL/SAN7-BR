<!-- ===== central-atendimento-fragment.html (sem DOCTYPE - incorporar) ===== -->
<!-- Layout branco, moderno. Este bloco requisita mic ao entrar. -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#ffffff;
    --muted:#6b7280;
    --accent:#0f172a;
    --primary:#0b5fff;
    --danger:#ef4444;
    --card-shadow: 0 8px 24px rgba(15,23,42,0.06);
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  }
  .atendimento-card{
    background:var(--bg);
    width:100%;
    max-width:720px;
    margin:18px auto;
    border-radius:14px;
    padding:20px;
    box-shadow:var(--card-shadow);
    border:1px solid rgba(15,23,42,0.04);
  }
  .at-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .brand{
    display:flex;align-items:center;gap:12px;
  }
  .brand .logo{
    width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#eef2ff,#e6f0ff);
    display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);
  }
  h2{margin:0;font-size:18px;color:var(--accent)}
  p.muted{margin:6px 0 0;color:var(--muted);font-size:13px}
  .form-row{display:flex;gap:12px;margin-top:14px}
  .form-row input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);font-size:14px}
  .btn{
    background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer;
    box-shadow: 0 6px 18px rgba(11,95,255,0.12);
  }
  .btn.ghost{background:transparent;color:var(--primary);box-shadow:none;border:1px solid rgba(11,95,255,0.12)}
  .status{
    margin-top:14px;padding:12px;border-radius:10px;background:#f8fafc;border:1px solid rgba(15,23,42,0.03);
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .small{font-size:13px;color:var(--muted)}
  .protocol{
    font-weight:700;color:var(--primary);letter-spacing:1px;
  }
  .call-controls{display:flex;gap:8px;align-items:center}
  .danger{background:var(--danger);color:#fff}
  .timeline{
    margin-top:14px;border-left:3px solid rgba(11,95,255,0.06);padding-left:12px;
  }
  .timeline .item{margin-bottom:8px;font-size:13px;color:var(--muted)}
  .ping{font-size:12px;color:var(--muted);margin-top:8px}
  audio#remoteAudio{display:none}
</style>

<div class="atendimento-card" id="atendimentoCard">
  <div class="at-top">
    <div class="brand">
      <div class="logo">AT</div>
      <div>
        <h2>Central de Atendimento</h2>
        <p class="muted">Fale com o suporte — atendimento em tempo real</p>
      </div>
    </div>
    <div class="call-info small">
      <div id="connectionPing">Ping: —</div>
      <div id="connStatus">Conexão: desconhecida</div>
    </div>
  </div>

  <div id="formArea" style="margin-top:12px">
    <div class="form-row">
      <input id="inputNome" placeholder="Nome completo" autocomplete="name" />
      <input id="inputCPF" placeholder="CPF (somente números)" inputmode="numeric" />
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="btnSolicitar">Solicitar Atendimento</button>
      <button class="btn ghost" id="btnCancelarSolicitacao" style="display:none">Cancelar</button>
    </div>
  </div>

  <div id="waitingArea" style="display:none">
    <div class="status">
      <div>
        <div class="small">Protocolo</div>
        <div class="protocol" id="protocolValue">—</div>
        <div class="small" id="waitingMsg">Aguardando atendente. Por favor aguarde! Pode levar alguns minutos.</div>
      </div>
      <div class="call-controls">
        <button class="btn ghost" id="btnMute" style="display:none">Silenciar</button>
        <button class="btn danger" id="btnHangup">Cancelar</button>
      </div>
    </div>

    <div class="timeline" id="timeline">
      <div class="item">Status: <span id="callStatus">aguardando</span></div>
      <div class="item">Tempo em espera: <span id="waitTimer">00:00</span></div>
      <div class="item">Assistente: <span id="agentName">—</span></div>
    </div>
    <div class="ping" id="audioHint">Microfone: aguardando permissão.</div>
    <audio id="remoteAudio" autoplay></audio>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
<script>
  // Inicialização do fragmento: funções públicas do script.js serão usadas aqui.
  (function(){
    const $ = id => document.getElementById(id);
    const inputNome = $('inputNome'), inputCPF = $('inputCPF');
    const btnSolicitar = $('btnSolicitar'), btnCancelarSolicitacao = $('btnCancelarSolicitacao');
    const waitingArea = $('waitingArea'), formArea = $('formArea');
    const protocolValue = $('protocolValue'), callStatus = $('callStatus'), waitTimer = $('waitTimer');
    const agentName = $('agentName'), btnHangup = $('btnHangup');
    const connPing = $('connectionPing'), connStatus = $('connStatus'), audioHint = $('audioHint'), remoteAudio = $('remoteAudio');
    const btnMute = $('btnMute');

    // Helpers
    function onlyDigitsLocal(s){ return (s||'').replace(/\D/g,''); }
    function genProtocol(){ // 12 dígitos
      const n = Math.floor(Math.random()*1e12).toString().padStart(12,'0');
      return n;
    }

    let currentCall = null;
    let waitInterval = null;

    async function requestMicrophone(){ 
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        audioHint.textContent = 'Microfone autorizado.';
        // send local preview? we won't attach here; script.js will handle capture via startLocalCall
        stream.getTracks().forEach(t=>t.stop());
        return true;
      }catch(e){
        audioHint.textContent = 'Permissão de microfone negada.';
        return false;
      }
    }

    // show ping (from script.js pingProbe)
    window.__onPingUpdate = (ms)=>{
      connPing.textContent = 'Ping: ' + (ms===null? '—': ms + ' ms');
    };
    window.__onConnState = (s)=>{ connStatus.textContent = 'Conexão: '+ s; };

    // On call state changes coming from script.js
    window.__onClientCallUpdate = ({protocol, status, startedAt, agent, reason})=>{
      if(!protocol){ // cleared
        currentCall = null;
        protocolValue.textContent = '—';
        callStatus.textContent = 'nenhuma';
        formArea.style.display = '';
        waitingArea.style.display = 'none';
        btnCancelarSolicitacao.style.display = 'none';
        if(waitInterval) { clearInterval(waitInterval); waitInterval = null; }
        return;
      }
      currentCall = protocol;
      protocolValue.textContent = protocol;
      callStatus.textContent = status || 'aguardando';
      agentName.textContent = agent || '—';
      formArea.style.display = 'none';
      waitingArea.style.display = '';
      btnCancelarSolicitacao.style.display = 'inline-block';

      if(!waitInterval){
        const started = startedAt || Date.now();
        waitInterval = setInterval(()=>{
          const diff = Math.max(0, Date.now() - started);
          const mm = String(Math.floor(diff/60000)).padStart(2,'0');
          const ss = String(Math.floor(diff%60000/1000)).padStart(2,'0');
          waitTimer.textContent = `${mm}:${ss}`;
          // if > 10 minutes update status locally (but backend handles too)
          if(diff > 10*60*1000 && callStatus.textContent !== 'não atendido'){
            callStatus.textContent = 'não atendido';
          }
        }, 1000);
      }
    };

    // Buttons
    btnSolicitar.addEventListener('click', async ()=>{
      const nome = inputNome.value.trim();
      const cpf = onlyDigitsLocal(inputCPF.value);
      if(!nome || cpf.length < 11){ alert('Informe nome completo e CPF válido.'); return; }
      // request mic
      await requestMicrophone();
      const protocol = genProtocol();
      // create call entry via script.js
      try{
        await window.appStartClientCall({protocol, nome, cpf});
        // UI will be updated via __onClientCallUpdate
      }catch(err){
        alert('Erro ao criar solicitação: '+(err?.message||err));
      }
    });

    btnCancelarSolicitacao.addEventListener('click', async ()=>{
      if(!currentCall){ return; }
      await window.appClientCancel(currentCall);
    });

    btnHangup.addEventListener('click', async ()=>{
      if(!currentCall) return;
      await window.appClientCancel(currentCall);
    });

    btnMute.addEventListener('click', ()=>{
      window.appToggleMute && window.appToggleMute();
      btnMute.textContent = (btnMute.textContent === 'Silenciar') ? 'Ativar som' : 'Silenciar';
    });

    // Remote audio attach point
    window.__attachRemoteAudio = (stream)=>{
      remoteAudio.srcObject = stream;
      remoteAudio.play().catch(()=>{});
    };

    // Init ping probe
    window.appInitClientUI && window.appInitClientUI();

    // On load, try to detect mic permission silently
    navigator.permissions && navigator.permissions.query({name:'microphone'}).then(p=>{
      if(p.state === 'granted') audioHint.textContent = 'Microfone: autorizado.';
    }).catch(()=>{});
  })();
</script>

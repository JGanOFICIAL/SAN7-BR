<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificação de Comprovante - DomusFit</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* VARIÁVEIS DE CORES */
        :root {
            --primary-color: #003366; /* Azul Escuro DomusFit */
            --secondary-color: #0066cc; /* Azul Claro para Destaques */
            --background-light: #f5f8ff; /* Fundo Levemente Azulado */
            --text-dark: #333;
            --text-light: #fff;
            --border-color: #ddd;
        }

        /* ESTILO GERAL */
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background-light);
            color: var(--text-dark);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 850px;
            background: var(--text-light);
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        /* CABEÇALHO DA DOMUSFIT */
        .header-scan {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
        }
        .header-scan h1 {
            color: var(--primary-color);
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }
        .header-scan p {
            color: var(--secondary-color);
            font-size: 16px;
            margin: 5px 0 0 0;
        }

        /* ÁREA DE STATUS */
        #status-message {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 18px;
        }
        .status-loading { background-color: #f0f0f0; color: #555; }
        .status-success { background-color: #e6ffe6; color: #008000; }
        .status-error { background-color: #ffe6e6; color: #c00; }
        
        /* DADOS DO DOCUMENTO */
        .document-info {
            background-color: var(--background-light);
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .document-info p {
            margin: 5px 0;
            font-size: 15px;
        }
        .document-info strong {
            color: var(--primary-color);
            font-weight: 600;
        }
        #totalHorasDisplay {
            font-size: 18px;
            font-weight: 700;
            color: #c00;
            text-align: right;
            margin-top: 10px;
        }

        /* TABELA DE HISTÓRICO */
        #histTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #histTable th, #histTable td {
            padding: 12px 8px;
            text-align: center;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
        }
        #histTable th {
            background: var(--primary-color);
            color: var(--text-light);
            font-weight: 600;
        }
        #histTable tr:nth-child(even) td { background-color: #f9f9f9; }

        /* NÚMERO DE SÉRIE */
        #serialNumber {
            text-align: center;
            margin-top: 30px;
            font-size: 12px;
            font-family: 'Courier New', Courier, monospace;
            color: rgba(0, 0, 0, 0.4); /* Levemente transparente */
            word-break: break-all;
        }
        
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            .header-scan h1 { font-size: 24px; }
            #histTable th, #histTable td { padding: 8px 4px; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-scan">
        <h1>DOMUSFIT</h1>
        <p>Sistema de Verificação de Autenticidade de Documento</p>
    </div>

    <div id="status-message" class="status-loading">
        Aguardando consulta dos dados...
    </div>

    <div id="document-content" style="display: none;">
        <div class="document-info">
            <p><strong>Comprovante de:</strong> <span id="mesAno"></span></p>
            <p><strong>Nome do Funcionário:</strong> <span id="docNome"></span></p>
            <p><strong>NA (Série):</strong> <span id="docNa"></span></p>
            <p><strong>Telefone:</strong> <span id="docTel"></span></p>
            <p id="totalHorasDisplay"></p>
        </div>

        <table id="histTable">
            <thead>
                <tr><th>Data</th><th>Entrada</th><th>Saída</th><th>Duração</th></tr>
            </thead>
            <tbody id="scanBody">
            </tbody>
        </table>

        <p id="serialNumber"></p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ====================================================================
// CONFIGURAÇÃO E VARIÁVEIS
// ====================================================================

const firebaseConfig = {
  apiKey: "AIzaSyBPiznHCVkTAgx6m02bZB8b0FFaot9UkBU",
  authDomain: "prefeitura-de-joao-camara.firebaseapp.com",
  projectId: "prefeitura-de-joao-camara",
  storageBucket: "prefeitura-de-joao-camara.firebasestorage.app",
  messagingSenderId: "269299041577",
  appId: "1:269299041577:web:fd41b2939240e9eb476338",
  measurementId: "G-YT7NHR342J"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const statusMsgEl = document.getElementById('status-message');
const docContentEl = document.getElementById('document-content');
const scanBodyEl = document.getElementById('scanBody');
const docNomeEl = document.getElementById('docNome');
const docNaEl = document.getElementById('docNa');
const docTelEl = document.getElementById('docTel');
const mesAnoEl = document.getElementById('mesAno');
const totalHorasEl = document.getElementById('totalHorasDisplay');
const serialNumberEl = document.getElementById('serialNumber');

// ====================================================================
// FUNÇÕES AUXILIARES
// ====================================================================

function dataFormatadaPorExtenso(mes, ano) {
    const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", 
                   "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    return `${meses[mes - 1]} de ${ano}`;
}

function gerarNumeroDeSerie(length = 100) {
    let result = '';
    const characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const charactersLength = characters.length;
    for (let i = 0; i < length; i++) {
        // Gera o mesmo formato do index.html (com espaços a cada 10 dígitos)
        if (i > 0 && i % 10 === 0) result += ' '; 
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}

function setStatus(message, type) {
    statusMsgEl.textContent = message;
    statusMsgEl.className = 'status-' + type;
    docContentEl.style.display = 'none';
}

// ====================================================================
// FUNÇÃO PRINCIPAL DE VERIFICAÇÃO
// ====================================================================

function verificarComprovante() {
    setStatus("Buscando e validando dados do comprovante...", "loading");

    // 1. Obter parâmetros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const serie = urlParams.get('serie');
    const mes = parseInt(urlParams.get('mes'));
    const ano = parseInt(urlParams.get('ano'));
    const check = urlParams.get('check'); // Número de série sem espaços

    if (!serie || !mes || !ano || !check) {
        setStatus("URL de verificação incompleta ou inválida.", "error");
        return;
    }

    // 2. Simular Verificação de Autenticidade (Número de Série)
    // O QR Code gerado no index.html usa o número de série da variável 'dadosComproAvanta.numSerie'
    // Como o número de série NÃO é salvo no Firebase, esta checagem é uma simulação.
    // Em um sistema real, o 'check' seria um hash ou um token salvo no banco.

    // Apenas para fins de demonstração e cumprimento do requisito:
    // Se o 'check' (número de série) fosse gerado com base nos dados (hash)
    // e o 'scaner.html' pudesse refazer o hash para comparar, a checagem seria feita aqui.
    // Como não há banco para o 'check', a autenticidade é apenas simulada/decorativa.
    // if (check !== hashSimuladoBaseadoEmDados) {
    //     setStatus("ALERTA DE SEGURANÇA: Número de série (check) não confere. Documento não autêntico.", "error");
    //     serialNumberEl.textContent = `Número de Série Recebido (Inautêntico): ${check}`;
    //     return;
    // }
    
    // 3. Buscar Dados do Funcionário e Histórico
    Promise.all([
        db.ref("usuarios/" + serie).once("value"),
        db.ref("historico/" + serie).once("value")
    ]).then(([usuarioSnap, historicoSnap]) => {
        
        const dadosUsuario = usuarioSnap.val();
        
        if (!dadosUsuario) {
            setStatus("NA de funcionário não encontrado no sistema.", "error");
            return;
        }

        // 3.1. Exibir dados do funcionário
        docNomeEl.textContent = dadosUsuario.nome || "Não informado";
        docNaEl.textContent = serie;
        docTelEl.textContent = dadosUsuario.telefone || "—";
        mesAnoEl.textContent = dataFormatadaPorExtenso(mes, ano);
        
        // 3.2. Processar Histórico
        let totalDuracaoMs = 0;
        scanBodyEl.innerHTML = "";

        if (historicoSnap.exists()) {
            const pontos = historicoSnap.val();
            
            // Filtrar pontos pelo mês e ano
            const pontosFiltrados = Object.entries(pontos)
              .filter(([data, val]) => {
                const [yy, mm] = data.split("-").map(Number);
                return yy === ano && mm === mes;
              })
              .sort(([dA], [dB]) => new Date(dA) - new Date(dB)); // Ordem cronológica

            if (pontosFiltrados.length === 0) {
                 scanBodyEl.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum ponto registrado para o mês/ano consultado.</td></tr>';
            }

            pontosFiltrados.forEach(([data, val]) => {
                const dataFormatada = data.split('-').reverse().join('/');
                const ini = val.inicio ? new Date(val.inicio).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'}) : "00:00:00";
                const fim = val.fim ? new Date(val.fim).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'}) : "00:00:00";
                let dur = "00h 00m";
              
                if (val.inicio && val.fim) {
                    const diff = val.fim - val.inicio;
                    totalDuracaoMs += diff;
                    
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    dur = `${String(h).padStart(2, '0')}h ${String(m).padStart(2, '0')}m`;
                }
                
                scanBodyEl.innerHTML += `<tr><td>${dataFormatada}</td><td>${ini}</td><td>${fim}</td><td>${dur}</td></tr>`;
            });
        }
        
        // 3.3. Exibir Total de Horas
        if (totalDuracaoMs > 0) {
            const totalH = Math.floor(totalDuracaoMs / 3600000);
            const totalM = Math.floor((totalDuracaoMs % 3600000) / 60000);
            const totalFormatado = `${String(totalH).padStart(2, '0')}h ${String(totalM).padStart(2, '0')}m`;
            totalHorasEl.textContent = `Total de Horas Trabalhadas: ${totalFormatado}`;
        } else {
             totalHorasEl.textContent = "Total de Horas Trabalhadas: 00h 00m";
        }
        
        // 3.4. Exibir o Número de Série (com espaços)
        // Como não foi salvo, apenas exibe o que veio na URL, formatado com espaços
        const formattedCheck = check.replace(/(.{10})/g, '$1 ').trim();
        serialNumberEl.textContent = `Número de Série de Autenticidade: ${formattedCheck}`;

        // 4. Sucesso na exibição
        docContentEl.style.display = 'block';
        setStatus("Comprovante verificado com sucesso. Os dados abaixo refletem as informações do sistema.", "success");

    }).catch(error => {
        console.error("Erro na consulta do Firebase:", error);
        setStatus(`Erro ao consultar dados: ${error.message}`, "error");
    });
}

// Inicia a verificação quando a página carrega
document.addEventListener('DOMContentLoaded', verificarComprovante);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prefeitura de João Câmara — Acesso</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rawline:wght@400;600;700&family=Public+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --gov-azul:#1351B4; --gov-amarelo:#FFCD00; --gov-branco:#FFFFFF; --gov-verde:#168821; --txt:#1F1F1F;
    --sombra:0 10px 30px rgba(0,0,0,.08);
    --radius:10px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Public Sans","Rawline",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f9;color:var(--txt)}
  header{
    position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:16px;
    background:var(--gov-azul);color:#fff;padding:14px 18px;box-shadow:var(--sombra)
  }
  header .logo{
    width:44px;height:44px;background:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#333;font-weight:700
  }
  main{max-width:1040px;margin:24px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:24px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{
    background:var(--gov-branco);border-radius:var(--radius);box-shadow:var(--sombra);padding:24px
  }
  h2{margin:0 0 12px 0}
  p{margin:8px 0 16px 0;line-height:1.5}
  .desc strong{background:var(--gov-amarelo);padding:2px 6px;border-radius:6px}
  form{display:grid;gap:14px}
  label{font-weight:600}
  input{
    width:100%;padding:14px 12px;border:1px solid #dfe3eb;border-radius:12px;
    background:#fff;font-size:16px;outline:none;transition:box-shadow .15s,border-color .15s;
  }
  input:focus{border-color:#b9c6e2;box-shadow:0 0 0 4px rgba(19,81,180,.12)}
  .btn{
    display:inline-flex;justify-content:center;align-items:center;gap:10px;
    padding:14px 16px;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:16px;
    transition:transform .03s ease,opacity .2s;user-select:none
  }
  .btn:active{transform:translateY(1px)}
  .btn-prim{background:var(--gov-azul);color:#fff}
  .btn-sec{background:#eaf1ff;color:#0b2b6b}
  .btn[disabled]{opacity:.7;cursor:not-allowed}
  .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .rodape{margin-top:18px;font-size:14px;color:#5b6270}
  .links{display:flex;gap:10px;flex-wrap:wrap}
  .links a{color:var(--gov-azul);text-decoration:none;font-weight:600}
  .alert{padding:12px 14px;border-radius:12px;background:#fff3cd;color:#7a5d00;border:1px solid #ffe69c}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
  .modal{width:400px;background:#fff;border-radius:10px;box-shadow:var(--sombra);padding:20px}
  .mhead{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #ddd;margin-bottom:10px}
  .mclose{border:none;background:#f1f3f5;border-radius:10px;padding:8px;cursor:pointer;font-weight:700}
</style>
</head>
<body>
  <header>
  <div class="logo">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQpN6mG9JrV3AvmACLq0uOQb0OcGFLu4WW8sOckbZpA8ow2biqC-IxosxA&s=10" alt="Logomarca" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:6px;display:block;margin:auto;">
  </div>
  <div>
    <div style="font-weight:700">Portal do Cidadão</div>
    <small>Prefeitura Municipal de João Câmara/RN</small>
  </div>
</header>
<main>
    <div class="grid">
      <section class="card">
        <h2>Bem vindo(a)</h2>
        A plataforma digital foi criada para facilitar o acesso da população aos serviços públicos, com navegação simples e objetiva.
<p>
Com seu login, você consegue acessar vários serviços municiapais.
<br><br>
<a href="doc.html" style="display:flex; align-items:center; text-decoration:none; color:#000; gap:8px;">
  <img src="https://826d3d7dee.cbaul-cdnwnd.com/62fd26f239c381f07684529cff4b51b2/200000079-a798ba798c/700/F1723432-530B-4DDF-A190-B775B522EE98.webp" alt="Ícone" style="width:24px; height:24px;">
  <span>Envie-nos sua mensagem</span>
</a>
<br>
<a href="manualdeuso.html" style="display:flex; align-items:center; text-decoration:none; color:#000; gap:8px;">
  <img src="https://826d3d7dee.cbaul-cdnwnd.com/62fd26f239c381f07684529cff4b51b2/200000099-4f6694f66b/700/CA9F5CC2-82DA-4651-B8E7-3BA9D95C287D.webp?ph=826d3d7dee" alt="Ícone" style="width:24px; height:24px;">
  <span>Como o app funciona?</span>
</a>      </section>
<section class="card">
        <h2>Entrar no seu perfil</h2>
        <form id="formLogin">
          <div>
            <label for="email">E-mail</label>
            <input id="email" type="email" autocomplete="email" required placeholder="Seu e-mail" />
          </div>
          <div>
            <label for="senha">Senha</label>
            <input id="senha" type="password" autocomplete="current-password" required placeholder="••••••••" />
          </div>
          <button id="btnEntrar" class="btn btn-prim" type="submit">
            <span>Entrar</span>
          </button>
          <div class="links">
            <a href="cadastro.html">Criar minha conta</a>
            <a href="#" id="btnCodigo">Entrar com código de acesso</a>
          </div>
          <div id="loginMsg" class="rodape"></div>
        </form>
      </section>
    </div>
 <div class="rodape">
      © Prefeitura de João Câmara - <span id="ano"></span>
    </div>
  </main>
  <div class="overlay" id="overlayCodigo">
    <div class="modal">
      <div class="mhead">
        <h3>Código de acesso</h3>
        <button class="mclose" id="fecharCodigo">✕</button>
      </div>
      <div id="codigoStep1">
        <label>Digite seu código de 4 dígitos</label>
        <input id="codigoInput" maxlength="4" inputmode="numeric" placeholder="••••" />
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="acessarCodigo" class="btn btn-prim">Acessar</button>
          <button id="criarCodigo" class="btn btn-sec">Criar meu código de acesso</button>
        </div>
        <div id="msgCodigo" style="margin-top:10px;color:#a33"></div>
      </div>
      <div id="codigoStep2" style="display:none">
        <label>Confirme seus dados</label>
        <input id="cpfConfirm" placeholder="000.000.000-00" maxlength="14" />
        <input id="emailConfirm" placeholder="E-mail cadastrado" />
        <input id="senhaConfirm" type="password" placeholder="Senha" />
        <button id="btnVerificar" class="btn btn-prim" style="margin-top:10px">Confirmar</button>
        <div id="msgVerif" style="margin-top:10px;color:#a33"></div>
      </div>
      <div id="codigoStep3" style="display:none">
        <div id="dadosUsuario"></div>
        <label>Crie seu código de 4 dígitos</label>
        <input id="novoCodigo" maxlength="4" inputmode="numeric" placeholder="••••" />
        <button id="btnCadastrarCodigo" class="btn btn-prim" style="margin-top:10px">Cadastrar</button>
        <div id="msgNovoCodigo" style="margin-top:10px;color:#a33"></div>
      </div>
    </div>
  </div>

  <div vw class="enabled"><div vw-access-button class="active"></div><div vw-plugin-wrapper><div class="vw-plugin-top-wrapper"></div></div></div>
  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
  <script>new window.VLibras.Widget('https://vlibras.gov.br/app');</script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
<script>
  document.getElementById('ano').textContent = new Date().getFullYear();

  const form = document.getElementById('formLogin');
  const btn = document.getElementById('btnEntrar');
  const msg = document.getElementById('loginMsg');
  function setLoading(is){
    btn.disabled = is;
    btn.innerHTML = is ? '<div class="spinner"></div><span>Entrando…</span>' : '<span>Entrar</span>';
  }
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    setLoading(true); msg.textContent='';
    try{
      await loginComEmail(email.value.trim(), senha.value);
      location.href='perfil.html';
    }catch(err){ msg.textContent = traduzErroAuth(err);}finally{setLoading(false);}
  });

  const overlayCodigo=document.getElementById('overlayCodigo');
  document.getElementById('btnCodigo').addEventListener('click',(e)=>{e.preventDefault();overlayCodigo.style.display='flex';});
  document.getElementById('fecharCodigo').addEventListener('click',()=>{overlayCodigo.style.display='none';});

  const step1=document.getElementById('codigoStep1');
  const step2=document.getElementById('codigoStep2');
  const step3=document.getElementById('codigoStep3');

  function getTentativas(){
    const data=JSON.parse(localStorage.getItem('tentativasCodigo')||'{}');
    if(!data.count)data.count=0;
    if(!data.time)data.time=0;
    return data;
  }
  function setTentativas(data){
    localStorage.setItem('tentativasCodigo',JSON.stringify(data));
  }

  document.getElementById('acessarCodigo').addEventListener('click',async()=>{
    const data=getTentativas();
    const agora=Date.now();
    if(data.count>=5 && (agora-data.time)<30000){
      document.getElementById('msgCodigo').textContent='Muitas tentativas. Aguarde 30 segundos.';
      return;
    }
    if((agora-data.time)>=30000){data.count=0;}
    const code=document.getElementById('codigoInput').value.trim();
    if(code.length!==4){document.getElementById('msgCodigo').textContent='Digite 4 dígitos.';return;}
    try{
      const snap=await firebase.database().ref('codigos').get();
      if(!snap.exists()){throw new Error('Código inválido');}
      let found=null;
      snap.forEach(child=>{
        if(child.val().codigo===code){found=child.val();}
      });
      if(!found){throw new Error('Código inválido');}
      await firebase.auth().signInWithEmailAndPassword(found.email,found.senha);
      setTentativas({count:0,time:0});
      location.href='perfil.html';
    }catch(err){
      data.count++;
      data.time=Date.now();
      setTentativas(data);
      document.getElementById('msgCodigo').textContent=traduzErroAuth(err);
    }
  });

  document.getElementById('criarCodigo').addEventListener('click',()=>{
    step1.style.display='none';step2.style.display='block';
  });

  function mascaraCPF(valor){
    return valor
      .replace(/\D/g,'')
      .replace(/(\d{3})(\d)/,'$1.$2')
      .replace(/(\d{3})(\d)/,'$1.$2')
      .replace(/(\d{3})(\d{1,2})$/,'$1-$2');
  }
  const cpfInput=document.getElementById('cpfConfirm');
  cpfInput.addEventListener('input',()=>{
    cpfInput.value=mascaraCPF(cpfInput.value);
  });

  document.getElementById('btnVerificar').addEventListener('click',async()=>{
    const cpf=cpfConfirm.value.trim();const email=emailConfirm.value.trim();const senha=senhaConfirm.value;
    try{
      await loginComEmail(email,senha);
      const user=firebase.auth().currentUser;
      const perfil=await obterPerfil(user.uid);
      if(perfil.cpf!==cpf){throw new Error('CPF não confere');}
      document.getElementById('dadosUsuario').innerHTML=`<p><strong>Nome:</strong> ${perfil.nomeCompleto}</p><p><strong>CPF:</strong> ${perfil.cpf}</p><p><strong>Nascimento:</strong> ${perfil.nascimento}</p>`;
      step2.style.display='none';step3.style.display='block';
    }catch(err){msgVerif.textContent=traduzErroAuth(err);}
  });

  document.getElementById('btnCadastrarCodigo').addEventListener('click',async()=>{
    const code=novoCodigo.value.trim();
    if(code.length!==4){msgNovoCodigo.textContent='Digite 4 dígitos.';return;}
    try{
      const user=firebase.auth().currentUser;
      const snap=await firebase.database().ref('usuarios/'+user.uid).get();
      const perfil=snap.val();
      await firebase.database().ref('codigos/'+user.uid).set({
        uid:user.uid,email:user.email,senha:senhaConfirm.value,codigo:code
      });
      alert('Código cadastrado com sucesso!');location.reload();
    }catch(err){msgNovoCodigo.textContent=traduzErroAuth(err);}
  });

  function traduzErroAuth(err){
    const m=err.code||err.message;
    if(m.includes('auth/user-not-found')) return 'Usuário não encontrado.';
    if(m.includes('auth/wrong-password')) return 'Senha incorreta.';
    if(m.includes('auth/invalid-email')) return 'E-mail inválido.';
    if(m.includes('auth/email-already-in-use')) return 'E-mail já cadastrado.';
    if(m.includes('auth/weak-password')) return 'Senha muito fraca.';
    if(m.includes('CPF')) return 'CPF não confere.';
    if(m.includes('Código inválido')) return 'Código inválido.';
    return 'Ocorreu um erro. Tente novamente.';
  }
</script>
</body>
</html>
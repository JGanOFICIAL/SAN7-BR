<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agendamento de Documento — Câmara Municipal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body,html{height:100%;width:100%;font-family:"Public Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{background:#0b2b6b}
  header{position:fixed;top:0;left:0;right:0;z-index:30;background:#fff;color:#333;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  header .logo{display:flex;align-items:center;gap:10px}
  header .logo img{width:40px;height:40px;object-fit:contain;border-radius:6px}
  header .logo div{display:flex;flex-direction:column}
  header strong{font-size:15px}
  header small{font-size:13px;color:#444}
  .conteudo{background:linear-gradient(180deg,#0b2b6b 0%,#041739 100%);color:#fff;width:100%;max-width:600px;padding:80px 20px 40px;min-height:100vh;margin:0 auto}
  h2{font-size:22px;font-weight:700;margin-bottom:6px}
  p{font-size:15px;margin-bottom:20px}
  label{font-weight:600;font-size:14px;display:block;margin-bottom:4px}
  input,select{width:100%;padding:12px;border:1px solid #ccc;border-radius:0;font-size:15px;outline:none;margin-bottom:14px}
  input:focus{border-color:#0b2b6b;box-shadow:0 0 0 2px rgba(11,43,107,.2)}
  .btn{width:100%;padding:16px;border:none;border-radius:6px;font-weight:700;font-size:16px;cursor:pointer;transition:.2s;margin-top:10px}
  .btn-primary{background:#0b2b6b;color:#fff}
  .btn-secondary{background:#eee;color:#000}
  .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}
  #cameraContainer{display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:20px}
  #video{width:100%;max-width:380px;border-radius:12px}
  #canvas{display:none}
  .circle{position:absolute;border:4px solid rgba(255,255,255,.8);border-radius:50%;width:250px;height:250px;pointer-events:none}
  .rodape{margin-top:30px;text-align:center;font-size:14px;color:rgba(255,255,255,.85)}
  #comprovante{background:#fff;color:#000;padding:20px;border-radius:6px}
  .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
  .overlay-content{background:#fff;padding:20px;border-radius:6px;max-width:400px;width:90%}
</style>
</head>
<body>
<header>
  <div class="logo">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQcf-AtSCrU4sQ8PORTd7uRTwMwR1mzoxn5NMWhhAKbE2dsKY6Uiu17i5U7&s=10" alt="Logo">
    <div>
      <strong>Agendamento</strong>
      <small>Câmara Municipal de João Câmara</small>
    </div>
  </div>
</header>

<div class="conteudo" id="conteudoPrincipal">
  <h2>Agendamento de Documento de Identidade</h2>
  <p>Escolha abaixo se deseja consultar um pedido existente ou realizar um novo agendamento.</p>

  <button id="btnAbrirConsulta" class="btn btn-primary">Consultar Pedido</button>
  <button id="btnNovoPedido" class="btn btn-secondary">Novo Pedido</button>

  <div id="novaEtapa" style="display:none;margin-top:20px">
    <p>Tire uma foto do rosto com boa iluminação e centralize no círculo abaixo.</p>
    <div id="cameraContainer">
      <video id="video" autoplay playsinline></video>
      <div class="circle"></div>
      <button id="btnTirarFoto" class="btn btn-primary">Tirar Foto</button>
      <canvas id="canvas"></canvas>
    </div>

    <form id="formAgendamento" style="display:none">
      <label>Nome completo</label>
      <input id="nomeCompleto" required/>

      <label>CPF</label>
      <input id="cpf" maxlength="14" required/>

      <label>Data de nascimento</label>
      <input id="nascimento" maxlength="10" required/>

      <label>Endereço</label>
      <input id="endereco" required/>

      <label>Cidade</label>
      <input id="cidade" required/>

      <label>Estado</label>
      <input id="estado" required/>

      <label>Telefone principal</label>
      <input id="telefone1" required/>

      <label>Telefone adicional (opcional)</label>
      <input id="telefone2"/>

      <label>Nome do pai</label>
      <input id="pai"/>

      <label>Nome da mãe</label>
      <input id="mae"/>

      <label>Data de expedição do documento atual</label>
      <input id="expedicao" maxlength="10"/>
      <div><input type="checkbox" id="naoSeiExp"/> Não sei</div>

      <div><input type="checkbox" id="menorIdade"/> Menor de idade</div>
      <div id="responsavelBox" style="display:none">
        <label>Nome do responsável</label>
        <input id="respNome"/>
        <label>CPF do responsável</label>
        <input id="respCpf" maxlength="14"/>
      </div>

      <button type="submit" id="btnAgendar" class="btn btn-primary"><span>Agendar</span></button>
    </form>

    <div id="comprovante" style="display:none;margin-top:20px"></div>
  </div>

  <div class="rodape">© Câmara Municipal de João Câmara - <span id="ano"></span></div>
</div>

<div class="overlay" id="consultaOverlay">
  <div class="overlay-content">
    <h3>Consultar Pedido</h3>
    <label>CPF</label>
    <input id="consultaCpf" maxlength="14"/>
    <label>Data de nascimento</label>
    <input id="consultaNasc" maxlength="10"/>
    <button id="btnConsultar" class="btn btn-primary">Consultar</button>
    <div id="consultaResultado" style="margin-top:12px;font-size:14px;color:#000"></div>
    <button id="btnFecharConsulta" class="btn btn-secondary" style="margin-top:14px">Fechar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
<script>
document.getElementById('ano').textContent=new Date().getFullYear();

function aplicarMascaraCpf(el){
  el.value=el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function aplicarMascaraData(el){
  el.value=el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"$1/$2")
    .replace(/(\d{2})(\d)/,"$1/$2")
    .substring(0,10);
}

["cpf","nascimento","expedicao","respCpf","consultaCpf","consultaNasc"].forEach(id=>{
  let el=document.getElementById(id);
  if(el){
    el.addEventListener("input",()=>{if(id.toLowerCase().includes("cpf"))aplicarMascaraCpf(el);else aplicarMascaraData(el)});
  }
});

document.getElementById("btnNovoPedido").addEventListener("click",()=>{
  document.getElementById("novaEtapa").style.display="block";
  navigator.mediaDevices.getUserMedia({video:true}).then(s=>{video.srcObject=s});
});

document.getElementById("btnTirarFoto").addEventListener("click",()=>{
  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0,canvas.width,canvas.height);
  document.getElementById("cameraContainer").style.display="none";
  document.getElementById("formAgendamento").style.display="block";
});

document.getElementById("naoSeiExp").addEventListener("change",e=>{
  document.getElementById("expedicao").disabled=e.target.checked;
});
document.getElementById("menorIdade").addEventListener("change",e=>{
  document.getElementById("responsavelBox").style.display=e.target.checked?"block":"none";
});

document.getElementById("formAgendamento").addEventListener("submit",async e=>{
  e.preventDefault();
  let cpf=document.getElementById("cpf").value;
  let snap=await firebase.database().ref("agendamentos").orderByChild("cpf").equalTo(cpf).once("value");
  let jaExiste=false;
  snap.forEach(d=>{
    let ultimo=d.val().dataCriacao||0;
    if(Date.now()-ultimo<1000*60*60*24*180)jaExiste=true;
  });
  if(jaExiste){alert("Já existe um pedido com este CPF nos últimos 6 meses.");return;}

  let btn=document.getElementById("btnAgendar");btn.disabled=true;btn.innerHTML='<div class="spinner"></div>Agendando…';
  const dados={
    nome:document.getElementById("nomeCompleto").value,
    cpf:cpf,
    nascimento:document.getElementById("nascimento").value,
    endereco:document.getElementById("endereco").value,
    cidade:document.getElementById("cidade").value,
    estado:document.getElementById("estado").value,
    telefone1:document.getElementById("telefone1").value,
    telefone2:document.getElementById("telefone2").value,
    pai:document.getElementById("pai").value,
    mae:document.getElementById("mae").value,
    expedicao:document.getElementById("naoSeiExp").checked?"Não informado":document.getElementById("expedicao").value,
    menor:document.getElementById("menorIdade").checked,
    responsavel:document.getElementById("menorIdade").checked?{nome:document.getElementById("respNome").value,cpf:document.getElementById("respCpf").value}:{},
    status:"Aguardando confirmação",
    dataCriacao:Date.now()
  };
  try{
    const ref=firebase.database().ref("agendamentos").push();
    await ref.set(dados);
    document.getElementById("formAgendamento").style.display="none";
    let c=document.getElementById("comprovante");
    c.style.display="block";
    c.innerHTML="<h3>Comprovante de Agendamento</h3><p><b>Nome:</b> "+dados.nome+"</p><p><b>CPF:</b> "+dados.cpf+"</p><p><b>Data de nascimento:</b> "+dados.nascimento+"</p><p><b>Status:</b> "+dados.status+"</p><p>Prazo: até 5 dias úteis para comparecer à Câmara com documentos oficiais.</p><img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgynG4qqaQ45rrvCe3QCzk8SwK8ujtxgCTI4pjMits-WEsaeI21VZr8prSCCA_86FZxWgZU_RD7Ab7KcOeRXaR3X0WTg6U93a4K6C7h5ctiuM5z9P3hxnoCdfNR7Vj-wJ2nvai0iGD83VNeKMhQctPdIDkVly-8nGIxz7R14anKRowkoMo6pyQlpjUq7xg/s523/4A9344D0-EDFA-447A-9FB8-8747BF306E66.jpeg' style='width:60px;margin-top:10px'>";
  }catch(err){alert("Erro: "+err.message)}
  finally{btn.disabled=false;btn.innerHTML="Agendar";}
});

document.getElementById("btnAbrirConsulta").addEventListener("click",()=>{document.getElementById("consultaOverlay").style.display="flex"});
document.getElementById("btnFecharConsulta").addEventListener("click",()=>{document.getElementById("consultaOverlay").style.display="none"});
document.getElementById("btnConsultar").addEventListener("click",async()=>{
  let cpf=document.getElementById("consultaCpf").value,nasc=document.getElementById("consultaNasc").value;
  let snap=await firebase.database().ref("agendamentos").orderByChild("cpf").equalTo(cpf).once("value");
  let res="Nenhum pedido encontrado.";
  snap.forEach(d=>{
    if(d.val().nascimento===nasc){
      res="<h4>Resultado</h4><p><b>Nome:</b> "+d.val().nome+"</p><p><b>CPF:</b> "+d.val().cpf+"</p><p><b>Data de nascimento:</b> "+d.val().nascimento+"</p><p><b>Status:</b> "+d.val().status+"</p>";
    }
  });
  document.getElementById("consultaResultado").innerHTML=res;
});
</script>
</body>
</html>
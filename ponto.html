<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ponto Eletrônico</title>
<style>
:root{
  --bg:#ffffff;
  --card:#f1f3f6;
  --accent:#0077ff;
  --text:#111;
  --muted:#666;
  --radius:8px;
  font-family: 'Inter',sans-serif;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
}
header{
  position:fixed;
  top:0;left:0;right:0;
  background:var(--card);
  display:flex;align-items:center;justify-content:space-between;
  padding:15px 20px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  z-index:10;
}
header h1{margin:0;font-size:18px;color:var(--accent);}
header button{
  background:var(--accent);border:none;padding:10px 16px;
  color:#fff;font-weight:600;border-radius:var(--radius);cursor:pointer;
}
main{padding:100px 20px 40px;}
.user-list{
  display:grid;
  gap:10px;
}
.user{
  background:var(--card);
  padding:15px;
  border-radius:var(--radius);
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.user span{font-size:15px;}
.user button{
  background:var(--accent);
  border:none;
  padding:6px 10px;
  color:#fff;
  font-weight:600;
  border-radius:var(--radius);
  cursor:pointer;
}
.overlay{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,.9);
  display:none;
  align-items:center;justify-content:center;
  z-index:20;
}
.overlay.active{display:flex;}
.box{
  background:var(--card);
  padding:30px;
  border-radius:var(--radius);
  width:90%;max-width:400px;
  text-align:center;
  box-shadow:0 0 20px rgba(0,0,0,.1);
}
.box input{
  width:80%;
  padding:10px;
  margin:15px 0;
  border:none;
  border-bottom:2px solid var(--accent);
  background:transparent;
  color:var(--text);
  font-size:16px;
  text-align:center;
}
.box button{
  background:var(--accent);
  border:none;
  padding:10px 20px;
  font-weight:600;
  border-radius:var(--radius);
  cursor:pointer;
  color:#fff;
}
#cameraView{
  width:200px;
  height:260px;
  border-radius:120px/160px;
  overflow:hidden;
  margin:0 auto 15px;
  position:relative;
  background:#ddd;
}
#cameraView video{
  width:100%;height:100%;object-fit:cover;
}
#comprovante p{margin:10px 0;}
</style>
</head>
<body>
<header>
  <h1>DomusFit</h1>
  <button id="btnIniciar">Iniciar Carga Horária</button>
</header>
<main>
  <div class="user-list" id="userList"></div>
</main>




<div class="overlay" id="overlayCamera">
  <div class="box">
    <h3>Reconhecimento Facial</h3>
    <div id="cameraView"><video id="video" autoplay playsinline></video></div>
    <button id="btnValidar">Validar</button>
  </div>
</div>

<div class="overlay" id="overlaySerie">
  <div class="box">
    <h3>Informe o número de série (5 dígitos)</h3>
    <input type="text" id="serieInput" maxlength="5" placeholder="00000">
    <button id="btnConfirmarSerie">Iniciar</button>
  </div>
</div>

<div class="overlay" id="overlayFinalizar">
  <div class="box">
    <h3>Finalizar Dia</h3>
    <input type="text" id="serieFinal" maxlength="5" placeholder="Número de série">
    <button id="btnFinalizarDia">Finalizar</button>
  </div>
</div>

<div class="overlay" id="comprovante">
  <div class="box">
    <h3>Comprovante de Finalização</h3>
    <p id="textoComprovante"></p>
    <button onclick="fecharComprovante()">OK</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, get, child, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyBPiznHCVkTAgx6m02bZB8b0FFaot9UkBU",
  authDomain:"prefeitura-de-joao-camara.firebaseapp.com",
  projectId:"prefeitura-de-joao-camara",
  storageBucket:"prefeitura-de-joao-camara.firebasestorage.app",
  messagingSenderId:"269299041577",
  appId:"1:269299041577:web:fd41b2939240e9eb476338",
  measurementId:"G-YT7NHR342J"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const userList = document.getElementById('userList');
const overlayCamera=document.getElementById('overlayCamera');
const overlaySerie=document.getElementById('overlaySerie');
const overlayFinalizar=document.getElementById('overlayFinalizar');
const comprovante=document.getElementById('comprovante');
const video=document.getElementById('video');

document.getElementById('btnIniciar').onclick=()=>{
  overlayCamera.classList.add('active');
  navigator.mediaDevices.getUserMedia({video:true})
  .then(s=>{video.srcObject=s;})
  .catch(e=>alert("Permissão da câmera negada"));
};

document.getElementById('btnValidar').onclick=()=>{
  overlayCamera.classList.remove('active');
  overlaySerie.classList.add('active');
};

document.getElementById('btnConfirmarSerie').onclick=()=>{
  const serie=document.getElementById('serieInput').value.trim();
  if(serie.length!==5)return alert('Número de série inválido');
  const inicio=Date.now();
  const refUser=ref(db,'ponto/'+serie);
  set(refUser,{inicio:inicio,ativo:true});
  overlaySerie.classList.remove('active');
};

onValue(ref(db,'ponto'),snap=>{
  userList.innerHTML='';
  if(!snap.exists())return;
  const data=snap.val();
  Object.entries(data).forEach(([serie,info])=>{
    if(!info.ativo)return;
    const div=document.createElement('div');
    div.className='user';
    const tempoSpan=document.createElement('span');
    const btn=document.createElement('button');
    btn.innerText='Finalizar';
    btn.onclick=()=>finalizar(serie);
    div.appendChild(tempoSpan);
    div.appendChild(btn);
    userList.appendChild(div);

    const atualizar=()=>{
      const tempo=calcTempo(info.inicio);
      tempoSpan.innerHTML=`<b>${serie}</b> — ${tempo}`;
    };
    atualizar();
    setInterval(atualizar,1000);
  });
});

function calcTempo(inicio){
  const diff=Date.now()-inicio;
  const s=Math.floor(diff/1000);
  const h=Math.floor(s/3600);
  const m=Math.floor((s%3600)/60);
  const sec=s%60;
  return `${h}h ${m}m ${sec}s`;
}

window.finalizar=(serie)=>{
  overlayFinalizar.classList.add('active');
  document.getElementById('btnFinalizarDia').onclick=()=>{
    const input=document.getElementById('serieFinal').value.trim();
    if(input!==serie)return alert('Número de série incorreto');
    get(child(ref(db),'ponto/'+serie)).then(s=>{
      if(!s.exists())return;
      const data=s.val();
      const fim=Date.now();
      const tempo=calcTempo(data.inicio);
      const refUser=ref(db,'historico/'+serie+'/'+Date.now());
      set(refUser,{inicio:data.inicio,fim:fim,tempo:tempo});
      remove(ref(db,'ponto/'+serie));
      overlayFinalizar.classList.remove('active');
      document.getElementById('textoComprovante').innerText=`Usuário ${serie}\nTempo total: ${tempo}\nFinalizado às ${new Date().toLocaleTimeString()}`;
      comprovante.classList.add('active');
    });
  };
};

window.fecharComprovante=()=>comprovante.classList.remove('active');
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Questão com OCR, Wikipédia e INEP - Versão Avançada</title>
<style>
  /* --- [mantido exatamente] --- */
  * { box-sizing: border-box; }
  body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; background: #fff; color: #222; display: flex; flex-direction: column; }
  header { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #f9f9f9; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-weight: 600; font-size: 1rem; user-select:none; z-index: 10; }
  #date-time { font-variant-numeric: tabular-nums; }
  #camera-container { flex-grow: 1; margin-top: 50px; position: relative; background: #000; overflow: hidden; }
  video { width: 100%; height: 100%; object-fit: cover; }
  #btn-calc { position: fixed; bottom: 25px; right: 25px; padding: 14px 24px; background: #003366; color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer; user-select: none; box-shadow: 0 4px 10px rgb(0 51 102 / 0.5); z-index: 15; transition: background-color 0.3s ease; }
  #btn-calc:disabled { background: #666; cursor: not-allowed; box-shadow: none; }
  #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.95); padding: 20px 30px; border-radius: 12px; font-weight: 700; font-size: 1.3rem; display: none; user-select: none; z-index: 20; text-align: center; }
  #result-box { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: #003366; color: white; padding: 20px 30px; border-radius: 12px; font-size: 1.3rem; font-weight: 700; max-width: 90%; text-align: center; user-select: none; display: none; z-index: 20; box-shadow: 0 8px 20px rgb(0 51 102 / 0.8); }
</style>
</head>
<body>

<header>
  <div id="date-time">--:-- --/--/----</div>
  <div>AI Questão - OCR + Wikipédia + INEP (Avançado)</div>
</header>

<div id="camera-container">
  <video id="video" autoplay muted playsinline></video>
</div>

<button id="btn-calc" disabled>Calcular Resposta</button>
<div id="loading">Buscando...</div>
<div id="result-box"></div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
  const video = document.getElementById('video');
  const btnCalc = document.getElementById('btn-calc');
  const loading = document.getElementById('loading');
  const resultBox = document.getElementById('result-box');
  const dateTimeElem = document.getElementById('date-time');

  function updateDateTime(){
    const now = new Date();
    const h = now.getHours().toString().padStart(2,'0');
    const m = now.getMinutes().toString().padStart(2,'0');
    const d = now.getDate().toString().padStart(2,'0');
    const mm = (now.getMonth()+1).toString().padStart(2,'0');
    const y = now.getFullYear();
    dateTimeElem.textContent = `${h}:${m} ${d}/${mm}/${y}`;
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();

  async function startCamera(){
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
      video.srcObject = stream;
      video.addEventListener('loadedmetadata', () => { btnCalc.disabled = false; });
    } catch(e){
      alert("Erro ao acessar câmera: " + e.message);
    }
  }

  function captureFrame(){
    const w = video.videoWidth, h = video.videoHeight;
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(video, 0, 0, w, h);
    return canvas;
  }

  // consulta Wikipédia avançada com resumo e contexto adicional
  async function buscarWikipediaDetalhado(enunciado, alternativas){
    try {
      let query = enunciado;
      if(alternativas.length){
        query += ' ' + alternativas.map(a => a.replace(/^([A-Z])\)\s*/i,'')).join(' ');
      }
      query = encodeURIComponent(query.substring(0,300));
      const url = `https://pt.wikipedia.org/w/api.php?origin=*&action=query&format=json&prop=extracts|info&inprop=url&explaintext&exintro&redirects=1&titles=${query}`;
      const r = await fetch(url);
      const d = await r.json();
      const page = Object.values(d.query.pages)[0];
      if(page.missing!==undefined) return '';
      return (page.extract || '') + '\n\nFonte: ' + (page.fullurl || '');
    } catch(e){ return ''; }
  }

  // consulta INEP com parâmetros estruturados
  async function buscarINEP(enunciado){
    try {
      const base = 'https://apidatalake.inep.gov.br/inep-ws/notasf/index';
      const params = new URLSearchParams({
        tituloQuestao: enunciado,
        origem: 'OCR_AI_Questao',
        formato: 'json'
      });
      const r = await fetch(`${base}?${params}`);
      if(!r.ok) return '';
      const d = await r.json();
      // sintetiza apenas dados relevantes
      return (d.resposta?.texto || '') + ' (INEP)';
    } catch(e){ return ''; }
  }

  function similaridade(t1, t2){
    const w1 = t1.toLowerCase().match(/\b\w+\b/g)||[];
    const w2 = t2.toLowerCase().match(/\b\w+\b/g)||[];
    const set2 = new Set(w2);
    let count=0; w1.forEach(w=> set2.has(w)&&count++);
    return count/Math.max(w1.length, w2.length);
  }

  function extrairQuestao(texto){
    const linhas = texto.split('\n').map(l=>l.trim()).filter(l=>l);
    let enunciado='', alternativas=[], encontrou=false;
    for(const l of linhas){
      if(/^([A-Z])\)/i.test(l) || /^(V|F)$/i.test(l)){
        encontrou=true; alternativas.push(l);
      } else if(!encontrou){
        enunciado += (enunciado?' ':'') + l;
      }
    }
    if(alternativas.length===0 && (/verdadeiro/i.test(texto)||/falso/i.test(texto))){
      alternativas=['Verdadeiro','Falso'];
    }
    return {enunciado,alternativas};
  }

  // escolhe com base em pontuação combinada + peso semântico
  function escolherAlternativa(wText, iText, alternativas){
    if(!alternativas.length) return "N/A";
    if(alternativas.length===1) return alternativas[0];

    if(alternativas.length===2 && alternativas.includes('Verdadeiro') && alternativas.includes('Falso')){
      const simW = similaridade(wText,'verdadeiro') - similaridade(wText,'falso');
      const simI = similaridade(iText,'verdadeiro') - similaridade(iText,'falso');
      return (simW+simI)>=0?'Verdadeiro':'Falso';
    }

    let melhor='', maxScore=-Infinity;
    alternativas.forEach(alt=>{
      const txt = alt.replace(/^([A-Z])\)\s*/i,'');
      const score = similaridade(wText, txt)*1.2 + similaridade(iText, txt);
      if(score > maxScore){ maxScore=score; melhor=alt; }
    });
    return melhor;
  }

  btnCalc.addEventListener('click', async ()=>{
    loading.style.display='block'; resultBox.style.display='none'; btnCalc.disabled=true;

    const frame = captureFrame();
    const { data:{text} } = await Tesseract.recognize(frame, 'por', {
      logger: m => {
        if(m.status==='recognizing text'){
          loading.textContent = `Reconhecendo texto: ${Math.round(m.progress*100)}%`;
        }
      }
    });

    loading.textContent = 'Processando...';
    const { enunciado, alternativas } = extrairQuestao(text);
    if(!enunciado){
      loading.style.display='none'; btnCalc.disabled=false;
      return alert("Não foi possível detectar o enunciado. Aponte a câmera melhor e tente novamente.");
    }

    const [wikiResumo, inepResumo] = await Promise.all([
      buscarWikipediaDetalhado(enunciado, alternativas),
      buscarINEP(enunciado)
    ]);

    const resposta = escolherAlternativa(wikiResumo, inepResumo, alternativas);

    let respFmt = resposta;
    if(/^([A-Z])\)/i.test(resposta)){
      respFmt = resposta;
    } else if(alternativas.length>1){
      const idx = alternativas.findIndex(a=>a===resposta);
      if(idx>=0){
        respFmt = String.fromCharCode(65+idx) + ') ' + resposta;
      }
    }

    resultBox.textContent = `Resposta sugerida: ${respFmt}`;
    resultBox.style.display='block';
    loading.style.display='none'; btnCalc.disabled=false;
    setTimeout(()=>resultBox.style.display='none',6000);
  });

  startCamera();
</script>

</body>
</html>

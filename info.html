<!-- =========================
perfil.html • Perfil do cidadão
• Ver dados (somente leitura)
• Editar endereço (com lápis) salvando em tempo real
• Upload de foto de perfil (salva no Storage e atualiza Firestore)
• Lista de 5 órgãos públicos (placeholders) + aviso "ainda serão cadastrados"
========================= -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prefeitura de João Câmara • Perfil</title>
<link rel="icon" href="https://otimize-edoc.s3.amazonaws.com/edoc_1291/logo_joaocamara.png" />
<style>
  :root{--azul:#0B3B74;--amarelo:#FFCC00;--cinza:#e9eef4;--texto:#111;--ok:#0c8f4d;--erro:#b00020}
  *{box-sizing:border-box} html,body{margin:0;background:#fff;color:var(--texto);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  header{background:var(--azul);color:#fff;padding:14px 16px;border-bottom:4px solid var(--amarelo);display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;background:#fff;border-radius:4px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .logo img{width:100%;height:100%;object-fit:cover}
  .titulos h1{margin:0;font-size:16px}
  .btnSair{border:1px solid #fff;background:#fff;color:var(--azul);padding:10px 12px;border-radius:6px;cursor:pointer}
  main{max-width:920px;margin:18px auto;padding:0 16px}
  .boas-vindas{margin:16px 0;background:#fff;border:1px solid var(--cinza);box-shadow:0 8px 22px rgba(0,0,0,.06);border-radius:10px;overflow:hidden}
  .boas-vindas .foto{width:100%;height:160px;background:#f6f7fb url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_EkzeqLkVBeHrg5Jlsw-NuYV2pbh1G2T0MXalKxp98NtmAvMKl6zgqCkE&s=10') center/cover no-repeat}
  .boas-vindas .txt{padding:14px 16px}
  .card{background:#fff;border:1px solid var(--cinza);border-radius:10px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-top:16px}
  .perfil{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .avatar{width:96px;height:96px;border-radius:8px;background:#f2f4f8;border:1px solid var(--cinza);overflow:hidden;display:flex;align-items:center;justify-content:center}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .btnMini{border:1px solid var(--azul);background:#fff;color:var(--azul);padding:8px 10px;border-radius:6px;cursor:pointer;font-size:12px}
  .acoes{display:flex;gap:10px;flex-wrap:wrap}
  .btn{border:1px solid var(--azul);background:var(--azul);color:#fff;padding:10px 12px;border-radius:6px;cursor:pointer}
  .lista{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
  .orgao{border:1px solid var(--cinza);border-radius:8px;padding:12px}
  .pills{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .pill{font-size:11px;border:1px solid var(--cinza);border-radius:999px;padding:4px 8px;background:#f8fafc}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50;padding:16px}
  .overlay.mostrar{display:flex}
  .modal{background:#fff;border:1px solid var(--cinza);border-radius:10px;max-width:560px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
  .modal header{background:#f8fafc;color:#111;padding:12px 16px;border-bottom:1px solid var(--cinza)}
  .modal .conteudo{padding:16px}
  .modal .rodape{display:flex;gap:10px;padding:12px 16px;border-top:1px solid var(--cinza)}
  label{display:block;font-size:13px;margin:10px 0 6px}
  input{width:100%;padding:12px;border:1px solid var(--cinza);border-radius:6px;background:#fff;outline:none}
  input:focus{background:#fafafa;outline:none;box-shadow:none}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;display:none;z-index:60}
  .toast.ok{background:var(--ok)} .toast.erro{background:var(--erro)}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo"><img src="https://826d3d7dee.cbaul-cdnwnd.com/62fd26f239c381f07684529cff4b51b2/200000069-4a3354a336/700/A728F011-D3B0-4197-83F7-88EDFC2AF8A5.webp" alt="Logo"></div>
    <div class="titulos"><h1>Perfil do Cidadão</h1><small>Prefeitura de João Câmara</small></div>
  </div>
  <button class="btnSair" id="btnSair">Sair</button>
</header>

<main>
  <section class="boas-vindas">
    <div class="foto" aria-hidden="true"></div>
    <div class="txt">
      <h2 id="ola">Olá!</h2>
      <p>Gerencie seus dados e acesse serviços municipais.</p>
    </div>
  </section>

  <section class="card">
    <div class="perfil">
      <div class="avatar" id="avatar"><img id="fotoPerfil" alt=""></div>
      <div>
        <div style="font-weight:700;font-size:18px" id="nomeExib">—</div>
        <div style="font-size:13px;color:#333" id="emailExib">—</div>
        <div class="acoes" style="margin-top:10px">
          <input type="file" id="inFoto" accept="image/*" capture="environment" hidden />
          <button class="btnMini" onclick="document.getElementById('inFoto').click()">Atualizar foto do cidadão</button>
          <button class="btn" id="btnVerDados">Ver dados</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px">Órgãos públicos</h3>
    <p style="margin:0 0 10px">Órgãos públicos ainda serão adicionados.</p>
    <div class="lista">
      <div class="orgao"><strong>Secretaria de Saúde</strong><div class="pills"><span class="pill">Unidades</span><span class="pill">Serviços</span></div></div>
      <div class="orgao"><strong>Secretaria de Educação</strong><div class="pills"><span class="pill">Matrículas</span><span class="pill">Transporte</span></div></div>
      <div class="orgao"><strong>Tributação</strong><div class="pills"><span class="pill">IPTU</span><span class="pill">ISS</span></div></div>
      <div class="orgao"><strong>Assistência Social</strong><div class="pills"><span class="pill">CRAS</span><span class="pill">Benefícios</span></div></div>
      <div class="orgao"><strong>Infraestrutura</strong><div class="pills"><span class="pill">Obras</span><span class="pill">Manutenção</span></div></div>
    </div>
  </section>
</main>

<!-- Modal Ver Dados -->
<div class="overlay" id="ovlDados">
  <div class="modal" role="dialog" aria-modal="true">
    <header><h3 style="margin:0">Dados do cidadão</h3></header>
    <div class="conteudo" id="conteudoDados">
      <!-- Render dinâmico -->
    </div>
    <div class="rodape">
      <button class="btnSair" style="border-color:var(--azul);color:var(--azul);background:#fff" id="btnFecharDados">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal Editar Endereço -->
<div class="overlay" id="ovlEnd">
  <div class="modal" role="dialog" aria-modal="true">
    <header><h3 style="margin:0">Editar endereço</h3></header>
    <div class="conteudo">
      <label>CEP</label><input id="eCEP" maxlength="9" />
      <label>Rua</label><input id="eRua" />
      <div style="display:flex;gap:10px">
        <div style="flex:1"><label>Número</label><input id="eNum" /></div>
        <div style="flex:1"><label>Referência</label><input id="eRef" /></div>
      </div>
      <label>Cidade</label><input id="eCid" />
    </div>
    <div class="rodape">
      <button class="btnSair" style="border-color:var(--azul);color:var(--azul);background:#fff" id="btnFecharEnd">Fechar</button>
      <button class="btn" id="btnSalvarEnd">Salvar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCAlWxc7YxTMcTLCECUDuYfomO6QapreqY",
  authDomain: "login-you-see.firebaseapp.com",
  databaseURL: "https://login-you-see-default-rtdb.firebaseio.com",
  projectId: "login-you-see",
  storageBucket: "login-you-see.appspot.com",
  messagingSenderId: "524877259374",
  appId: "1:524877259374:web:9ff66b67c9c5bf0bb07c7f",
  measurementId: "G-K7E00VXYHG"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const qs = s=>document.querySelector(s);
const toast=(m,t='ok')=>{const el=qs('#toast');el.textContent=m;el.className='toast '+t;el.style.display='block';setTimeout(()=>el.style.display='none',2800)}
const maskCEP=v=>v.replace(/\D/g,'').slice(0,8).replace(/(\d{5})(\d)/,'$1-$2');

let user, dados;

// Guard
auth.onAuthStateChanged(async u=>{
  if(!u){ location.href='login.html'; return; }
  user=u;
  qs('#emailExib').textContent = u.email||'—';
  await carregarDados();
});

async function carregarDados(){
  const ref = db.collection('cidadaos').doc(user.uid);
  const snap = await ref.get();
  dados = snap.data()||{};
  qs('#nomeExib').textContent = dados.nome||'—';
  qs('#ola').textContent = `Olá, ${dados.nome?dados.nome.split(' ')[0]:'cidadão'}!`;
  if(dados.fotoPerfil){ qs('#fotoPerfil').src = dados.fotoPerfil; } else { qs('#fotoPerfil').src=''; }
}

qs('#btnSair').onclick=()=>auth.signOut().then(()=>location.href='login.html');

qs('#btnVerDados').onclick=()=>{
  const d=dados||{};
  const e=d.endereco||{};
  const conteudo = `
    <div><b>Nome:</b> ${d.nome||'—'}</div>
    <div><b>CPF:</b> ${d.cpf||'—'}</div>
    <div><b>Nascimento:</b> ${d.nasc||'—'}</div>
    <div><b>CadÚnico:</b> ${d.cadunico||'—'}</div>
    <div><b>Telefone:</b> ${d.tel||'—'}</div>
    <hr style="border:none;border-top:1px dashed #cfd6e3;margin:10px 0">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><b>Endereço:</b> ${e.rua||'—'}, ${e.numero||'—'} • CEP ${e.cep||'—'} • ${e.cidade||'—'} • Ref.: ${e.referencia||'—'}</div>
      <button class="btn" id="btnEditarEnd" title="Editar endereço">✏️</button>
    </div>
    <hr style="border:none;border-top:1px dashed #cfd6e3;margin:10px 0">
    <div><b>Documentos:</b> <a href="${(d.docs&&d.docs.frente)||'#'}" target="_blank">Frente</a> • <a href="${(d.docs&&d.docs.verso)||'#'}" target="_blank">Verso</a></div>
  `;
  qs('#conteudoDados').innerHTML = conteudo;
  qs('#ovlDados').classList.add('mostrar');

  // botão editar endereço dentro do modal
  setTimeout(()=>{
    const btn = document.getElementById('btnEditarEnd');
    if(btn) btn.onclick=abrirEditarEndereco;
  },0);
};
qs('#btnFecharDados').onclick=()=>qs('#ovlDados').classList.remove('mostrar');

function abrirEditarEndereco(){
  const e = (dados.endereco)||{};
  qs('#eCEP').value = e.cep||'';
  qs('#eRua').value = e.rua||'';
  qs('#eNum').value = e.numero||'';
  qs('#eRef').value = e.referencia||'';
  qs('#eCid').value = e.cidade||'';
  qs('#ovlEnd').classList.add('mostrar');
}
qs('#btnFecharEnd').onclick=()=>qs('#ovlEnd').classList.remove('mostrar');

qs('#eCEP').addEventListener('input',ev=>ev.target.value=maskCEP(ev.target.value));

qs('#btnSalvarEnd').onclick=async ()=>{
  const novo = {
    cep: qs('#eCEP').value.trim(),
    rua: qs('#eRua').value.trim(),
    numero: qs('#eNum').value.trim(),
    referencia: qs('#eRef').value.trim()||null,
    cidade: qs('#eCid').value.trim()
  };
  if(!novo.cep||!novo.rua||!novo.numero||!novo.cidade){ toast('Preencha CEP, rua, número e cidade.','erro'); return; }
  try{
    await db.collection('cidadaos').doc(user.uid).update({ endereco: novo });
    dados.endereco = novo;
    toast('Endereço atualizado.','ok');
    qs('#ovlEnd').classList.remove('mostrar');
    // Atualiza texto dentro do modal de dados se estiver aberto
    if(qs('#ovlDados').classList.contains('mostrar')) qs('#btnVerDados').click();
  }catch(e){ toast('Não foi possível salvar o endereço.','erro'); }
};

// Upload da foto de perfil (salva em tempo real)
qs('#inFoto').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const ref = storage.ref(`fotos/${user.uid}.jpg`);
    await ref.put(f);
    const url = await ref.getDownloadURL();
    await db.collection('cidadaos').doc(user.uid).update({ fotoPerfil:url });
    qs('#fotoPerfil').src = url;
    toast('Foto de perfil atualizada.','ok');
  }catch(err){ toast('Falha ao enviar a foto.','erro'); }
});
</script>

<!-- VLIBRAS -->
<div vw class="enabled"></div>
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script> new window.VLibras.Widget('https://vlibras.gov.br/app'); </script>
</body>
</html>



<div id="notificacao">
  <div class="conteudo">
    <h3>⚠️ Atenção</h3>
    <p>
      Todas as páginas estão em fase <b>BETA – Versão 1.0.2</b>.<br><br>
      O aplicativo está em fase de desenvolvimento para a <b>Prefeitura de João Câmara</b> e algumas funções estão em melhorias no momento.<br><br>
      Sistema com <b>criptografia de ponta a ponta</b>.<br><br>
      Desenvolvedor: <b>@eujpfelix</b>
    </p>
    <button id="okBtn">OK</button>
  </div>
</div>

<style>
#notificacao {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.6s ease;
  z-index: 9999;
}
#notificacao.ativo {
  opacity: 1;
  pointer-events: all;
}
#notificacao .conteudo {
  background: #ffffff;
  border: 2px solid #003366;
  border-radius: 6px;
  max-width: 500px;
  width: 90%;
  padding: 25px;
  text-align: center;
  font-family: Arial, sans-serif;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  animation: subir 0.6s ease forwards;
}
#notificacao h3 {
  margin: 0 0 15px;
  color: #003366;
  font-size: 20px;
}
#notificacao p {
  font-size: 15px;
  color: #333;
  line-height: 1.5;
}
#notificacao button {
  margin-top: 20px;
  background: #003366;
  color: #fff;
  border: none;
  padding: 10px 22px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 15px;
}
#notificacao button:hover {
  background: #002244;
}
@keyframes subir {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
</style>

<script>
window.addEventListener("load", () => {
  const box = document.getElementById("notificacao");
  const btn = document.getElementById("okBtn");
  setTimeout(() => {
    box.classList.add("ativo");
  }, 500);
  btn.addEventListener("click", () => {
    box.classList.remove("ativo");
  });
});
</script>

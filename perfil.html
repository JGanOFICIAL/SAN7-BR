<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Prefeitura de João Câmara — Perfil</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body,html{height:100%;width:100%;font-family:"Public Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{background:#0b2b6b}
  header{position:fixed;top:0;left:0;right:0;z-index:30;background:#fff;color:#333;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  header .logo{display:flex;align-items:center;gap:10px}
  header .logo img{width:40px;height:40px;object-fit:contain;border-radius:6px}
  header .logo div{display:flex;flex-direction:column}
  header strong{font-size:15px}
  header small{font-size:13px;color:#444}
  .btn-back{background:#0b2b6b;color:#fff;width:38px;height:38px;display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:20px;border:none;border-radius:0}
  .perfil-container{background:linear-gradient(180deg,#0b2b6b 0%,#041739 100%);color:#fff;width:100%;max-width:480px;padding:80px 28px 40px;min-height:100vh;display:flex;flex-direction:column;justify-content:flex-start;overflow-y:auto;margin:0 auto}
  h2{font-size:22px;font-weight:700;margin-bottom:6px}
  p{font-size:15px;margin-bottom:20px}
  .btn{width:100%;padding:16px;border:none;border-radius:30px;font-weight:700;font-size:16px;cursor:pointer;transition:.2s}
  .btn-prim{background:#bfbfbf;color:#333}
  .btn-prim:enabled{background:#fff;color:#0b2b6b}
  .rodape{margin-top:30px;text-align:center;font-size:14px;color:rgba(255,255,255,.85)}
  .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
  .modal{width:min(420px,90%);max-height:80vh;overflow:auto;background:#fff;border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.25);padding:20px;color:#000}
  .mhead{display:flex;align-items:center;justify-content:space-between;gap:8px;position:sticky;top:0;background:#fff}
  .mclose{border:none;background:#f1f3f5;border-radius:10px;padding:8px;cursor:pointer;font-weight:700}
  label{font-weight:600;font-size:14px}
  input{width:100%;padding:12px;border:1px solid #dfe3eb;border-radius:12px;font-size:16px;outline:none;transition:.25s}
  input:focus{border-color:#0a2a66;box-shadow:0 0 0 3px rgba(10,42,102,.18)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:500px){.grid{grid-template-columns:1fr}}
  .btn-save{background:#0b2b6b;color:#fff;width:100%;margin-top:15px;border-radius:30px}
  #fonezinho{width:180px;height:auto;cursor:pointer;display:block;margin:50px auto}
  .funcoes-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:16px;margin-top:30px}
  .funcao{background:#fff;color:#0b2b6b;border-radius:12px;text-align:center;padding:12px;text-decoration:none;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:14px;font-weight:600;transition:.2s}
  .funcao img{width:60px;height:60px;object-fit:cover;border-radius:8px;margin-bottom:8px}
  .funcao:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,.25)}
  #imgAbaixoBtn{width:350px;height:auto;display:block;margin:20px auto}

  /* ========== ADIÇÕES PARA FOTO DE PERFIL ========== */
  .perfil-foto-wrap{display:flex;align-items:center;gap:14px;margin:14px 0}
  #perfilFoto{width:96px;height:96px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,.12);cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.28)}
  #perfilFoto:focus{outline:3px solid rgba(255,255,255,.12)}
  .overlay-foto{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);backdrop-filter:blur(8px);z-index:90;padding:20px}
  .modal-foto{width:min(720px,95%);max-height:86vh;overflow:auto;background:#fff;border-radius:6px;padding:18px;color:#000;box-shadow:0 8px 32px rgba(0,0,0,.32);border:1px solid rgba(0,0,0,.06)}
  .mhead-foto{display:flex;align-items:center;justify-content:space-between;gap:8px;position:sticky;top:0;background:#fff;padding-bottom:8px;margin-bottom:10px}
  .grid-fotos{display:grid;grid-template-columns:repeat(auto-fill,minmax(98px,1fr));gap:12px}
  .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;cursor:pointer;border:3px solid transparent;box-sizing:border-box}
  .thumb.sel{border-color:#0b2b6b;border-radius:8px;transform:scale(1.02)}
  .thumb.default{border-radius:50%}
  .foto-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px}
  .btn-ghost{background:#f1f3f5;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .save-spinner{width:18px;height:18px;border:3px solid rgba(0,0,0,.08);border-top-color:#0b2b6b;border-radius:50%;animation:spin 1s linear infinite}
  /* fim adições */
</style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQcf-AtSCrU4sQ8PORTd7uRTwMwR1mzoxn5NMWhhAKbE2dsKY6Uiu17i5U7&s=10" alt="Logo">
      <div>
        <strong>Área do Cidadão</strong>
        <small>Câmara Municipal de João Câmara</small>
      </div>
    </div>
    <a href="login.html" id="btnSair" class="btn-back">←</a>
  </header>

  <div class="perfil-container">
    <h2>Bem-vindo ao seu perfil</h2>
    <p id="saudacao">Olá!</p>

    <!-- ========== ADIÇÃO: foto de perfil redondinha (não remove nada existente) ========== -->
    <div class="perfil-foto-wrap" aria-hidden="false">
      <!-- Substitua o valor de DEFAULT_AVATAR no script abaixo para trocar o avatar padrão -->
      <img id="perfilFoto" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='240' height='240'><rect width='100%' height='100%' fill='%230b2b6b'/><g fill='%23fff'><circle cx='120' cy='84' r='44' /><rect x='40' y='146' width='160' height='56' rx='28'/></g></svg>" alt="Foto de perfil (clique para trocar)" tabindex="0" title="Clique para trocar a foto de perfil">
      <div style="display:flex;flex-direction:column">
        <small style="opacity:.9">Clique na foto para escolher outra</small>
        <button id="btnTrocarFoto" class="btn-prim" style="width:160px;margin-top:8px;border-radius:12px;padding:10px;font-weight:600">Escolher foto</button>
      </div>
    </div>
    <!-- ============================================================== -->

    <button id="btnDados" class="btn btn-prim">Editar dados</button>

    <img id="imgAbaixoBtn" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhmgrLGNZKuoqUEOStgDX6JSYZ1M8_TFcIPY9Y0wF00kg7v3sX0E64yT7r8mLb_X1_PtuF2WZgixvZDDv7UiOInYsTYeumaOCndu-FT4GkqF6xgnsV2T3l8xDk1EvSqc0c8IP0T4x6H_7CDBvcP5ch9kLzshePfe_POzGQMFYhj_MYLwLsf5_jelTZv7Fo/s640/5501051C-5967-4354-AFA9-01C7EC8BB615.png" alt="Imagem abaixo do botão">

    <hr><br>

    <h2> Busque oque procura </h2>
    <p>Diversas opções que você pode explorar. Todas as telas contam com funções de acessibilidade para garantir que todos tenham acesso.</p>

    <div class="funcoes-container">
      <a href="ouvidoria.html" class="funcao"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQLsc7UjlyY37cN5dNx8aTJxX-eMkCd5sF-IA&s" alt=""><span>Ouvidoria</span></a>
      <a href="vereador.html" class="funcao"><img src="https://caminhosevidas.wordpress.com/wp-content/uploads/2011/09/vereador.png" alt=""><span>Vereadores</span></a>
      <a href="e-sic.html" class="funcao"><img src="https://www.gov.br/sri/pt-br/backup-secretaria-de-governo/portalfederativo/arquivos-privados/seminario/noticias/e-sic-federal-e-e-sic-livre-auxilia-municipios-a-cumprirem-demandas-da-lei-de-acesso-a-informacao/lai.png/@@images/7bbaf9b8-b5c1-48f0-b1e7-493ff2c7ab28.png" alt=""><span>E-SIC</span></a>
      <a href="livros.html" class="funcao"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTHoflG8MzlBmucoxIxF_Hssvyg1IrCih2dG7kpOphn-CRoTqDRmAN-cRU&s=10" alt=""><span>Biblioteca Virtual</span></a>
      <a href="videos.html" class="funcao"><img src="https://static.vecteezy.com/system/resources/previews/001/186/943/non_2x/green-play-button-png.png" alt=""><span>Videos e trasmissões</span></a>
      <a href="meu-vereador.html" class="funcao"><img src="https://cdn-icons-png.flaticon.com/512/15200/15200296.png" alt=""><span>Gabinete do seu vereador</span></a>
      <a href="blog.html" class="funcao"><img src="https://cdn-icons-png.flaticon.com/512/9623/9623631.png" alt=""><span>Blog Câmara</span></a>
      <a href="portal.html" class="funcao"><img src="https://images.vexels.com/media/users/3/135821/isolated/preview/fc7d5366408d8db4d2c4f71221f62e13-icone-de-arquivo-de-documento.png" alt=""><span>Portal da trasnparência</span></a>
    </div>

    <br><br>

 




<div style="text-align:left;">
  <h2>Portal atualizado</h2>
  <p>Acompanhe de casa todas as informações e realize consultas atualizadas.</p>
</div>



<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;">
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/legislacao-categoria.php?catl_slug=Leis%20Municipais">Leis</button>
  <button class="open-webview" data-url="https://camaramunicipaljc.com.br/legislacao-categoria.php?catl_slug=Lei%20OrgÃ¢nica%20Municipal">lei orgânica</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/legislacao-categoria.php?catl_slug=Requerimentos">Rquerimentos</button>
  <button class="open-webview" data-url="https://cmjoaocamararn.transparencia.topsolutionsrn.com.br"> Receitas e despesas (2023 - 2025)</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/legislacao-categoria.php?catl_slug=ResoluÃ§Ãµes">Resoluções</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/licitacoes.php">Licitações</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/verba-indenizatoria.php">Verba indenizatória</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/transparencia-categoria.php?catt_slug=tabela-de-ordem">Tabela de ordem</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/transparencia-categoria.php?catt_slug=fornecedores">Fornecedores</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/orcamentos.php">Orçamentos</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/processos-administrativos.php">Processos Administrativos</button>
  <button class="open-webview" data-url="https://www.camaramunicipaljc.com.br/lai-lei-de-acesso-a-informacao.php">Governo digital</button>
  <button class="open-webview" data-url="https://docs.google.com/forms/d/e/1FAIpQLSe_RqkoO7EUTiyS5PMJLBGWpDp0yr3dys4u3ZWeUWb6J2Q4IA/viewform">Pesquisa de satisfação</button>
  
</div>

<div id="overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:9999;flex-direction:column;">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid #ccc;">
    <h2 id="overlayTitle" style="margin:0;font-size:18px;font-weight:500;color:#001f3f;"></h2>
    <button id="closeOverlay" style="background:none;border:none;font-size:26px;cursor:pointer;color:#001f3f;font-weight:600;">✕</button>
  </div>
  <iframe id="webviewFrame" src="" style="flex:1;width:100%;border:none;"></iframe>
</div>

<style>
  .open-webview {
    background:#f9f9f9;
    border:none;
    padding:18px 0;
    cursor:pointer;
    font-size:15px;
    font-weight:500;
    transition:all 0.2s ease;
    text-transform:uppercase;
    width:100%;
    height:100%;
    color:#001f3f;
    letter-spacing:0.5px;
  }
  .open-webview:hover {
    background:#efefef;
    transform:scale(1.02);
  }
  .open-webview:active {
    transform:scale(0.98);
  }
</style>

<script>
  document.querySelectorAll('.open-webview').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.getElementById('overlay').style.display='flex';
      document.getElementById('webviewFrame').src=btn.dataset.url;
      document.getElementById('overlayTitle').innerText=btn.innerText;
    });
  });
  document.getElementById('closeOverlay').addEventListener('click',()=>{
    document.getElementById('overlay').style.display='none';
    document.getElementById('webviewFrame').src='';
    document.getElementById('overlayTitle').innerText='';
  });
</script>

<br><br>



    <div class="rodape">© Câmara Municipal de João Câmara - <span id="ano"></span></div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="tituloModal">
      <div class="mhead">
        <h3 id="tituloModal">Meus dados</h3>
        <button class="mclose" id="fecharModal" aria-label="Fechar">✕</button>
      </div>
      <div style="display:grid;gap:10px;margin-top:10px">
        <div class="grid">
          <div><label>Nome completo</label><input id="m_nome" disabled/></div>
          <div><label>CPF</label><input id="m_cpf" disabled/></div>
          <div><label>Data de nascimento</label><input id="m_nasc" disabled/></div>
          <div><label>Telefone</label><input id="m_tel"/></div>
          <div><label>CEP</label><input id="m_cep" maxlength="9"/></div>
          <div><label>Cidade</label><input id="m_cidade"/></div>
          <div><label>Rua</label><input id="m_rua"/></div>
          <div><label>Número</label><input id="m_numero"/></div>
        </div>
        <button id="btnSalvar" class="btn btn-save"><span>Salvar alterações</span></button>
        <div id="modalMsg" style="font-size:14px;color:#5b6270;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- ========== ADIÇÃO: overlay / modal de escolha de foto ========== -->
  <div class="overlay-foto" id="overlayFoto" aria-hidden="true">
    <div class="modal-foto" role="dialog" aria-modal="true" aria-labelledby="tituloModalFoto">
      <div class="mhead-foto">
        <h3 id="tituloModalFoto">Escolher foto de perfil</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="mclose" id="fecharModalFoto" aria-label="Fechar">✕</button>
        </div>
      </div>

      <div id="msgFotoInfo" style="font-size:14px;color:#555;margin-bottom:10px">Escolha uma das imagens abaixo — a alteração será salva em tempo real.</div>

      <div class="grid-fotos" id="gridFotos" aria-live="polite" aria-busy="false">
        <!-- fotos geradas por JS -->
      </div>

      <div class="foto-actions">
        <button id="btnCancelarFoto" class="btn-ghost">Cancelar</button>
        <button id="btnSalvarFoto" class="btn btn-save" style="border-radius:10px">Salvar seleção</button>
      </div>
    </div>
  </div>
  <!-- ============================================================== -->

  <div vw class="enabled"><div vw-access-button class="active"></div><div vw-plugin-wrapper><div class="vw-plugin-top-wrapper"></div></div></div>
  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
  <script>new window.VLibras.Widget('https://vlibras.gov.br/app');</script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="script.js"></script>
  <script>
    const textoParaFalar="Busque abaixo a função que procura. Caso nescessite editar dados endereço, cliquem editar dados, somente dados de endereço podem ser editados e serão atualizados em tempo real. Ao lado direito da tela, você encontra a função de libras para acessibilidade. Para falar diretamente com a câmara, cliquem em ouvidoria, e será levado até o portal oficial."; 
    const fone=document.getElementById("fonezinho");
    if(fone){fone.addEventListener("click",()=>{if('speechSynthesis'in window){speechSynthesis.cancel();let u=new SpeechSynthesisUtterance(textoParaFalar);u.lang='pt-BR';speechSynthesis.speak(u)}})}

    document.getElementById('ano').textContent=new Date().getFullYear();
    protegerPagina();

    const btnSair=document.getElementById("btnSair");
    btnSair.addEventListener("click",async()=>{await sair();location.href="login.html"});

    onAuthReady(async user=>{
      const perfil=await obterPerfil(user.uid);
      const nome=(perfil?.nomeCompleto||"Cidadão").split(" ")[0];
      document.getElementById("saudacao").textContent=`Olá, ${nome}!`;
    });

    const overlay=document.getElementById("overlay"),
          btnDados=document.getElementById("btnDados"),
          fecharModal=document.getElementById("fecharModal"),
          modalMsg=document.getElementById("modalMsg"),
          btnSalvar=document.getElementById("btnSalvar");

    function preencherModal(d){
      document.getElementById("m_nome").value=d?.nomeCompleto||"";
      document.getElementById("m_cpf").value=d?.cpf||"";
      document.getElementById("m_nasc").value=d?.nascimento||"";
      document.getElementById("m_tel").value=d?.telefone||"";
      document.getElementById("m_cep").value=d?.endereco?.cep||"";
      document.getElementById("m_cidade").value=d?.endereco?.cidade||"";
      document.getElementById("m_rua").value=d?.endereco?.rua||"";
      document.getElementById("m_numero").value=d?.endereco?.numero||"";
    }

    btnDados.addEventListener("click",async()=>{
      overlay.style.display="flex";modalMsg.textContent="";
      const u=firebase.auth().currentUser;
      const perfil=await obterPerfil(u.uid);
      preencherModal(perfil);
    });
    fecharModal.addEventListener("click",()=>{overlay.style.display="none"});

    function setSaving(s){
      btnSalvar.disabled=s;
      btnSalvar.innerHTML=s?'<div class="spinner"></div><span>Salvando…</span>':'<span>Salvar alterações</span>';
    }

    btnSalvar.addEventListener("click",async()=>{
      setSaving(true);modalMsg.textContent="";
      const u=firebase.auth().currentUser;
      const dados={
        telefone:document.getElementById("m_tel").value.trim(),
        endereco:{
          cep:document.getElementById("m_cep").value.trim(),
          cidade:document.getElementById("m_cidade").value.trim(),
          rua:document.getElementById("m_rua").value.trim(),
          numero:document.getElementById("m_numero").value.trim()
        }
      };
      try{
        await atualizarContatoEndereco(u.uid,dados);
        modalMsg.textContent="Alterações salvas com sucesso.";
      }catch(e){modalMsg.textContent=traduzErroAuth(e)}
      finally{setSaving(false)}
    });
  </script>

  <!-- =================== SCRIPT ADICIONADO: gerenciamento de fotos de perfil =================== -->
  <script>
    (function(){
      // ==================== CONFIGURE AQUI as 10 URLs e o avatar padrão ====================
      // Substitua as strings abaixo pelas URLs reais das imagens que você quer disponibilizar.
      // Deixe exatamente 10 itens (pode ser "" para placeholder vazio).
      const PERFIL_PALETTE = [
        "https://img.freepik.com/fotos-gratis/avatar-androgino-de-pessoa-queer-nao-binaria_23-2151100224.jpg?semt=ais_hybrid&w=740",
        "https://img.freepik.com/psd-gratuitas/renderizacao-3d-do-estilo-de-cabelo-para-o-design-do-avatar_23-2151869123.jpg?semt=ais_hybrid&w=740",
        "https://img.freepik.com/fotos-gratis/avatar-androgino-de-pessoa-queer-nao-binaria_23-2151100270.jpg",
        "https://pub-static.fotor.com/assets/projects/pages/d5bdd0513a0740a8a38752dbc32586d0/fotor-03d1a91a0cec4542927f53c87e0599f6.jpg",
        "https://img.freepik.com/psd-gratuitas/ilustracao-3d-de-avatar-ou-perfil-humano_23-2150671116.jpg?w=360",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRFcyq3K9I_N5uVhryn_0KwBb8ObXsbDF7k42cV9VnIq6aa0WfaZRnr-umA&s=10",
        "https://img.freepik.com/vetores-gratis/punho-forte-e-bandeira-lgbt_23-2148510374.jpg",
        "https://img.freepik.com/fotos-gratis/personagem-de-desenho-animado-em-3d_23-2151034029.jpg",
        "https://img.freepik.com/vetores-premium/um-menino-com-uma-camisa-que-diz-e-um-personagem_1230457-37903.jpg?semt=ais_hybrid&w=740&q=80",
        "https://i.pinimg.com/736x/1c/30/c2/1c30c25fc1b09887cbdd92413bceca1b.jpg"
      ];

      // URL do avatar padrão (quando o usuário NÃO TIVER foto)
      // Substitua essa URL pelo avatar padrão que você preferir.
      const DEFAULT_AVATAR = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='240' height='240'><rect width='100%' height='100%' fill='%230b2b6b'/><g fill='%23fff'><circle cx='120' cy='84' r='44' /><rect x='40' y='146' width='160' height='56' rx='28'/></g></svg>";


      const perfilFotoEl = document.getElementById('perfilFoto');
      const btnTrocarFoto = document.getElementById('btnTrocarFoto');
      const overlayFoto = document.getElementById('overlayFoto');
      const fecharModalFoto = document.getElementById('fecharModalFoto');
      const gridFotos = document.getElementById('gridFotos');
      const btnSalvarFoto = document.getElementById('btnSalvarFoto');
      const btnCancelarFoto = document.getElementById('btnCancelarFoto');
      const msgFotoInfo = document.getElementById('msgFotoInfo');

      let selectedUrl = null;
      let currentUid = null;
      let salvando = false;
      let thumbs = [];

      // Monta a grade com as thumbnails (executa uma vez)
      function renderPalette(){
        gridFotos.innerHTML = '';
        thumbs = [];

        // opção "sem foto" (avatar padrão)
        const btnDefault = document.createElement('img');
        btnDefault.className = 'thumb default';
        btnDefault.alt = 'Sem foto (padrão)';
        btnDefault.src = DEFAULT_AVATAR;
        btnDefault.title = 'Usar avatar padrão (sem foto)';
        btnDefault.addEventListener('click', ()=> {
          highlightThumb(btnDefault);
          selectUrlAndMaybeSave(DEFAULT_AVATAR);
        });
        gridFotos.appendChild(btnDefault);
        thumbs.push(btnDefault);

        // as 10 imagens
        PERFIL_PALETTE.forEach((u, idx) => {
          const img = document.createElement('img');
          img.className = 'thumb';
          img.alt = 'Foto ' + (idx+1);
          img.title = 'Foto ' + (idx+1);
          img.src = u || DEFAULT_AVATAR;
          img.dataset.url = u || DEFAULT_AVATAR;
          img.addEventListener('click', ()=>{
            highlightThumb(img);
            selectUrlAndMaybeSave(img.dataset.url);
          });
          gridFotos.appendChild(img);
          thumbs.push(img);
        });
      }

      function highlightThumb(el){
        thumbs.forEach(t=>t.classList.remove('sel'));
        el.classList.add('sel');
      }

      // Ao selecionar: atualiza a variável e (opcional) salva automaticamente
      function selectUrlAndMaybeSave(url){
        selectedUrl = url || DEFAULT_AVATAR;
        // Save automatically in real-time when user clicks a thumb:
        // se preferir só salvar com o botão, comente a próxima linha.
        salvarFotoPerfilRealTime(currentUid, selectedUrl);
      }

      // Abre modal
      function openModalFoto(){
        overlayFoto.style.display = 'flex';
        overlayFoto.setAttribute('aria-hidden','false');
        gridFotos.focus?.();
      }

      // Fecha modal
      function closeModalFoto(){
        overlayFoto.style.display = 'none';
        overlayFoto.setAttribute('aria-hidden','true');
        // limpa seleção temporária
        selectedUrl = null;
        thumbs.forEach(t=>t.classList.remove('sel'));
      }

      // Salva foto no Auth (photoURL) e no Realtime Database em caminhos comuns.
      async function salvarFotoPerfilRealTime(uid, url){
        if(!uid) {
          alert('Usuário não identificado. Faça login novamente.');
          return;
        }
        if(salvando) return;
        salvando = true;
        msgFotoInfo.textContent = 'Salvando...';
        try {
          // 1) tenta atualizar o profile do Firebase Auth (photoURL)
          const user = firebase.auth().currentUser;
          if(user && user.uid === uid) {
            try{ await user.updateProfile({ photoURL: url }); } catch(e) { console.warn('Não foi possível atualizar auth.photoURL:', e); }
          }
          // 2) escreve em múltiplos caminhos do Realtime Database (para cobrir diferentes estruturas)
          const updates = {};
          updates[`/users/${uid}/fotoURL`] = url;
          updates[`/usuarios/${uid}/fotoURL`] = url;
          updates[`/perfis/${uid}/fotoURL`] = url;
          updates[`/users/${uid}/perfilFoto`] = url;
          // Se você tiver um caminho específico, inclua aqui, por exemplo:
          // updates[`/meus_perfis/${uid}/foto`] = url;
          await firebase.database().ref().update(updates);

          // 3) atualiza imediatamente a imagem da UI
          perfilFotoEl.src = url || DEFAULT_AVATAR;
          msgFotoInfo.textContent = 'Foto salva em tempo real.';
        } catch(err){
          console.error('Erro ao salvar foto de perfil', err);
          msgFotoInfo.textContent = 'Erro ao salvar. Tente novamente.';
        } finally {
          salvando = false;
          // limpa mensagem depois de 1.5s
          setTimeout(()=>{ if(!salvando) msgFotoInfo.textContent = 'Escolha uma das imagens abaixo — a alteração será salva em tempo real.'; }, 1500);
        }
      }

      // Quando usuário clica "Salvar seleção" — garante salvar a seleção atual
      btnSalvarFoto.addEventListener('click', async ()=>{
        if(!selectedUrl){
          alert('Selecione uma imagem antes de salvar.');
          return;
        }
        await salvarFotoPerfilRealTime(currentUid, selectedUrl);
        closeModalFoto();
      });
      btnCancelarFoto.addEventListener('click', ()=> closeModalFoto());
      fecharModalFoto.addEventListener('click', ()=> closeModalFoto());

      // Abre modal ao clicar na imagem ou no botão
      perfilFotoEl.addEventListener('click', ()=> { renderPalette(); openModalFoto(); });
      perfilFotoEl.addEventListener('keypress', (e)=> { if(e.key === 'Enter' || e.key === ' ') { renderPalette(); openModalFoto(); }});
      btnTrocarFoto.addEventListener('click', ()=> { renderPalette(); openModalFoto(); });

      // Fechar com ESC
      document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeModalFoto(); });

      // ========== sincronização em tempo real: quando o usuário fizer login, escutar os possíveis caminhos de foto ==========
      onAuthReady(async (user) => {
        if(!user) return;
        currentUid = user.uid;

        // 1) primeiro, tenta obter foto pelo Auth (se existir)
        try {
          const authPhoto = firebase.auth().currentUser?.photoURL;
          if(authPhoto) {
            perfilFotoEl.src = authPhoto;
          }
        } catch(e){ /* ignora */ }

        // 2) tenta obter perfil via sua função obterPerfil (se existir)
        try {
          const perfil = await obterPerfil(currentUid);
          if(perfil){
            // tenta vários campos comuns
            const possible = perfil?.fotoURL || perfil?.photoURL || perfil?.foto || perfil?.avatar;
            if(possible) perfilFotoEl.src = possible;
          }
        } catch(e){ /* ignora se a função não existir ou falhar */ }

        // 3) adiciona listeners em caminhos comuns do Realtime Database para atualizar em tempo real
        const caminhos = [
          `/users/${currentUid}/fotoURL`,
          `/usuarios/${currentUid}/fotoURL`,
          `/perfis/${currentUid}/fotoURL`,
          `/users/${currentUid}/perfilFoto`,
          `/usuarios/${currentUid}/perfilFoto`
        ];
        caminhos.forEach(path => {
          try {
            firebase.database().ref(path).on('value', snap => {
              const v = snap.val();
              if(v) perfilFotoEl.src = v;
            });
          } catch(e){ console.warn('Erro ao escutar caminho', path, e); }
        });

        // fallback: se nada, usa avatar padrão
        if(!perfilFotoEl.src || perfilFotoEl.src.trim()==='') perfilFotoEl.src = DEFAULT_AVATAR;
      });
    })();
  </script>

</body>
</html>